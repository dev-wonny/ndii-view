<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹¬ì‚¬ ì‹¤ì  ìƒì„¸ Â· ë‹¤ìš´ë¡œë“œ ì „ìš©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="judgmentDatabase.js"></script>
  <style>
    :root{--primary:#005aa0;--bg:#f6f7f9;--card:#fff;--bd:#dcdfe4;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,'Noto Sans KR',sans-serif;}
    header{background:var(--primary);color:#fff;padding:14px 18px;font-weight:700;display:flex;align-items:center;gap:10px}
    header a{color:#fff;opacity:.9;text-decoration:none;border:1px solid rgba(255,255,255,.5);padding:4px 8px;border-radius:6px}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:16px;margin-bottom:18px}
    h2{margin:0 0 12px;color:#222}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
    th,td{border:1px solid var(--bd);padding:10px;text-align:center}
    th{background:#f1f3f5}
    .summary{display:flex;gap:16px;flex-wrap:wrap;font-weight:700}
    .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;border:1px solid var(--bd);background:#fff}
    .muted{color:#6b7280}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:2px}
    button{padding:9px 14px;border:1px solid var(--primary);background:#fff;color:var(--primary);border-radius:8px;cursor:pointer}
    .details-cell{text-align:left;max-width:300px;vertical-align:top}
    .details-content{max-height:100px;overflow-y:auto;padding:4px;border:1px solid #e5e7eb;border-radius:4px;background:#f9fafb}
    .detail-item{margin:2px 0;font-size:12px;line-height:1.4}
    .detail-reviewer{font-weight:600;color:#1f2937}
    .detail-dates{color:#6b7280;font-size:11px}
    .clickable{cursor:pointer;transition:background-color 0.2s}
    .clickable:hover{background:#f8fbff}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5)}
    .modal-content{background-color:#fff;margin:5% auto;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e5e7eb}
    .modal-title{font-size:18px;font-weight:600;color:#1f2937}
    .close{color:#aaa;font-size:28px;font-weight:bold;cursor:pointer;line-height:1}
    .close:hover{color:#000}
    .modal-body{line-height:1.6}
    .info-row{display:flex;margin-bottom:8px}
    .info-label{font-weight:600;color:#374151;min-width:120px}
    .info-value{color:#1f2937;flex:1}
    .status-badge{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500}
    .status-completed{background:#d1fae5;color:#065f46}
    .status-progress{background:#dbeafe;color:#1e40af}
    .status-waiting{background:#fef3c7;color:#92400e}
    .status-delayed{background:#fee2e2;color:#991b1b}
    .opinion-section{margin-top:20px;padding:16px;background:#f8fafc;border-radius:8px;border-left:4px solid #3b82f6}
    .opinion-title{font-weight:600;color:#1f2937;margin-bottom:8px;font-size:14px}
    .opinion-content{color:#374151;line-height:1.6;white-space:pre-wrap}
    .documents-section{margin-top:16px;padding:16px;background:#f0f9ff;border-radius:8px;border-left:4px solid #0ea5e9}
    .documents-title{font-weight:600;color:#1e293b;margin-bottom:8px;font-size:14px}
    .document-list{list-style:none;padding:0;margin:0}
    .document-item{padding:8px 12px;margin:4px 0;background:#fff;border:1px solid #e2e8f0;border-radius:6px;display:flex;align-items:center;gap:8px}
    .document-icon{color:#0ea5e9;font-size:16px}
    .document-name{color:#1e293b;font-size:13px;flex:1}
    .document-download{color:#0ea5e9;font-size:12px;text-decoration:none;padding:4px 8px;border:1px solid #0ea5e9;border-radius:4px;transition:all 0.2s}
    .document-download:hover{background:#0ea5e9;color:#fff}
    .no-data{color:#6b7280;font-style:italic;text-align:center;padding:20px}
  </style>
</head>
<body>
<header>
  <a href="index.html">â† ëª©ë¡</a>
  ì˜ì•½í’ˆí†µí•©ì •ë³´ì‹œìŠ¤í…œ Â· ì‹¬ì‚¬ ì‹¤ì  ìƒì„¸
</header>

<div class="wrap">
  <!-- ë¯¼ì› ê¸°ë³¸ -->
  <div class="card">
    <h2>ë¯¼ì› ì ‘ìˆ˜ ê¸°ë³¸ ì •ë³´</h2>
    <table id="base"><tbody></tbody></table>
  </div>

  <!-- ë‹¤ìš´ë¡œë“œ ì „ìš© -->
  <div class="card">
    <h2>ë‹¤ìš´ë¡œë“œ</h2>
    <div class="toolbar">
      <button id="btnExcelCsv">ì—‘ì…€(CSV, UTF-8-BOM)</button>
      <button id="btnExcelXls">ì—‘ì…€(XLS, XML 2003)</button>
    </div>
    <div class="muted">â€» í˜„ì¬ í™”ë©´ì— í‘œì‹œëœ ëª¨ë“  ì‹¬ì‚¬ ì‹¤ì  ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</div>
  </div>

  <!-- ì§‘ê³„: ì‹¬ì‚¬ë¶„ì•¼ë³„ -->
  <div class="card">
    <h2>ì‹¬ì‚¬ë¶„ì•¼ - ë‹´ë‹¹ë¶€ì„œë³„ ì§‘ê³„</h2>
    <table>
      <thead>
        <tr>
          <th>ì‹¬ì‚¬ë¶„ì•¼</th>
          <th>ë‹´ë‹¹ë¶€ì„œ</th>
          <th>ì°¸ì—¬ ì‹¬ì‚¬ì¸ì› ìˆ˜</th>
          <th>ì´ ì†Œìš”ì‹œê°„(ì¼)</th>
          <th>ìƒì„¸ ì •ë³´</th>
        </tr>
      </thead>
      <tbody id="aggDept"></tbody>
    </table>
  </div>

  <!-- ì‹¬ì‚¬ ì‹¤ì  -->
  <div class="card">
    <h2>í˜‘ì˜ ë³„ ì‹¬ì‚¬ ì´ë ¥</h2>
    <table>
      <thead>
        <tr>
          <th>ì‹¬ì‚¬ë¶„ì•¼</th>
          <th>ë‹´ë‹¹ë¶€ì„œ</th>
          <th>í˜‘ì˜ ì˜ë¢°ì¼</th>
          <th>ì‹¬ì‚¬ì ì´ë¦„</th>
          <th>ì‹¬ì‚¬ ì‹œì‘ì¼</th>
          <th>ì‹¬ì‚¬ ì¢…ë£Œì¼</th>
          <th>ì‹¬ì‚¬ ì†Œìš”ì¼</th>
          <th>ì§„í–‰ ìƒíƒœ</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

      <!-- ìš”ì•½ -->
      <div class="card">
        <h2>ìš”ì•½(í˜„í™©)</h2>
        <div class="summary">
          <div>ì´ ì‹¬ì‚¬ì ìˆ˜: <span id="total"></span></div>
          <div>ë¶€ì„œ ë¶„í¬: <span id="deptSpread" class="pill"></span></div>
          <div>í—ˆê°€ ì™„ë£Œì¼: <span id="lastReply"></span></div>
        </div>
        <div class="muted" style="margin-top:8px">â€» ì†Œìš”ê¸°ê°„ = í—ˆê°€ì™„ë£Œì¼ âˆ’ ë¯¼ì›ì ‘ìˆ˜ì¼ (ì¢…ë£Œì¼ ë¯¸ê¸°ì… ì‹œ ì§„í–‰ì¤‘)</div>
      </div>
</div>

<!-- ì‹¬ì‚¬ ìƒì„¸ ëª¨ë‹¬ -->
<div id="reviewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">ì‹¬ì‚¬ ìƒì„¸ ì •ë³´</h3>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- ëª¨ë‹¬ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
    </div>
  </div>
</div>

<script>
/* === ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° === */
const CASES = JUDGMENT_CASES;

/* === Util === */
const params = new URLSearchParams(location.search);
const id = params.get("id");
const data = JudgmentUtils.findCaseById(id) || CASES[0];

/* === ê¸°ë³¸ ì •ë³´ === */
const $base = document.querySelector("#base tbody");
const totalPeriod = JudgmentUtils.calculateTotalPeriod(data.receivedAt, data.approvedAt);
$base.innerHTML = `
<tr><th>ë¯¼ì›ì ‘ìˆ˜ë²ˆí˜¸</th><td>${data.id}</td><th>í’ˆëª©ê¸°ì¤€ì½”ë“œ</th><td>${data.productCode || "-"}</td></tr>
<tr><th>í’ˆëª©ëª…</th><td>${data.productName}</td><th>ì—…ì²´ëª…</th><td>${data.company}</td></tr>
<tr><th>ì œì¡°/ìˆ˜ì…</th><td>${data.kind}</td><th>ë¯¼ì›ì ‘ìˆ˜ì¼</th><td>${data.receivedAt}</td></tr>
<tr><th>í—ˆê°€ì™„ë£Œì¼</th><td>${data.approvedAt || "-"}</td><th>ì´ ê¸°ê°„(ì¼)</th><td>${totalPeriod}</td></tr>
<tr><th>ì§„í–‰ìƒíƒœ</th><td colspan="3">${data.status}</td></tr>
`;

/* === ë Œë” (ì „ì²´ í‘œì‹œ) === */
const $rows = document.getElementById("rows");
const $total = document.getElementById("total");
const $deptSpread = document.getElementById("deptSpread");
const $lastReply = document.getElementById("lastReply");
const $aggDept = document.getElementById("aggDept");

function render(){
  const rows = data.reviews;

  // í˜‘ì˜ ì˜ë¢°ì¼ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
  const sortedRows = rows.sort((a, b) => {
    const dateA = a.request ? new Date(a.request) : new Date(0);
    const dateB = b.request ? new Date(b.request) : new Date(0);
    return dateA - dateB;
  });

  // í…Œì´ë¸”
  $rows.innerHTML = "";
  sortedRows.forEach((r, index) => {
    const dur = JudgmentUtils.days(r.start, r.end);
    $rows.innerHTML += `
      <tr class="clickable" data-index="${index}">
        <td>${r.dept}</td>
        <td>${r.dept}</td>
        <td>${r.request || "-"}</td>
        <td>${r.reviewer || "-"}</td>
        <td>${r.start || "-"}</td>
        <td>${r.end || "-"}</td>
        <td>${dur === "" ? "-" : dur}</td>
        <td>${r.status}</td>
      </tr>
    `;
  });

  // í–‰ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
  document.querySelectorAll("#rows tr.clickable").forEach(tr => {
    tr.addEventListener('click', () => {
      const index = parseInt(tr.dataset.index);
      showReviewModal(sortedRows[index]);
    });
  });

  // ìš”ì•½
  $total.textContent = rows.length;
  $deptSpread.textContent = [...new Set(rows.map(r=>r.dept))].join(" Â· ") || "-";
  // ë¯¼ì›ì˜ ì‹¤ì œ í—ˆê°€ì™„ë£Œì¼ ì‚¬ìš© (ê¸°ë³¸ ì •ë³´ì™€ ì¼ì¹˜)
  $lastReply.textContent = data.approvedAt || "-";

  // ì§‘ê³„ Â· ì‹¬ì‚¬ë¶„ì•¼ë³„
  const byDept = {};
  rows.forEach(r=>{
    const dept = r.dept;
    if (!byDept[dept]) {
      byDept[dept] = {
        reviewers: new Set(),
        totalDuration: 0,
        details: []
      };
    }
    
    // ì‹¬ì‚¬ì¸ì› ì¶”ê°€
    byDept[dept].reviewers.add(r.reviewer);
    
    // ì†Œìš”ì‹œê°„ ê³„ì‚° ë° ì¶”ê°€
    const duration = JudgmentUtils.days(r.start, r.end);
    if (duration !== "" && !isNaN(duration)) {
      byDept[dept].totalDuration += duration;
      byDept[dept].details.push({
        reviewer: r.reviewer,
        duration: duration,
        start: r.start,
        end: r.end
      });
    }
  });

  $aggDept.innerHTML = Object.keys(byDept).sort().map(dept => {
    const data = byDept[dept];
    const reviewerCount = data.reviewers.size;
    const totalDuration = data.totalDuration;
    
    // ìƒì„¸ ì •ë³´ ìƒì„± (ê° ì‹¬ì‚¬ì¸ì›ë³„ ì†Œìš”ì‹œê°„)
    const detailsHtml = data.details.map(detail => 
      `<div class="detail-item">
        <span class="detail-reviewer">${detail.reviewer}</span>: ${detail.duration}ì¼ 
        <span class="detail-dates">(${detail.start} ~ ${detail.end})</span>
      </div>`
    ).join('');
    
    return `<tr>
      <td>${dept}</td>
      <td>${dept}</td>
      <td>${reviewerCount}</td>
      <td>${totalDuration}</td>
      <td class="details-cell">
        <div class="details-content">
          ${detailsHtml || '<span style="color: #999;">ë°ì´í„° ì—†ìŒ</span>'}
        </div>
      </td>
    </tr>`;
  }).join("") || `<tr><td colspan="5">ë°ì´í„° ì—†ìŒ</td></tr>`;
}
render();

/* === ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ === */
function showReviewModal(reviewData) {
  const modal = document.getElementById('reviewModal');
  const modalBody = document.getElementById('modalBody');
  
  // ìƒíƒœì— ë”°ë¥¸ ë°°ì§€ í´ë˜ìŠ¤ ê²°ì •
  const getStatusClass = (status) => {
    if (status === 'ì™„ë£Œ') return 'status-completed';
    if (status === 'ì§„í–‰') return 'status-progress';
    if (status === 'ëŒ€ê¸°') return 'status-waiting';
    if (status === 'ì§€ì—°') return 'status-delayed';
    return 'status-waiting';
  };

  // ì†Œìš”ì¼ ê³„ì‚°
  const duration = JudgmentUtils.days(reviewData.start, reviewData.end);
  
  // ëª¨ë‹¬ ë‚´ìš© ìƒì„±
  modalBody.innerHTML = `
    <div class="info-row">
      <div class="info-label">ì‹¬ì‚¬ë¶„ì•¼:</div>
      <div class="info-value">${reviewData.dept}</div>
    </div>
    <div class="info-row">
      <div class="info-label">ë‹´ë‹¹ë¶€ì„œ:</div>
      <div class="info-value">${reviewData.dept}</div>
    </div>
    <div class="info-row">
      <div class="info-label">ì‹¬ì‚¬ì:</div>
      <div class="info-value">${reviewData.reviewer || "-"}</div>
    </div>
    <div class="info-row">
      <div class="info-label">í˜‘ì˜ ì˜ë¢°ì¼:</div>
      <div class="info-value">${reviewData.request || "-"}</div>
    </div>
    <div class="info-row">
      <div class="info-label">ì‹¬ì‚¬ ì‹œì‘ì¼:</div>
      <div class="info-value">${reviewData.start || "-"}</div>
    </div>
    <div class="info-row">
      <div class="info-label">ì‹¬ì‚¬ ì¢…ë£Œì¼:</div>
      <div class="info-value">${reviewData.end || "-"}</div>
    </div>
    <div class="info-row">
      <div class="info-label">ì‹¬ì‚¬ ì†Œìš”ì¼:</div>
      <div class="info-value">${duration === "" ? "-" : duration + "ì¼"}</div>
    </div>
    <div class="info-row">
      <div class="info-label">ì§„í–‰ ìƒíƒœ:</div>
      <div class="info-value">
        <span class="status-badge ${getStatusClass(reviewData.status)}">${reviewData.status}</span>
      </div>
    </div>
    <div class="info-row">
      <div class="info-label">ë¯¼ì› ì ‘ìˆ˜ë²ˆí˜¸:</div>
      <div class="info-value">${data.id}</div>
    </div>
    <div class="info-row">
      <div class="info-label">í’ˆëª©ëª…:</div>
      <div class="info-value">${data.productName}</div>
    </div>
    <div class="info-row">
      <div class="info-label">ì—…ì²´ëª…:</div>
      <div class="info-value">${data.company}</div>
    </div>
    
    <!-- ì‹¬ì‚¬ ì˜ê²¬ ì„¹ì…˜ -->
    <div class="opinion-section">
      <div class="opinion-title">ğŸ“ ì‹¬ì‚¬ ì˜ê²¬</div>
      <div class="opinion-content">${reviewData.opinion || "ì‹¬ì‚¬ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤."}</div>
    </div>
    
    <!-- ì‹¬ì‚¬ ìë£Œ ì„¹ì…˜ -->
    <div class="documents-section">
      <div class="documents-title">ğŸ“ ì‹¬ì‚¬ ìë£Œ</div>
      ${reviewData.documents && reviewData.documents.length > 0 ? `
        <ul class="document-list">
          ${reviewData.documents.map(doc => `
            <li class="document-item">
              <span class="document-icon">ğŸ“„</span>
              <span class="document-name">${doc}</span>
              <a href="#" class="document-download" onclick="downloadDocument('${doc}')">ë‹¤ìš´ë¡œë“œ</a>
            </li>
          `).join('')}
        </ul>
      ` : `
        <div class="no-data">ì œì¶œëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      `}
    </div>
  `;
  
  modal.style.display = 'block';
}

function closeModal() {
  const modal = document.getElementById('reviewModal');
  modal.style.display = 'none';
}

// ìë£Œ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (ì‹œë®¬ë ˆì´ì…˜)
function downloadDocument(filename) {
  // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì„œë²„ì—ì„œ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì§€ë§Œ, 
  // ë°ëª¨ìš©ìœ¼ë¡œëŠ” ì•Œë¦¼ë§Œ í‘œì‹œí•©ë‹ˆë‹¤.
  alert(`íŒŒì¼ ë‹¤ìš´ë¡œë“œ: ${filename}\n\nì‹¤ì œ í™˜ê²½ì—ì„œëŠ” í•´ë‹¹ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.`);
  
  // ì‹¤ì œ êµ¬í˜„ ì˜ˆì‹œ:
  // const link = document.createElement('a');
  // link.href = `/api/documents/${filename}`;
  // link.download = filename;
  // link.click();
}

// ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('reviewModal');
  const closeBtn = document.querySelector('.close');
  
  // X ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ëª¨ë‹¬ ë‹«ê¸°
  closeBtn.addEventListener('click', closeModal);
  
  // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ëª¨ë‹¬ ë‹«ê¸°
  modal.addEventListener('click', function(event) {
    if (event.target === modal) {
      closeModal();
    }
  });
  
  // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeModal();
    }
  });
});

/* === ì—‘ì…€ ë‚´ë³´ë‚´ê¸° (í˜„ì¬ í™”ë©´ ë°ì´í„° ê·¸ëŒ€ë¡œ) === */
function exportRows(){
  // í˜‘ì˜ ì˜ë¢°ì¼ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
  const sortedRows = data.reviews.sort((a, b) => {
    const dateA = a.request ? new Date(a.request) : new Date(0);
    const dateB = b.request ? new Date(b.request) : new Date(0);
    return dateA - dateB;
  });
  
  return sortedRows.map(r=>{
    const dur = JudgmentUtils.days(r.start, r.end);
    return [r.dept, r.dept, r.request||"", r.reviewer||"", r.start||"", r.end||"", (dur===""?"":dur), r.status||""];
  });
}

// 1) CSV (UTF-8 with BOM)
document.getElementById("btnExcelCsv").onclick = ()=>{
  const header = ["ì‹¬ì‚¬ë¶„ì•¼","ë‹´ë‹¹ë¶€ì„œ","í˜‘ì˜ ì˜ë¢°ì¼","ì‹¬ì‚¬ì ì´ë¦„","ì‹¬ì‚¬ ì‹œì‘ì¼","ì‹¬ì‚¬ ì¢…ë£Œì¼","ì‹¬ì‚¬ ì†Œìš”ì¼","ì§„í–‰ ìƒíƒœ"];
  const rows = exportRows();
  const csv = [header, ...rows].map(arr =>
    arr.map(v=>{
      const s = (v??"").toString().replace(/"/g,'""');
      return /[",\n]/.test(s)? `"${s}"` : s;
    }).join(",")
  ).join("\n");
  const BOM = "\uFEFF";
  const blob = new Blob([BOM + csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `ì‹¬ì‚¬ì‹¤ì _${data.id}_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
};

// 2) XLS (Excel 2003 XML)
document.getElementById("btnExcelXls").onclick = ()=>{
  const header = ["ì‹¬ì‚¬ë¶„ì•¼","ë‹´ë‹¹ë¶€ì„œ","í˜‘ì˜ ì˜ë¢°ì¼","ì‹¬ì‚¬ì ì´ë¦„","ì‹¬ì‚¬ ì‹œì‘ì¼","ì‹¬ì‚¬ ì¢…ë£Œì¼","ì‹¬ì‚¬ ì†Œìš”ì¼","ì§„í–‰ ìƒíƒœ"];
  const rows = exportRows();
  const esc = (s)=>String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const xmlRows = [
    `<Row>${header.map(h=>`<Cell><Data ss:Type="String">${esc(h)}</Data></Cell>`).join("")}</Row>`,
    ...rows.map(r=>`<Row>${
      r.map(v=>{
        const isNum = /^-?\d+(\.\d+)?$/.test(v);
        const type = isNum ? "Number" : "String";
        return `<Cell><Data ss:Type="${type}">${esc(v)}</Data></Cell>`;
      }).join("")
    }</Row>`)
  ].join("");
  const xml =
`<?xml version="1.0" encoding="UTF-8"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:x="urn:schemas-microsoft-com:office:excel"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
 <Worksheet ss:Name="ì‹¬ì‚¬ì‹¤ì ">
  <Table>
   ${xmlRows}
  </Table>
 </Worksheet>
</Workbook>`;
  const blob = new Blob([xml], {type: "application/vnd.ms-excel;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `ì‹¬ì‚¬ì‹¤ì _${data.id}_${new Date().toISOString().slice(0,10)}.xls`;
  document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
};
</script>
</body>
</html>
