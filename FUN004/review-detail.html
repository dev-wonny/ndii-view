<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>심사 실적 상세 · 다운로드 전용</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="judgmentDatabase.js"></script>
  <style>
    :root{--primary:#005aa0;--bg:#f6f7f9;--card:#fff;--bd:#dcdfe4;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,'Noto Sans KR',sans-serif;}
    header{background:var(--primary);color:#fff;padding:14px 18px;font-weight:700;display:flex;align-items:center;gap:10px}
    header a{color:#fff;opacity:.9;text-decoration:none;border:1px solid rgba(255,255,255,.5);padding:4px 8px;border-radius:6px}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:16px;margin-bottom:18px}
    h2{margin:0 0 12px;color:#222}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
    th,td{border:1px solid var(--bd);padding:10px;text-align:center}
    th{background:#f1f3f5}
    .summary{display:flex;gap:16px;flex-wrap:wrap;font-weight:700}
    .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;border:1px solid var(--bd);background:#fff}
    .muted{color:#6b7280}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:2px}
    button{padding:9px 14px;border:1px solid var(--primary);background:#fff;color:var(--primary);border-radius:8px;cursor:pointer}
    .details-cell{text-align:left;max-width:300px;vertical-align:top}
    .details-content{max-height:100px;overflow-y:auto;padding:4px;border:1px solid #e5e7eb;border-radius:4px;background:#f9fafb}
    .detail-item{margin:2px 0;font-size:12px;line-height:1.4}
    .detail-reviewer{font-weight:600;color:#1f2937}
    .detail-dates{color:#6b7280;font-size:11px}
    .clickable{cursor:pointer;transition:background-color 0.2s}
    .clickable:hover{background:#f8fbff}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5)}
    .modal-content{background-color:#fff;margin:5% auto;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e5e7eb}
    .modal-title{font-size:18px;font-weight:600;color:#1f2937}
    .close{color:#aaa;font-size:28px;font-weight:bold;cursor:pointer;line-height:1}
    .close:hover{color:#000}
    .modal-body{line-height:1.6}
    .info-row{display:flex;margin-bottom:8px}
    .info-label{font-weight:600;color:#374151;min-width:120px}
    .info-value{color:#1f2937;flex:1}
    .status-badge{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500}
    .status-completed{background:#d1fae5;color:#065f46}
    .status-progress{background:#dbeafe;color:#1e40af}
    .status-waiting{background:#fef3c7;color:#92400e}
    .status-delayed{background:#fee2e2;color:#991b1b}
    .opinion-section{margin-top:20px;padding:16px;background:#f8fafc;border-radius:8px;border-left:4px solid #3b82f6}
    .opinion-title{font-weight:600;color:#1f2937;margin-bottom:8px;font-size:14px}
    .opinion-content{color:#374151;line-height:1.6;white-space:pre-wrap}
    .documents-section{margin-top:16px;padding:16px;background:#f0f9ff;border-radius:8px;border-left:4px solid #0ea5e9}
    .documents-title{font-weight:600;color:#1e293b;margin-bottom:8px;font-size:14px}
    .document-list{list-style:none;padding:0;margin:0}
    .document-item{padding:8px 12px;margin:4px 0;background:#fff;border:1px solid #e2e8f0;border-radius:6px;display:flex;align-items:center;gap:8px}
    .document-icon{color:#0ea5e9;font-size:16px}
    .document-name{color:#1e293b;font-size:13px;flex:1}
    .document-download{color:#0ea5e9;font-size:12px;text-decoration:none;padding:4px 8px;border:1px solid #0ea5e9;border-radius:4px;transition:all 0.2s}
    .document-download:hover{background:#0ea5e9;color:#fff}
    .no-data{color:#6b7280;font-style:italic;text-align:center;padding:20px}
  </style>
</head>
<body>
<header>
  <a href="index.html">← 목록</a>
  의약품통합정보시스템 · 심사 실적 상세
</header>

<div class="wrap">
  <!-- 민원 기본 -->
  <div class="card">
    <h2>민원 접수 기본 정보</h2>
    <table id="base"><tbody></tbody></table>
  </div>

  <!-- 다운로드 전용 -->
  <div class="card">
    <h2>다운로드</h2>
    <div class="toolbar">
      <button id="btnExcelCsv">엑셀(CSV, UTF-8-BOM)</button>
      <button id="btnExcelXls">엑셀(XLS, XML 2003)</button>
    </div>
    <div class="muted">※ 현재 화면에 표시된 모든 심사 실적 데이터를 그대로 다운로드합니다.</div>
  </div>

  <!-- 집계: 심사분야별 -->
  <div class="card">
    <h2>심사분야 - 담당부서별 집계</h2>
    <table>
      <thead>
        <tr>
          <th>심사분야</th>
          <th>담당부서</th>
          <th>참여 심사인원 수</th>
          <th>총 소요시간(일)</th>
          <th>상세 정보</th>
        </tr>
      </thead>
      <tbody id="aggDept"></tbody>
    </table>
  </div>

  <!-- 심사 실적 -->
  <div class="card">
    <h2>협의 별 심사 이력</h2>
    <table>
      <thead>
        <tr>
          <th>심사분야</th>
          <th>담당부서</th>
          <th>협의 의뢰일</th>
          <th>심사자 이름</th>
          <th>심사 시작일</th>
          <th>심사 종료일</th>
          <th>심사 소요일</th>
          <th>진행 상태</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

      <!-- 요약 -->
      <div class="card">
        <h2>요약(현황)</h2>
        <div class="summary">
          <div>총 심사자 수: <span id="total"></span></div>
          <div>부서 분포: <span id="deptSpread" class="pill"></span></div>
          <div>허가 완료일: <span id="lastReply"></span></div>
        </div>
        <div class="muted" style="margin-top:8px">※ 소요기간 = 허가완료일 − 민원접수일 (종료일 미기입 시 진행중)</div>
      </div>
</div>

<!-- 심사 상세 모달 -->
<div id="reviewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">심사 상세 정보</h3>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- 모달 내용이 여기에 동적으로 삽입됩니다 -->
    </div>
  </div>
</div>

<script>
/* === 데이터베이스에서 데이터 가져오기 === */
const CASES = JUDGMENT_CASES;

/* === Util === */
const params = new URLSearchParams(location.search);
const id = params.get("id");
const data = JudgmentUtils.findCaseById(id) || CASES[0];

/* === 기본 정보 === */
const $base = document.querySelector("#base tbody");
const totalPeriod = JudgmentUtils.calculateTotalPeriod(data.receivedAt, data.approvedAt);
$base.innerHTML = `
<tr><th>민원접수번호</th><td>${data.id}</td><th>품목기준코드</th><td>${data.productCode || "-"}</td></tr>
<tr><th>품목명</th><td>${data.productName}</td><th>업체명</th><td>${data.company}</td></tr>
<tr><th>제조/수입</th><td>${data.kind}</td><th>민원접수일</th><td>${data.receivedAt}</td></tr>
<tr><th>허가완료일</th><td>${data.approvedAt || "-"}</td><th>총 기간(일)</th><td>${totalPeriod}</td></tr>
<tr><th>진행상태</th><td colspan="3">${data.status}</td></tr>
`;

/* === 렌더 (전체 표시) === */
const $rows = document.getElementById("rows");
const $total = document.getElementById("total");
const $deptSpread = document.getElementById("deptSpread");
const $lastReply = document.getElementById("lastReply");
const $aggDept = document.getElementById("aggDept");

function render(){
  const rows = data.reviews;

  // 협의 의뢰일 기준으로 오름차순 정렬
  const sortedRows = rows.sort((a, b) => {
    const dateA = a.request ? new Date(a.request) : new Date(0);
    const dateB = b.request ? new Date(b.request) : new Date(0);
    return dateA - dateB;
  });

  // 테이블
  $rows.innerHTML = "";
  sortedRows.forEach((r, index) => {
    const dur = JudgmentUtils.days(r.start, r.end);
    $rows.innerHTML += `
      <tr class="clickable" data-index="${index}">
        <td>${r.dept}</td>
        <td>${r.dept}</td>
        <td>${r.request || "-"}</td>
        <td>${r.reviewer || "-"}</td>
        <td>${r.start || "-"}</td>
        <td>${r.end || "-"}</td>
        <td>${dur === "" ? "-" : dur}</td>
        <td>${r.status}</td>
      </tr>
    `;
  });

  // 행 클릭 이벤트 추가
  document.querySelectorAll("#rows tr.clickable").forEach(tr => {
    tr.addEventListener('click', () => {
      const index = parseInt(tr.dataset.index);
      showReviewModal(sortedRows[index]);
    });
  });

  // 요약
  $total.textContent = rows.length;
  $deptSpread.textContent = [...new Set(rows.map(r=>r.dept))].join(" · ") || "-";
  // 민원의 실제 허가완료일 사용 (기본 정보와 일치)
  $lastReply.textContent = data.approvedAt || "-";

  // 집계 · 심사분야별
  const byDept = {};
  rows.forEach(r=>{
    const dept = r.dept;
    if (!byDept[dept]) {
      byDept[dept] = {
        reviewers: new Set(),
        totalDuration: 0,
        details: []
      };
    }
    
    // 심사인원 추가
    byDept[dept].reviewers.add(r.reviewer);
    
    // 소요시간 계산 및 추가
    const duration = JudgmentUtils.days(r.start, r.end);
    if (duration !== "" && !isNaN(duration)) {
      byDept[dept].totalDuration += duration;
      byDept[dept].details.push({
        reviewer: r.reviewer,
        duration: duration,
        start: r.start,
        end: r.end
      });
    }
  });

  $aggDept.innerHTML = Object.keys(byDept).sort().map(dept => {
    const data = byDept[dept];
    const reviewerCount = data.reviewers.size;
    const totalDuration = data.totalDuration;
    
    // 상세 정보 생성 (각 심사인원별 소요시간)
    const detailsHtml = data.details.map(detail => 
      `<div class="detail-item">
        <span class="detail-reviewer">${detail.reviewer}</span>: ${detail.duration}일 
        <span class="detail-dates">(${detail.start} ~ ${detail.end})</span>
      </div>`
    ).join('');
    
    return `<tr>
      <td>${dept}</td>
      <td>${dept}</td>
      <td>${reviewerCount}</td>
      <td>${totalDuration}</td>
      <td class="details-cell">
        <div class="details-content">
          ${detailsHtml || '<span style="color: #999;">데이터 없음</span>'}
        </div>
      </td>
    </tr>`;
  }).join("") || `<tr><td colspan="5">데이터 없음</td></tr>`;
}
render();

/* === 모달 관련 함수들 === */
function showReviewModal(reviewData) {
  const modal = document.getElementById('reviewModal');
  const modalBody = document.getElementById('modalBody');
  
  // 상태에 따른 배지 클래스 결정
  const getStatusClass = (status) => {
    if (status === '완료') return 'status-completed';
    if (status === '진행') return 'status-progress';
    if (status === '대기') return 'status-waiting';
    if (status === '지연') return 'status-delayed';
    return 'status-waiting';
  };

  // 소요일 계산
  const duration = JudgmentUtils.days(reviewData.start, reviewData.end);
  
  // 모달 내용 생성
  modalBody.innerHTML = `
    <div class="info-row">
      <div class="info-label">심사분야:</div>
      <div class="info-value">${reviewData.dept}</div>
    </div>
    <div class="info-row">
      <div class="info-label">담당부서:</div>
      <div class="info-value">${reviewData.dept}</div>
    </div>
    <div class="info-row">
      <div class="info-label">심사자:</div>
      <div class="info-value">${reviewData.reviewer || "-"}</div>
    </div>
    <div class="info-row">
      <div class="info-label">협의 의뢰일:</div>
      <div class="info-value">${reviewData.request || "-"}</div>
    </div>
    <div class="info-row">
      <div class="info-label">심사 시작일:</div>
      <div class="info-value">${reviewData.start || "-"}</div>
    </div>
    <div class="info-row">
      <div class="info-label">심사 종료일:</div>
      <div class="info-value">${reviewData.end || "-"}</div>
    </div>
    <div class="info-row">
      <div class="info-label">심사 소요일:</div>
      <div class="info-value">${duration === "" ? "-" : duration + "일"}</div>
    </div>
    <div class="info-row">
      <div class="info-label">진행 상태:</div>
      <div class="info-value">
        <span class="status-badge ${getStatusClass(reviewData.status)}">${reviewData.status}</span>
      </div>
    </div>
    <div class="info-row">
      <div class="info-label">민원 접수번호:</div>
      <div class="info-value">${data.id}</div>
    </div>
    <div class="info-row">
      <div class="info-label">품목명:</div>
      <div class="info-value">${data.productName}</div>
    </div>
    <div class="info-row">
      <div class="info-label">업체명:</div>
      <div class="info-value">${data.company}</div>
    </div>
    
    <!-- 심사 의견 섹션 -->
    <div class="opinion-section">
      <div class="opinion-title">📝 심사 의견</div>
      <div class="opinion-content">${reviewData.opinion || "심사 의견이 없습니다."}</div>
    </div>
    
    <!-- 심사 자료 섹션 -->
    <div class="documents-section">
      <div class="documents-title">📁 심사 자료</div>
      ${reviewData.documents && reviewData.documents.length > 0 ? `
        <ul class="document-list">
          ${reviewData.documents.map(doc => `
            <li class="document-item">
              <span class="document-icon">📄</span>
              <span class="document-name">${doc}</span>
              <a href="#" class="document-download" onclick="downloadDocument('${doc}')">다운로드</a>
            </li>
          `).join('')}
        </ul>
      ` : `
        <div class="no-data">제출된 자료가 없습니다.</div>
      `}
    </div>
  `;
  
  modal.style.display = 'block';
}

function closeModal() {
  const modal = document.getElementById('reviewModal');
  modal.style.display = 'none';
}

// 자료 다운로드 함수 (시뮬레이션)
function downloadDocument(filename) {
  // 실제 환경에서는 서버에서 파일을 다운로드하지만, 
  // 데모용으로는 알림만 표시합니다.
  alert(`파일 다운로드: ${filename}\n\n실제 환경에서는 해당 파일이 다운로드됩니다.`);
  
  // 실제 구현 예시:
  // const link = document.createElement('a');
  // link.href = `/api/documents/${filename}`;
  // link.download = filename;
  // link.click();
}

// 모달 이벤트 리스너
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('reviewModal');
  const closeBtn = document.querySelector('.close');
  
  // X 버튼 클릭으로 모달 닫기
  closeBtn.addEventListener('click', closeModal);
  
  // 모달 외부 클릭으로 모달 닫기
  modal.addEventListener('click', function(event) {
    if (event.target === modal) {
      closeModal();
    }
  });
  
  // ESC 키로 모달 닫기
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeModal();
    }
  });
});

/* === 엑셀 내보내기 (현재 화면 데이터 그대로) === */
function exportRows(){
  // 협의 의뢰일 기준으로 오름차순 정렬
  const sortedRows = data.reviews.sort((a, b) => {
    const dateA = a.request ? new Date(a.request) : new Date(0);
    const dateB = b.request ? new Date(b.request) : new Date(0);
    return dateA - dateB;
  });
  
  return sortedRows.map(r=>{
    const dur = JudgmentUtils.days(r.start, r.end);
    return [r.dept, r.dept, r.request||"", r.reviewer||"", r.start||"", r.end||"", (dur===""?"":dur), r.status||""];
  });
}

// 1) CSV (UTF-8 with BOM)
document.getElementById("btnExcelCsv").onclick = ()=>{
  const header = ["심사분야","담당부서","협의 의뢰일","심사자 이름","심사 시작일","심사 종료일","심사 소요일","진행 상태"];
  const rows = exportRows();
  const csv = [header, ...rows].map(arr =>
    arr.map(v=>{
      const s = (v??"").toString().replace(/"/g,'""');
      return /[",\n]/.test(s)? `"${s}"` : s;
    }).join(",")
  ).join("\n");
  const BOM = "\uFEFF";
  const blob = new Blob([BOM + csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `심사실적_${data.id}_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
};

// 2) XLS (Excel 2003 XML)
document.getElementById("btnExcelXls").onclick = ()=>{
  const header = ["심사분야","담당부서","협의 의뢰일","심사자 이름","심사 시작일","심사 종료일","심사 소요일","진행 상태"];
  const rows = exportRows();
  const esc = (s)=>String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const xmlRows = [
    `<Row>${header.map(h=>`<Cell><Data ss:Type="String">${esc(h)}</Data></Cell>`).join("")}</Row>`,
    ...rows.map(r=>`<Row>${
      r.map(v=>{
        const isNum = /^-?\d+(\.\d+)?$/.test(v);
        const type = isNum ? "Number" : "String";
        return `<Cell><Data ss:Type="${type}">${esc(v)}</Data></Cell>`;
      }).join("")
    }</Row>`)
  ].join("");
  const xml =
`<?xml version="1.0" encoding="UTF-8"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:x="urn:schemas-microsoft-com:office:excel"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
 <Worksheet ss:Name="심사실적">
  <Table>
   ${xmlRows}
  </Table>
 </Worksheet>
</Workbook>`;
  const blob = new Blob([xml], {type: "application/vnd.ms-excel;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `심사실적_${data.id}_${new Date().toISOString().slice(0,10)}.xls`;
  document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
};
</script>
</body>
</html>
