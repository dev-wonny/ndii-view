<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ìˆ˜ ê¸°ë¡ ëŒ€ëŸ‰ ë“±ë¡</title>
    <!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #f7f8fa;
            --card: #ffffff;
            --line: #e5e7eb;
            --text: #111827;
            --muted: #6b7280;
            --primary: #2563eb;
            --danger: #dc2626;
            --ok: #059669;
            --warn: #d97706;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Noto Sans KR, sans-serif;
            color: var(--text);
            background: var(--bg);
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 24px;
            font-size: 24px;
            border-bottom: 2px solid var(--line);
            padding-bottom: 12px;
        }
        
        .section {
            margin-bottom: 24px;
            padding: 16px;
            border: 1px solid var(--line);
            border-radius: 8px;
            background: #fafafa;
        }
        
        .section h3 {
            margin: 0 0 16px 0;
            color: var(--text);
            font-size: 18px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--line);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .file-upload {
            border: 2px dashed var(--line);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .file-upload:hover {
            border-color: var(--primary);
            background: #f0f9ff;
        }
        
        .file-upload.dragover {
            border-color: var(--primary);
            background: #f0f9ff;
        }
        
        .btn {
            padding: 10px 20px;
            border: 1px solid var(--line);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-weight: 500;
            color: var(--text);
            font-family: inherit;
            transition: all 0.2s;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .btn:hover {
            background: var(--bg);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
        }
        
        .btn-secondary {
            background: var(--muted);
            color: white;
            border-color: var(--muted);
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            font-size: 12px;
        }
        
        .preview-table th,
        .preview-table td {
            border: 1px solid var(--line);
            padding: 8px;
            text-align: left;
        }
        
        .preview-table th {
            background: #f3f4f6;
            font-weight: 600;
        }
        
        .preview-table tr:nth-child(even) {
            background: #f9fafb;
        }
        
        .error {
            color: var(--danger);
            font-weight: 600;
        }
        
        .success {
            color: var(--ok);
            font-weight: 600;
        }
        
        .warning {
            color: var(--warn);
            font-weight: 600;
        }
        
        .info {
            background: #e0f2fe;
            border: 1px solid #81d4fa;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .info h4 {
            margin: 0 0 8px 0;
            color: #0277bd;
        }
        
        .info ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .info li {
            margin-bottom: 4px;
        }
        
        .hidden {
            display: none;
        }
        
        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-valid {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-invalid {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ì´ìˆ˜ ê¸°ë¡ ëŒ€ëŸ‰ ë“±ë¡</h1>
        
        <div class="info">
            <h4>ğŸ“‹ ë“±ë¡ ê°€ì´ë“œ</h4>
            <ul>
                <li><strong>íŒŒì¼ í˜•ì‹:</strong> Excel íŒŒì¼(.xlsx)ë§Œ ì§€ì›ë©ë‹ˆë‹¤</li>
                <li><strong>í•„ìˆ˜ ì»¬ëŸ¼:</strong> ì´ìˆ˜í•œ ë¶€ì„œ, ì´ìˆ˜í•œ ì‹¬ì‚¬ì ì´ë¦„, êµìœ¡ì•„ì´ë””, ìŠ¹ì¸ì—¬ë¶€</li>
                <li><strong>ìŠ¹ì¸ì—¬ë¶€:</strong> ëŒ€ê¸°, ìŠ¹ì¸, ë°˜ë ¤ ì¤‘ í•˜ë‚˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”</li>
                <li><strong>êµìœ¡ì•„ì´ë””:</strong> êµìœ¡ê³¼ì • ê´€ë¦¬ì— ë“±ë¡ëœ êµìœ¡ê³¼ì •ì˜ IDë¥¼ ì‚¬ìš©í•˜ì„¸ìš”</li>
                <li><strong>ì´ìˆ˜ì¼:</strong> ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ìë™ ì„¤ì •ë©ë‹ˆë‹¤</li>
            </ul>
        </div>
        
        <div class="section">
            <h3>1. í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</h3>
            <p>ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë“±ë¡ìš© í…œí”Œë¦¿ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.</p>
            <button class="btn btn-primary" onclick="downloadTemplate()">ğŸ“¥ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
        </div>
        
        <div class="section">
            <h3>2. íŒŒì¼ ì—…ë¡œë“œ</h3>
            <div class="file-upload" id="fileUploadArea">
                <p>ğŸ“ Excel íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
            </div>
            <div id="fileInfo" class="hidden" style="margin-top: 12px;">
                <p><strong>ì„ íƒëœ íŒŒì¼:</strong> <span id="fileName"></span></p>
                <button class="btn btn-danger" onclick="clearFile()">íŒŒì¼ ì œê±°</button>
            </div>
        </div>
        
        <div class="section">
            <h3>3. ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h3>
            <div id="previewArea" class="hidden">
                <p><strong>ì´ <span id="recordCount">0</span>ê±´ì˜ ì´ìˆ˜ ê¸°ë¡ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--line); border-radius: 6px;">
                    <table class="preview-table" id="previewTable">
                        <thead>
                            <tr>
                                <th>ì´ìˆ˜í•œ ë¶€ì„œ</th>
                                <th>ì´ìˆ˜í•œ ì‹¬ì‚¬ì ì´ë¦„</th>
                                <th>êµìœ¡ì•„ì´ë””</th>
                                <th>êµìœ¡ì‚¬ì—…ëª…</th>
                                <th>ìŠ¹ì¸ì—¬ë¶€</th>
                                <th>ì´ìˆ˜ì¼</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 16px;">
                    <button class="btn btn-primary" onclick="confirmUpload()">âœ… ë“±ë¡ í™•ì¸</button>
                    <button class="btn btn-secondary" onclick="clearFile()">âŒ ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>4. ë“±ë¡ ê²°ê³¼</h3>
            <div id="resultArea" class="hidden">
                <p id="resultMessage"></p>
            </div>
        </div>
    </div>

    <script>
        let uploadedData = [];
        let courseDatabase = null;
        
        // ë¶€ì„œ ëª©ë¡
        const departments = ['ì‹ ì•½ì‹¬ì‚¬ë¶€', 'í—ˆê°€ì´ê´„ë¶€', 'ìƒë¬¼ì˜ì•½í’ˆë¶€', 'í’ˆì§ˆì•ˆì „ë¶€', 'ì„ìƒì •ì±…ë¶€'];
        
        // ìŠ¹ì¸ì—¬ë¶€ ëª©ë¡
        const approvalStatuses = ['ëŒ€ê¸°', 'ìŠ¹ì¸', 'ë°˜ë ¤'];
        
        // ë¶€ëª¨ ì°½ì—ì„œ êµìœ¡ê³¼ì • ë°ì´í„° ë°›ê¸°
        window.addEventListener('message', function(event) {
            if (event.data.type === 'COURSE_DATABASE') {
                courseDatabase = event.data.courses;
                console.log('êµìœ¡ê³¼ì • ë°ì´í„°ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤:', courseDatabase);
            }
        });
        
        // ë¶€ëª¨ ì°½ì— êµìœ¡ê³¼ì • ë°ì´í„° ìš”ì²­
        window.opener.postMessage({
            type: 'REQUEST_COURSE_DATABASE'
        }, '*');
        
        // íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ ì´ë²¤íŠ¸
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        
        fileUploadArea.addEventListener('click', () => fileInput.click());
        fileUploadArea.addEventListener('dragover', handleDragOver);
        fileUploadArea.addEventListener('dragleave', handleDragLeave);
        fileUploadArea.addEventListener('drop', handleDrop);
        
        fileInput.addEventListener('change', handleFileSelect);
        
        function handleDragOver(e) {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }
        
        function processFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('Excel íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        alert('íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í—¤ë”ì™€ ìµœì†Œ 1ê°œì˜ ë°ì´í„° í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        return;
                    }
                    
                    // í—¤ë” í™•ì¸
                    const headers = jsonData[0];
                    const requiredHeaders = ['ì´ìˆ˜í•œ ë¶€ì„œ', 'ì´ìˆ˜í•œ ì‹¬ì‚¬ì ì´ë¦„', 'êµìœ¡ì•„ì´ë””', 'ìŠ¹ì¸ì—¬ë¶€'];
                    
                    for (const required of requiredHeaders) {
                        if (!headers.includes(required)) {
                            alert(`í•„ìˆ˜ ì»¬ëŸ¼ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ${required}`);
                            return;
                        }
                    }
                    
                    // ë°ì´í„° ì²˜ë¦¬
                    const records = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.every(cell => cell === undefined || cell === '')) continue; // ë¹ˆ í–‰ ê±´ë„ˆë›°ê¸°
                        
                        const record = {
                            dept: row[headers.indexOf('ì´ìˆ˜í•œ ë¶€ì„œ')] || '',
                            auditorName: row[headers.indexOf('ì´ìˆ˜í•œ ì‹¬ì‚¬ì ì´ë¦„')] || '',
                            courseId: row[headers.indexOf('êµìœ¡ì•„ì´ë””')] || '',
                            approval: row[headers.indexOf('ìŠ¹ì¸ì—¬ë¶€')] || '',
                            completionDate: row[headers.indexOf('ì´ìˆ˜ì¼')] || new Date().toISOString().slice(0, 10)
                        };
                        
                        records.push(record);
                    }
                    
                    uploadedData = records;
                    displayFileInfo(file.name);
                    showPreview();
                    
                } catch (error) {
                    console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function displayFileInfo(fileName) {
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('fileInfo').classList.remove('hidden');
        }
        
        function showPreview() {
            const previewArea = document.getElementById('previewArea');
            const previewTableBody = document.getElementById('previewTableBody');
            const recordCount = document.getElementById('recordCount');
            
            previewTableBody.innerHTML = '';
            recordCount.textContent = uploadedData.length;
            
            uploadedData.forEach((record, index) => {
                const row = document.createElement('tr');
                
                // êµìœ¡ê³¼ì • ì •ë³´ ì°¾ê¸°
                const course = courseDatabase ? courseDatabase.find(c => c.id == record.courseId) : null;
                const courseName = course ? course.name : 'êµìœ¡ê³¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ';
                
                // ìœ íš¨ì„± ê²€ì‚¬
                const validation = validateRecord(record, course);
                
                row.innerHTML = `
                    <td>${record.dept}</td>
                    <td>${record.auditorName}</td>
                    <td>${record.courseId}</td>
                    <td>${courseName}</td>
                    <td>${record.approval}</td>
                    <td>${record.completionDate}</td>
                    <td><span class="status-badge ${validation.isValid ? 'status-valid' : 'status-invalid'}">${validation.message}</span></td>
                `;
                
                previewTableBody.appendChild(row);
            });
            
            previewArea.classList.remove('hidden');
        }
        
        function validateRecord(record, course) {
            const errors = [];
            
            if (!record.dept || !departments.includes(record.dept)) {
                errors.push('ìœ íš¨í•˜ì§€ ì•Šì€ ë¶€ì„œ');
            }
            
            if (!record.auditorName || record.auditorName.trim() === '') {
                errors.push('ì‹¬ì‚¬ì ì´ë¦„ ëˆ„ë½');
            }
            
            if (!record.courseId || isNaN(record.courseId)) {
                errors.push('ìœ íš¨í•˜ì§€ ì•Šì€ êµìœ¡ì•„ì´ë””');
            } else if (!course) {
                errors.push('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” êµìœ¡ê³¼ì •');
            }
            
            if (!record.approval || !approvalStatuses.includes(record.approval)) {
                errors.push('ìœ íš¨í•˜ì§€ ì•Šì€ ìŠ¹ì¸ì—¬ë¶€');
            }
            
            if (record.completionDate && !isValidDate(record.completionDate)) {
                errors.push('ìœ íš¨í•˜ì§€ ì•Šì€ ì´ìˆ˜ì¼');
            }
            
            return {
                isValid: errors.length === 0,
                message: errors.length === 0 ? 'ìœ íš¨í•¨' : errors.join(', ')
            };
        }
        
        function isValidDate(dateString) {
            const date = new Date(dateString);
            return date instanceof Date && !isNaN(date);
        }
        
        function confirmUpload() {
            if (uploadedData.length === 0) {
                alert('ë“±ë¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ìœ íš¨ì„± ê²€ì‚¬
            const validRecords = [];
            const invalidRecords = [];
            
            uploadedData.forEach(record => {
                const course = courseDatabase ? courseDatabase.find(c => c.id == record.courseId) : null;
                const validation = validateRecord(record, course);
                
                if (validation.isValid) {
                    validRecords.push(record);
                } else {
                    invalidRecords.push(record);
                }
            });
            
            if (invalidRecords.length > 0) {
                const confirmMessage = `ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°ê°€ ${invalidRecords.length}ê±´ ìˆìŠµë‹ˆë‹¤.\nìœ íš¨í•œ ${validRecords.length}ê±´ë§Œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                if (!confirm(confirmMessage)) {
                    return;
                }
            }
            
            // ë¶€ëª¨ ì°½ì— ë°ì´í„° ì „ì†¡
            window.opener.postMessage({
                type: 'bulkInsertRecords',
                data: validRecords
            }, '*');
            
            showResult(validRecords.length, invalidRecords.length);
        }
        
        function showResult(successCount, errorCount) {
            const resultArea = document.getElementById('resultArea');
            const resultMessage = document.getElementById('resultMessage');
            
            let message = `<div class="success">âœ… ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>`;
            message += `<p><strong>ë“±ë¡ëœ ì´ìˆ˜ ê¸°ë¡:</strong> ${successCount}ê±´</p>`;
            
            if (errorCount > 0) {
                message += `<p class="error"><strong>ë“±ë¡ ì‹¤íŒ¨:</strong> ${errorCount}ê±´ (ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°)</p>`;
            }
            
            resultMessage.innerHTML = message;
            resultArea.classList.remove('hidden');
            
            // 3ì´ˆ í›„ ì°½ ë‹«ê¸°
            setTimeout(() => {
                window.close();
            }, 3000);
        }
        
        function clearFile() {
            fileInput.value = '';
            uploadedData = [];
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('previewArea').classList.add('hidden');
            document.getElementById('resultArea').classList.add('hidden');
        }
        
        function downloadTemplate() {
            const templateData = [
                ['ì´ìˆ˜í•œ ë¶€ì„œ', 'ì´ìˆ˜í•œ ì‹¬ì‚¬ì ì´ë¦„', 'êµìœ¡ì•„ì´ë””', 'ìŠ¹ì¸ì—¬ë¶€', 'ì´ìˆ˜ì¼'],
                ['ì‹ ì•½ì‹¬ì‚¬ë¶€', 'í™ê¸¸ë™', '1', 'ìŠ¹ì¸', '2025-01-15'],
                ['í—ˆê°€ì´ê´„ë¶€', 'ê¹€ì² ìˆ˜', '2', 'ëŒ€ê¸°', '2025-01-16'],
                ['ìƒë¬¼ì˜ì•½í’ˆë¶€', 'ì´ì˜í¬', '3', 'ë°˜ë ¤', '2025-01-17']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ì´ìˆ˜ê¸°ë¡');
            
            XLSX.writeFile(wb, 'ì´ìˆ˜ê¸°ë¡_ëŒ€ëŸ‰ë“±ë¡_í…œí”Œë¦¿.xlsx');
        }
    </script>
</body>
</html>
