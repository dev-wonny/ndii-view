<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>의약품통합정보시스템 - 교육 실적 관리</title>
    <style>
        :root{
            --bg:#f7f8fa; --card:#ffffff; --line:#e5e7eb; --text:#111827; --muted:#6b7280; --primary:#2563eb; --danger:#dc2626; --ok:#059669; --warn:#d97706;
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;color:var(--text);background:var(--bg)}
        
        header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px;display:flex;gap:12px;align-items:center}
        header h1{font-size:18px;margin:0 12px 0 0}
        
        .container{padding:16px;max-width:1400px;margin:0 auto}
        .hidden{display:none !important}
        .row{display:grid;gap:12px}
        .row.two{grid-template-columns:1fr 1fr}
        .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:16px}
        .card h3{margin:0 0 8px 0;font-size:16px}
        
        nav{background-color:var(--card);border-bottom:1px solid var(--line);padding:10px 16px;text-align:center}
        nav a{text-decoration:none;color:var(--text);padding:8px 15px;border-radius:8px;margin:0 5px;font-weight:500;transition:all 0.2s}
        nav a.active,nav a:hover{background-color:var(--primary);color:white}
        
        main > section { display: none; padding-top: 20px; }
        main > section.active { display: block; }
        
        h2{font-size:20px;border-left:5px solid var(--primary);padding-left:10px;margin-bottom:20px;color:var(--text)}
        
        .search-area, .action-area, .info-box{border:1px solid var(--line);background-color:var(--card);padding:15px;margin-bottom:20px;border-radius:12px}
        .search-area form, .search-area{display:flex;gap:15px;align-items:center;flex-wrap:wrap}
        
        .form-group{display:flex;align-items:center;gap:8px}
        label{font-weight:600;color:var(--muted)}
        
        input[type="text"], input[type="date"], select{padding:8px 10px;border:1px solid var(--line);border-radius:8px;height:35px;box-sizing:border-box;background:#fff}
        input[type="text"]{width:200px}
        
        .btn{padding:8px 12px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer;font-weight:500;color:var(--text);font-family:inherit;transition:all 0.2s}
        .btn:hover{background:var(--bg)}
        .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
        .btn-primary:hover{background:#1d4ed8}
        .btn-secondary{background:var(--muted);color:#fff;border-color:var(--muted)}
        .btn-search{background:var(--primary);color:#fff;border-color:var(--primary)}
        .btn-danger{background:var(--danger);color:#fff;border-color:var(--danger)}
        .btn-danger:hover{background:#b91c1c}
        
        .action-area{text-align:right}
        
        table{width:100%;border-collapse:separate;border-spacing:0;margin-top:20px}
        th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
        thead th{color:var(--muted);font-weight:600;background:#fafafa;position:sticky;top:0}
        thead th.sortable{cursor:pointer}
        thead th.sortable:hover{background:#f3f4f6}
        thead th .sort-arrow{opacity:0.3}
        
        tbody tr:hover td{background:#fafafa}
        .required-missing{background-color:#fef2f2 !important;font-weight:700;color:var(--danger)}
        .link{color:var(--primary);text-decoration:none;cursor:pointer}
        .link:hover{text-decoration:underline}
        
        .manage-buttons{display:flex;gap:4px;flex-wrap:wrap;justify-content:center;align-items:center}
        .manage-buttons .btn{min-width:50px;font-size:11px}
        
        /* 테이블 개선 */
        #recordTable td{vertical-align:middle;padding:8px 6px}
        #recordTable th{font-size:13px;padding:10px 6px}
        #recordTable .status{font-size:11px;padding:2px 6px}
        
        /* Modal Styles */
        .modal-overlay{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.5)}
        .modal-content{background:var(--card);margin:10% auto;padding:20px;border:1px solid var(--line);width:80%;max-width:600px;border-radius:12px;position:relative}
        .modal-header{padding-bottom:10px;border-bottom:1px solid var(--line);margin-bottom:20px}
        .modal-header h3{margin:0;font-size:18px}
        .close-btn{color:var(--muted);position:absolute;top:10px;right:20px;font-size:28px;font-weight:bold;cursor:pointer}
        .close-btn:hover{color:var(--text)}
        .modal-body .form-group{margin-bottom:15px;flex-direction:column;align-items:flex-start}
        .modal-body .form-group label{margin-bottom:5px}
        .modal-body .form-group input,.modal-body .form-group select{width:100%}
        .modal-footer{text-align:center;padding-top:20px;border-top:1px solid var(--line);margin-top:20px}
        
        /* Toast Notification Styles */
        #toast-container{position:fixed;bottom:20px;right:20px;z-index:2000}
        .toast{padding:15px 20px;background-color:var(--ok);color:white;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);opacity:0;transition:opacity 0.5s;margin-bottom:10px}
        
        /* Status styles */
        .status{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#fff}
        .status.ok{border-color:#bbf7d0;background:#ecfdf5;color:#166534}
        .status.wait{border-color:#fde68a;background:#fffbeb;color:#92400e}
        .status.bad{border-color:#fecaca;background:#fef2f2;color:#7f1d1d}
        
        /* Responsive */
        @media (max-width: 768px) {
            .container{padding:8px}
            .search-area form{flex-direction:column;align-items:stretch}
            .form-group{flex-direction:column;align-items:stretch}
            input[type="text"]{width:100%}
            .row.two{grid-template-columns:1fr}
        }
    </style>
</head>
<body>

    <header>
        <h1>의약품통합정보시스템 - 교육 실적 관리</h1>
    </header>

    <nav>
        <a href="#" class="nav-link active" data-target="EDU-003">교육과정 관리</a>
        <a href="#" class="nav-link" data-target="EDU-004">심사자별 교육 이수 현황</a>
        <a href="#" class="nav-link" data-target="EDU-005">교육 실적 현황 보고서</a>
        <a href="#" class="nav-link" data-target="EDU-006">들어야 하는 교육 목록</a>
    </nav>

    <main class="container">
        <section id="EDU-003" class="active">
            <div class="card">
                <h2>교육과정 관리</h2>
                <div class="search-area">
                    <form id="courseSearchForm">
                         <div class="form-group"><label for="courseNameInput">교육명</label><input type="text" id="courseNameInput"></div>
                         <div class="form-group"><label for="courseTypeSelect">필수여부</label><select id="courseTypeSelect"><option value="전체">전체</option><option value="필수">필수</option><option value="선택">선택</option></select></div>
                         <button type="submit" class="btn btn-search">조회</button><button type="reset" class="btn btn-secondary">초기화</button>
                    </form>
                </div>
                <div class="action-area"><button id="add-course-btn" class="btn btn-primary">신규 등록</button></div>
                <table id="courseTable">
                    <thead><tr>
                        <th class="sortable" data-sort="id">No <span class="sort-arrow">↕</span></th>
                        <th class="sortable" data-sort="name">교육명 <span class="sort-arrow">↕</span></th>
                        <th>교육 정보</th>
                        <th class="sortable" data-sort="startDate">교육기간 <span class="sort-arrow">↕</span></th>
                        <th class="sortable" data-sort="type">필수여부 <span class="sort-arrow">↕</span></th>
                        <th class="sortable" data-sort="hours">인정시간 <span class="sort-arrow">↕</span></th>
                        <th class="sortable" data-sort="regDate">등록일 <span class="sort-arrow">↕</span></th>
                        <th>관리</th>
                    </tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="EDU-004">
            <div class="card">
                <h2>심사자별 교육 이수 현황</h2>
                <div class="search-area">
                     <form id="auditorSearchForm">
                        <div class="form-group"><label for="deptSelect">부서 선택</label><select id="deptSelect"><option value="전체">전체 부서</option><option value="신약심사부">신약심사부</option><option value="허가총괄부">허가총괄부</option><option value="생물의약품부">생물의약품부</option><option value="품질안전부">품질안전부</option><option value="임상정책부">임상정책부</option></select></div>
                        <div class="form-group"><label for="auditorNameInput">심사자 검색</label><input type="text" id="auditorNameInput" placeholder="예: 홍길동, 김철수, 이영희, 박선우, 최민준"></div>
                        <button type="submit" class="btn btn-search">검색</button>
                    </form>
                </div>
                <!-- auditorInfoBox 제거 -->
                <div class="action-area"><button class="btn btn-primary" id="add-record-btn">이수 기록 등록</button></div>
                <table id="recordTable">
                    <thead><tr>
                        <th>심사자명</th>
                        <th>부서</th>
                        <th>직급</th>
                        <th>교육명</th>
                        <th>이수일</th>
                        <th>필수여부</th>
                        <th>인정시간</th>
                        <th>상태</th>
                        <th>관리</th>
                    </tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="EDU-005">
            <div class="card">
                <h2>교육 실적 현황 보고서</h2>
                 <div class="search-area">
                     <form id="reportSearchForm">
                        <div class="form-group"><label>조회기간</label><input type="date" id="reportStartDate"> ~ <input type="date" id="reportEndDate"></div>
                        <div class="form-group"><label for="reportDeptSelect">부서</label><select id="reportDeptSelect"><option value="">전체 부서</option><option value="신약심사부">신약심사부</option><option value="허가총괄부">허가총괄부</option><option value="생물의약품부">생물의약품부</option><option value="품질안전부">품질안전부</option><option value="임상정책부">임상정책부</option></select></div>
                        <div class="form-group"><label for="reportAuditorNameInput">심사자</label><input type="text" id="reportAuditorNameInput"></div>
                        <button type="submit" class="btn btn-search">조회</button><button type="reset" class="btn btn-secondary">초기화</button>
                     </form>
                </div>
                <div class="action-area" style="display: flex; justify-content: space-between; align-items: center;">
                     <span id="reportSummary"></span>
                     <div><button class="btn btn-secondary">엑셀 다운로드</button><button class="btn btn-secondary">인쇄</button></div>
                </div>
                <table id="reportTable">
                        <thead><tr>
                            <th class="sortable" data-sort="dept">부서 <span class="sort-arrow">↕</span></th>
                            <th class="sortable" data-sort="auditor">성명 <span class="sort-arrow">↕</span></th>
                            <th>직급</th>
                            <th class="sortable" data-sort="course">교육명 <span class="sort-arrow">↕</span></th>
                            <th class="sortable" data-sort="startDate">교육 시작일 <span class="sort-arrow">↕</span></th>
                            <th class="sortable" data-sort="endDate">교육 종료일 <span class="sort-arrow">↕</span></th>
                            <th>필수여부</th><th>인정시간</th>
                        </tr></thead>
                        <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="EDU-006">
            <div class="card">
                <h2>들어야 하는 교육 목록</h2>
                <div class="search-area">
                    <form id="myEducationSearchForm">
                        <div class="form-group">
                            <label for="myNameInput">이름</label>
                            <input type="text" id="myNameInput" placeholder="본인 이름을 입력하세요">
                        </div>
                        <div class="form-group">
                            <label for="myDeptSelect">부서</label>
                            <select id="myDeptSelect">
                                <option value="">부서 선택</option>
                                <option value="신약심사부">신약심사부</option>
                                <option value="허가총괄부">허가총괄부</option>
                                <option value="생물의약품부">생물의약품부</option>
                                <option value="품질안전부">품질안전부</option>
                                <option value="임상정책부">임상정책부</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-search">조회</button>
                        <button type="reset" class="btn btn-secondary">초기화</button>
                    </form>
                </div>
                
                <div class="info-box" id="myEducationInfo" style="display: none;">
                    <h4>교육 이수 현황 요약</h4>
                    <div id="myEducationSummary"></div>
                </div>
                
                <table id="myEducationTable">
                    <thead><tr>
                        <th>교육명</th>
                        <th>교육기간</th>
                        <th>필수여부</th>
                        <th>인정시간</th>
                        <th>이수일</th>
                        <th>상태</th>
                        <th>비고</th>
                        <th>증빙자료</th>
                    </tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </main>
    
    <div id="modal-popup" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-title"></h3><span class="close-btn">&times;</span></div>
            <form id="modal-form">
                <input type="hidden" id="modal-edit-id">
                <div class="modal-body" id="modal-body-content">
                    </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">저장</button>
                    <button type="button" class="btn btn-secondary close-btn-bottom">취소</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 데이터베이스 및 상태 관리 ---
        let db = {};
        let currentAuditor = null;
        let sortState = {};

        // localStorage에서 데이터 로드 또는 초기화
        const initData = () => {
            const savedDb = localStorage.getItem('eduDb');
            if (savedDb) {
                db = JSON.parse(savedDb);
            } else {
                db = {
                    courses: [
                        { id: 1, name: "개인정보보호 및 정보보안 교육", desc: "개인정보 처리 및 정보보안 관련 필수 교육", startDate: "2025-02-01", endDate: "2025-02-28", type: "필수", hours: 2, regDate: "2025-01-10" },
                        { id: 2, name: "의약품 GMP 기본 과정", desc: "의약품 제조 및 품질관리 표준 교육", startDate: "2025-04-01", endDate: "2025-04-30", type: "선택", hours: 8, regDate: "2025-03-10" },
                        { id: 3, name: "2025년 신약 허가·심사 워크숍", desc: "신약 개발 및 심사 관련 최신 동향 및 실무 교육", startDate: "2025-07-15", endDate: "2025-07-16", type: "필수", hours: 16, regDate: "2025-06-01" },
                        { id: 4, name: "바이오의약품 심사 가이드라인", desc: "바이오의약품 심사 기준 및 절차 교육", startDate: "2025-08-01", endDate: "2025-08-10", type: "필수", hours: 8, regDate: "2025-07-15" },
                        { id: 5, name: "의약품 통계 분석 심화", desc: "임상시험 데이터 분석 및 통계적 해석 교육", startDate: "2025-10-20", endDate: "2025-10-21", type: "선택", hours: 16, regDate: "2025-09-01" },
                        { id: 6, name: "의약품 부작용 보고 시스템", desc: "의약품 안전성 모니터링 및 부작용 보고 절차", startDate: "2025-03-01", endDate: "2025-03-15", type: "필수", hours: 4, regDate: "2025-02-15" },
                        { id: 7, name: "임상시험 윤리 및 규정", desc: "임상시험 관련 윤리적 고려사항 및 규정 준수", startDate: "2025-05-10", endDate: "2025-05-20", type: "필수", hours: 6, regDate: "2025-04-20" },
                        { id: 8, name: "의약품 품질관리 실무", desc: "의약품 품질관리 실무 및 검사 방법론", startDate: "2025-06-01", endDate: "2025-06-10", type: "선택", hours: 12, regDate: "2025-05-15" },
                        { id: 9, name: "신약 개발 프로세스", desc: "신약 개발 단계별 프로세스 및 심사 포인트", startDate: "2025-09-01", endDate: "2025-09-15", type: "필수", hours: 10, regDate: "2025-08-20" },
                        { id: 10, name: "의약품 허가 후 관리", desc: "의약품 허가 후 안전성 및 효능성 모니터링", startDate: "2025-11-01", endDate: "2025-11-10", type: "선택", hours: 8, regDate: "2025-10-15" },
                        { id: 11, name: "생물학적 제제 심사", desc: "생물학적 제제의 특성 및 심사 기준", startDate: "2025-12-01", endDate: "2025-12-10", type: "필수", hours: 14, regDate: "2025-11-20" },
                        { id: 12, name: "의약품 경제성 평가", desc: "의약품 경제성 평가 방법론 및 적용 사례", startDate: "2026-01-15", endDate: "2026-01-20", type: "선택", hours: 12, regDate: "2025-12-25" },
                        { id: 13, name: "2026년 신약 심사 가이드라인 업데이트", desc: "2026년도 신약 심사 기준 및 가이드라인 변경사항", startDate: "2026-02-01", endDate: "2026-02-15", type: "필수", hours: 8, regDate: "2026-01-20" },
                        { id: 14, name: "디지털 헬스케어 의약품 심사", desc: "디지털 기술을 활용한 의약품 및 의료기기 심사 기준", startDate: "2026-03-01", endDate: "2026-03-10", type: "필수", hours: 12, regDate: "2026-02-15" },
                        { id: 15, name: "희귀질환 의약품 심사 특론", desc: "희귀질환 의약품의 특별 심사 기준 및 절차", startDate: "2026-04-01", endDate: "2026-04-15", type: "선택", hours: 16, regDate: "2026-03-20" },
                        { id: 16, name: "의약품 임상시험 설계 고급과정", desc: "임상시험 설계의 고급 기법 및 통계적 고려사항", startDate: "2026-05-01", endDate: "2026-05-10", type: "선택", hours: 20, regDate: "2026-04-15" },
                        { id: 17, name: "의약품 안전성 관리 시스템", desc: "의약품 안전성 모니터링 및 리스크 관리 체계", startDate: "2026-06-01", endDate: "2026-06-15", type: "필수", hours: 10, regDate: "2026-05-20" },
                        { id: 18, name: "바이오시밀러 심사 실무", desc: "바이오시밀러의 심사 기준 및 품질 평가 방법", startDate: "2026-07-01", endDate: "2026-07-10", type: "필수", hours: 14, regDate: "2026-06-20" },
                        { id: 19, name: "의약품 품질 표준 및 규정", desc: "국제 의약품 품질 표준 및 국내 규정 비교", startDate: "2026-08-01", endDate: "2026-08-15", type: "선택", hours: 12, regDate: "2026-07-20" },
                        { id: 20, name: "의약품 허가 후 변경사항 심사", desc: "의약품 허가 후 변경사항 심사 기준 및 절차", startDate: "2026-09-01", endDate: "2026-09-10", type: "필수", hours: 8, regDate: "2026-08-20" },
                        { id: 21, name: "의약품 임상시험 윤리 심화", desc: "임상시험 윤리 위원회 운영 및 윤리적 고려사항", startDate: "2026-10-01", endDate: "2026-10-15", type: "필수", hours: 10, regDate: "2026-09-20" },
                        { id: 22, name: "의약품 데이터 무결성", desc: "의약품 개발 및 심사 과정의 데이터 무결성 보장", startDate: "2026-11-01", endDate: "2026-11-10", type: "선택", hours: 16, regDate: "2026-10-20" },
                        { id: 23, name: "의약품 글로벌 규제 동향", desc: "주요 국가별 의약품 규제 동향 및 협력 방안", startDate: "2026-12-01", endDate: "2026-12-15", type: "선택", hours: 18, regDate: "2026-11-20" },
                        { id: 24, name: "의약품 심사 품질 관리", desc: "의약품 심사 과정의 품질 관리 및 개선 방안", startDate: "2027-01-15", endDate: "2027-01-25", type: "필수", hours: 12, regDate: "2026-12-25" },
                    ],
                    // ===== 더미 데이터 추가된 부분 =====
                    auditors: {
                        '홍길동': { info: { name: '홍길동', dept: '신약심사부', rank: '심사원' }, records: [
                            { id: 1, courseId: 2, date: '2025-04-20' },
                            { id: 2, courseId: 1, date: '2025-02-15' },
                        ]},
                        '김철수': { info: { name: '김철수', dept: '허가총괄부', rank: '주무관' }, records: [
                            { id: 1, courseId: 4, date: '2025-08-10' },
                            { id: 2, courseId: 1, date: '2025-02-18' },
                        ]},
                        '이영희': { info: { name: '이영희', dept: '신약심사부', rank: '연구관' }, records: [
                             { id: 1, courseId: 5, date: '2025-10-21' },
                             { id: 2, courseId: 3, date: '2025-07-16' },
                             { id: 3, courseId: 1, date: '2025-02-20' },
                        ]},
                        '박선우': { info: { name: '박선우', dept: '생물의약품부', rank: '선임연구관' }, records: [
                             { id: 1, courseId: 1, date: '2025-02-11' },
                             { id: 2, courseId: 4, date: '2025-08-05' },
                        ]},
                        '최민준': { info: { name: '최민준', dept: '신약심사부', rank: '심사원' }, records: [
                             { id: 1, courseId: 1, date: '2025-09-05' },
                        ]},
                        '정수진': { info: { name: '정수진', dept: '품질안전부', rank: '주무관' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-25' },
                            { id: 2, courseId: 3, date: '2025-07-20' },
                        ]},
                        '한지민': { info: { name: '한지민', dept: '품질안전부', rank: '심사원' }, records: [
                            { id: 1, courseId: 2, date: '2025-04-15' },
                        ]},
                        '송민호': { info: { name: '송민호', dept: '임상정책부', rank: '연구관' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-28' },
                            { id: 2, courseId: 5, date: '2025-10-25' },
                        ]},
                        '윤서연': { info: { name: '윤서연', dept: '허가총괄부', rank: '심사원' }, records: [
                            { id: 1, courseId: 4, date: '2025-08-15' },
                        ]},
                        '임동현': { info: { name: '임동현', dept: '생물의약품부', rank: '주무관' }, records: [
                            { id: 1, courseId: 1, date: '2025-03-01' },
                            { id: 2, courseId: 2, date: '2025-04-10' },
                        ]},
                        '김미영': { info: { name: '김미영', dept: '신약심사부', rank: '선임연구관' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-15', approve: '승인' },
                            { id: 2, courseId: 3, date: '2025-07-20', approve: '승인' },
                            { id: 3, courseId: 6, date: '2025-03-10', approve: '승인' },
                            { id: 4, courseId: 7, date: '2025-05-15', approve: '승인' },
                            { id: 5, courseId: 9, date: '2025-09-10', approve: '승인' },
                        ]},
                        '박준호': { info: { name: '박준호', dept: '허가총괄부', rank: '심사원' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-20', approve: '승인' },
                            { id: 2, courseId: 4, date: '2025-08-05', approve: '승인' },
                            { id: 3, courseId: 6, date: '2025-03-12', approve: '승인' },
                        ]},
                        '이수진': { info: { name: '이수진', dept: '품질안전부', rank: '연구관' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-18', approve: '승인' },
                            { id: 2, courseId: 2, date: '2025-04-25', approve: '승인' },
                            { id: 3, courseId: 6, date: '2025-03-08', approve: '승인' },
                            { id: 4, courseId: 8, date: '2025-06-05', approve: '승인' },
                        ]},
                        '최영수': { info: { name: '최영수', dept: '임상정책부', rank: '주무관' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-22', approve: '승인' },
                            { id: 2, courseId: 7, date: '2025-05-18', approve: '승인' },
                        ]},
                        '정다은': { info: { name: '정다은', dept: '생물의약품부', rank: '심사원' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-25', approve: '승인' },
                            { id: 2, courseId: 4, date: '2025-08-12', approve: '승인' },
                            { id: 3, courseId: 11, date: '2025-12-05', approve: '승인' },
                        ]},
                        '한승우': { info: { name: '한승우', dept: '신약심사부', rank: '연구관' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-28', approve: '승인' },
                            { id: 2, courseId: 3, date: '2025-07-25', approve: '승인' },
                            { id: 3, courseId: 5, date: '2025-10-25', approve: '승인' },
                            { id: 4, courseId: 6, date: '2025-03-15', approve: '승인' },
                            { id: 5, courseId: 7, date: '2025-05-20', approve: '승인' },
                            { id: 6, courseId: 9, date: '2025-09-12', approve: '승인' },
                        ]},
                        '윤지현': { info: { name: '윤지현', dept: '허가총괄부', rank: '선임연구관' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-10', approve: '승인' },
                            { id: 2, courseId: 2, date: '2025-04-20', approve: '승인' },
                            { id: 3, courseId: 6, date: '2025-03-05', approve: '승인' },
                            { id: 4, courseId: 8, date: '2025-06-08', approve: '승인' },
                            { id: 5, courseId: 10, date: '2025-11-05', approve: '승인' },
                        ]},
                        '강민석': { info: { name: '강민석', dept: '품질안전부', rank: '심사원' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-12', approve: '승인' },
                            { id: 2, courseId: 6, date: '2025-03-18', approve: '승인' },
                        ]},
                        '조현아': { info: { name: '조현아', dept: '임상정책부', rank: '연구관' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-16', approve: '승인' },
                            { id: 2, courseId: 7, date: '2025-05-12', approve: '승인' },
                            { id: 3, courseId: 12, date: '2026-01-18', approve: '승인' },
                        ]},
                        '서동현': { info: { name: '서동현', dept: '신약심사부', rank: '주무관' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-14', approve: '승인' },
                            { id: 2, courseId: 6, date: '2025-03-20', approve: '승인' },
                            { id: 3, courseId: 7, date: '2025-05-25', approve: '승인' },
                        ]},
                        '김태영': { info: { name: '김태영', dept: '허가총괄부', rank: '연구관' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-19', approve: '승인' },
                            { id: 2, courseId: 4, date: '2025-08-08', approve: '승인' },
                            { id: 3, courseId: 6, date: '2025-03-25', approve: '승인' },
                            { id: 4, courseId: 8, date: '2025-06-12', approve: '승인' },
                        ]},
                        '박소연': { info: { name: '박소연', dept: '생물의약품부', rank: '선임연구관' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-11', approve: '승인' },
                            { id: 2, courseId: 3, date: '2025-07-18', approve: '승인' },
                            { id: 3, courseId: 4, date: '2025-08-15', approve: '승인' },
                            { id: 4, courseId: 6, date: '2025-03-22', approve: '승인' },
                            { id: 5, courseId: 7, date: '2025-05-28', approve: '승인' },
                            { id: 6, courseId: 9, date: '2025-09-18', approve: '승인' },
                            { id: 7, courseId: 11, date: '2025-12-08', approve: '승인' },
                        ]},
                        '이준호': { info: { name: '이준호', dept: '품질안전부', rank: '심사원' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-13', approve: '승인' },
                            { id: 2, courseId: 6, date: '2025-03-28', approve: '승인' },
                        ]},
                        '최수진': { info: { name: '최수진', dept: '임상정책부', rank: '주무관' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-17', approve: '승인' },
                            { id: 2, courseId: 7, date: '2025-05-22', approve: '승인' },
                            { id: 3, courseId: 12, date: '2026-01-22', approve: '승인' },
                        ]},
                        '정민수': { info: { name: '정민수', dept: '신약심사부', rank: '심사원' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-21', approve: '승인' },
                            { id: 2, courseId: 6, date: '2025-03-30', approve: '승인' },
                            { id: 3, courseId: 7, date: '2025-05-30', approve: '승인' },
                            { id: 4, courseId: 9, date: '2025-09-25', approve: '승인' },
                        ]},
                        '한미영': { info: { name: '한미영', dept: '허가총괄부', rank: '심사원' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-23', approve: '승인' },
                            { id: 2, courseId: 2, date: '2025-04-28', approve: '승인' },
                            { id: 3, courseId: 6, date: '2025-04-02', approve: '승인' },
                        ]},
                        '윤성민': { info: { name: '윤성민', dept: '생물의약품부', rank: '연구관' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-26', approve: '승인' },
                            { id: 2, courseId: 4, date: '2025-08-18', approve: '승인' },
                            { id: 3, courseId: 6, date: '2025-04-05', approve: '승인' },
                            { id: 5, courseId: 10, date: '2025-11-08', approve: '승인' },
                        ]},
                        '강지은': { info: { name: '강지은', dept: '품질안전부', rank: '선임연구관' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-09', approve: '승인' },
                            { id: 2, courseId: 2, date: '2025-04-22', approve: '승인' },
                            { id: 3, courseId: 6, date: '2025-03-28', approve: '승인' },
                            { id: 4, courseId: 8, date: '2025-06-15', approve: '승인' },
                            { id: 5, courseId: 10, date: '2025-11-12', approve: '승인' },
                        ]},
                        '조현우': { info: { name: '조현우', dept: '임상정책부', rank: '연구관' }, records: [
                            { id: 1, courseId: 1, date: '2025-02-24', approve: '승인' },
                            { id: 2, courseId: 7, date: '2025-05-26', approve: '승인' },
                            { id: 3, courseId: 12, date: '2026-01-25', approve: '승인' },
                        ]}
                    }
                    // ===================================
                };
            }
            renderAll();
        };

        const saveData = () => {
            localStorage.setItem('eduDb', JSON.stringify(db));
            showToast('변경사항이 저장되었습니다.');
        };
        
        // --- UI 렌더링 함수 ---
        const renderAll = () => {
            renderCourseTable();
            renderRecordTable();
            renderReportTable();
            renderRequiredEducationTable();
        };

        const renderCourseTable = (filterFn = () => true) => {
            const tbody = document.querySelector('#courseTable tbody');
            tbody.innerHTML = '';
            db.courses.filter(filterFn).forEach(c => {
                const row = tbody.insertRow();
                row.dataset.id = c.id;
                row.innerHTML = `
                    <td>${c.id}</td><td>${c.name}</td><td>${c.desc || '교육과정 상세정보'}</td><td>${c.startDate} ~ ${c.endDate}</td>
                    <td><span class="status ${c.type === '필수' ? 'ok' : 'wait'}">${c.type}</span></td><td>${c.hours}</td><td>${c.regDate}</td>
                    <td><div class="manage-buttons">
                        <button class="btn btn-secondary btn-edit-course" style="height:30px;padding:0 10px;">수정</button>
                        <button class="btn btn-danger btn-delete-course" style="height:30px;padding:0 10px;">삭제</button>
                    </div></td>`;
            });
        };

        const renderRecordTable = () => {
            const dept = document.getElementById('deptSelect')?.value || '전체';
            const nameFilter = document.getElementById('auditorNameInput')?.value || '';
            const tbody = document.querySelector('#recordTable tbody');
            tbody.innerHTML = '';

            // 부서별로 심사자 필터링
            let filteredAuditors = Object.entries(db.auditors);
            
            if (dept !== '전체') {
                filteredAuditors = filteredAuditors.filter(([name, auditor]) => 
                    auditor.info.dept === dept
                );
            }
            
            if (nameFilter) {
                filteredAuditors = filteredAuditors.filter(([name, auditor]) => 
                    name.toLowerCase().includes(nameFilter.toLowerCase())
                );
            }

            if (filteredAuditors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9">검색 결과가 없습니다.</td></tr>';
                return;
            }

            // 부서에 속한 모든 심사자 결과 표시
            filteredAuditors.forEach(([name, auditor]) => {
                const completedCourseIds = new Set(auditor.records.map(r => r.courseId));
                let recordsToDisplay = auditor.records.map(r => {
                    const course = db.courses.find(c => c.id === r.courseId);
                    return { ...r, ...course, status: 'completed', approve: r.approve || '승인대기', auditorName: name, auditorDept: auditor.info.dept, auditorRank: auditor.info.rank };
                });

                // 필수 미이수 과목 추가
                db.courses.filter(c => c.type === '필수' && !completedCourseIds.has(c.id))
                    .forEach(c => recordsToDisplay.push({ ...c, id: `m${c.id}`, date: '-', status: 'missing', auditorName: name, auditorDept: auditor.info.dept, auditorRank: auditor.info.rank }));
                
                recordsToDisplay.forEach(rec => {
                    const row = tbody.insertRow();
                    row.dataset.id = rec.id;
                    row.dataset.courseId = rec.courseId;
                    
                    // 상태 표시 (승인/반려/대기/미이수)
                    let statusDisplay = '-';
                    if (rec.status === 'completed') {
                        if (rec.approve === '승인') {
                            statusDisplay = '<span class="status ok">승인</span>';
                        } else if (rec.approve === '반려') {
                            statusDisplay = '<span class="status bad">반려</span>';
                        } else {
                            statusDisplay = '<span class="status wait">승인대기</span>';
                        }
                    } else if (rec.status === 'missing') {
                        statusDisplay = '<span class="status bad">미이수</span>';
                    }
                    
                    // 관리 버튼 단순화
                    let manageButtons = '-';
                    if (rec.status === 'completed') {
                        if (rec.approve === '승인대기') {
                            manageButtons = `
                                <div class="manage-buttons">
                                    <button class="btn btn-primary btn-approve-record" style="height:28px;padding:0 8px;font-size:12px;">승인</button>
                                    <button class="btn btn-danger btn-reject-record" style="height:28px;padding:0 8px;font-size:12px;">반려</button>
                                    <button class="btn btn-secondary btn-edit-record" style="height:28px;padding:0 8px;font-size:12px;">수정</button>
                                </div>`;
                        } else {
                            manageButtons = `
                                <div class="manage-buttons">
                                    <button class="btn btn-secondary btn-edit-record" style="height:28px;padding:0 8px;font-size:12px;">수정</button>
                                    <button class="btn btn-danger btn-delete-record" style="height:28px;padding:0 8px;font-size:12px;">삭제</button>
                                </div>`;
                        }
                    }
                    
                    row.innerHTML = `
                        <td>${rec.auditorName}</td>
                        <td>${rec.auditorDept}</td>
                        <td>${rec.auditorRank}</td>
                        <td>${rec.name}</td>
                        <td>${rec.date}</td>
                        <td><span class="status ${rec.type === '필수' ? 'ok' : 'wait'}">${rec.type}</span></td>
                        <td>${rec.hours}</td>
                        <td>${statusDisplay}</td>
                        <td>${manageButtons}</td>`;
                });
            });
        };

        const renderReportTable = (filterFn = () => true) => {
            const tbody = document.querySelector('#reportTable tbody');
            tbody.innerHTML = '';
            let count = 0;
            Object.values(db.auditors).forEach(auditor => {
                auditor.records.forEach(record => {
                    const course = db.courses.find(c => c.id === record.courseId);
                    if (!course) return; // 과정이 삭제된 경우 건너뜀
                    const fullRecord = { ...auditor.info, ...course, ...record, auditor: auditor.info.name, course: course.name };
                    if (filterFn(fullRecord)) {
                        const row = tbody.insertRow();
                        row.innerHTML = `<td>${fullRecord.dept}</td><td>${fullRecord.auditor}</td><td>${fullRecord.rank}</td>
                                         <td>${fullRecord.course}</td><td>${fullRecord.startDate}</td><td>${fullRecord.endDate}</td><td><span class="status ${fullRecord.type === '필수' ? 'ok' : 'wait'}">${fullRecord.type}</span></td><td>${fullRecord.hours}</td>`;
                        count++;
                    }
                });
            });
            document.getElementById('reportSummary').innerHTML = `<strong>검색 결과:</strong> 총 ${count}건`;
        };

        const renderRequiredEducationTable = () => {
            const tbody = document.querySelector('#myEducationTable tbody');
            const infoBox = document.getElementById('myEducationInfo');
            const summaryDiv = document.getElementById('myEducationSummary');
            
            tbody.innerHTML = '';
            infoBox.style.display = 'none';
            
            // 이름과 부서가 입력되지 않았으면 기본 데이터 표시
            const name = document.getElementById('myNameInput')?.value || '';
            const dept = document.getElementById('myDeptSelect')?.value || '';
            
            if (!name || !dept) {
                // 기본 데이터로 홍길동 정보 표시 (테스트용)
                const defaultAuditor = db.auditors['홍길동'];
                if (defaultAuditor) {
                    displayAuditorData(defaultAuditor, '홍길동', '신약심사부');
                } else {
                    tbody.innerHTML = '<tr><td colspan="8">이름과 부서를 입력하고 조회해주세요.</td></tr>';
                }
                return;
            }
            
            // 해당 심사자 찾기
            const auditor = db.auditors[name];
            if (!auditor || auditor.info.dept !== dept) {
                tbody.innerHTML = '<tr><td colspan="8">해당하는 심사자를 찾을 수 없습니다.</td></tr>';
                return;
            }
            
            displayAuditorData(auditor, name, dept);
        };
        
        const displayAuditorData = (auditor, name, dept) => {
            const tbody = document.querySelector('#myEducationTable tbody');
            const infoBox = document.getElementById('myEducationInfo');
            const summaryDiv = document.getElementById('myEducationSummary');
            
            tbody.innerHTML = '';
            infoBox.style.display = 'none';
            
            // 교육 이수 현황 요약 정보 생성
            const completedCourses = auditor.records.length;
            const requiredCourses = db.courses.filter(c => c.type === '필수').length;
            const completedRequiredCourses = auditor.records.filter(r => {
                const course = db.courses.find(c => c.id === r.courseId);
                return course && course.type === '필수';
            }).length;
            
            const totalHours = auditor.records.reduce((sum, r) => {
                const course = db.courses.find(c => c.id === r.courseId);
                return sum + (course ? course.hours : 0);
            }, 0);
            
            summaryDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 15px 0;">
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: var(--primary);">${completedCourses}</div>
                        <div style="color: var(--muted);">이수 완료 교육</div>
                    </div>
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: var(--ok);">${completedRequiredCourses}/${requiredCourses}</div>
                        <div style="color: var(--muted);">필수 교육 이수율</div>
                    </div>
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: var(--warn);">${totalHours}</div>
                        <div style="color: var(--muted);">총 인정시간</div>
                    </div>
                </div>
            `;
            infoBox.style.display = 'block';
            
            // 모든 교육과정 표시 (이수 완료 + 미이수)
            const completedCourseIds = new Set(auditor.records.map(r => r.courseId));
            let allCourses = [];
            
            // 이수 완료된 교육
            auditor.records.forEach(record => {
                const course = db.courses.find(c => c.id === record.courseId);
                if (course) {
                    allCourses.push({
                        ...course,
                        ...record,
                        status: 'completed',
                        approve: record.approve || '승인대기'
                    });
                }
            });
            
            // 미이수 교육 (필수만)
            db.courses.filter(c => c.type === '필수' && !completedCourseIds.has(c.id))
                .forEach(c => {
                    allCourses.push({
                        ...c,
                        id: `m${c.id}`,
                        date: '-',
                        status: 'missing',
                        approve: '-'
                    });
                });
            
            // 교육기간 순으로 정렬
            allCourses.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            
            allCourses.forEach(course => {
                const row = tbody.insertRow();
                
                // 상태 표시
                let statusDisplay = '-';
                let noteDisplay = '-';
                
                if (course.status === 'completed') {
                    if (course.approve === '승인') {
                        statusDisplay = '<span class="status ok">승인</span>';
                        noteDisplay = '교육 완료';
                    } else if (course.approve === '반려') {
                        statusDisplay = '<span class="status bad">반려</span>';
                        noteDisplay = '재제출 필요';
                    } else {
                        statusDisplay = '<span class="status wait">승인대기</span>';
                        noteDisplay = '승인 대기 중';
                    }
                } else {
                    statusDisplay = '<span class="status bad">미이수</span>';
                    noteDisplay = '필수 교육 - 이수 필요';
                }
                
                row.innerHTML = `
                    <td>${course.name}</td>
                    <td>${course.startDate} ~ ${course.endDate}</td>
                    <td><span class="status ${course.type === '필수' ? 'ok' : 'wait'}">${course.type}</span></td>
                    <td>${course.hours}</td>
                    <td>${course.date}</td>
                    <td>${statusDisplay}</td>
                    <td>${noteDisplay}</td>
                    <td>${course.status === 'missing' ? `<button class="btn btn-primary btn-submit-proof" style="height:28px;padding:0 8px;font-size:12px;">증빙자료 제출</button>` : 
                        course.status === 'completed' ? `<button class="btn btn-secondary btn-view-proof" style="height:28px;padding:0 8px;font-size:12px;">증빙자료 보기</button>` : '-'}</td>
                `;
            });
        };

        // --- 모달 관리 ---
        const modal = document.getElementById('modal-popup');
        const modalTitle = document.getElementById('modal-title');
        
        const openModal = (title, content, data = null) => {
            modalTitle.textContent = title;
            document.getElementById('modal-body-content').innerHTML = content;
            
            if (data) {
                Object.keys(data).forEach(key => {
                    const input = document.getElementById(`modal-${key}`);
                    if (input) input.value = data[key];
                });
            }
            
            modal.style.display = 'block';
        };
        
        const closeModal = () => {
            modal.style.display = 'none';
            document.getElementById('modal-form').reset();
        };
        
        // 모달 닫기 이벤트
        document.querySelectorAll('.close-btn, .close-btn-bottom').forEach(btn => {
            btn.addEventListener('click', closeModal);
        });
        
        // 모달 외부 클릭 시 닫기
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
        
        // 모달 폼 제출 이벤트
        document.getElementById('modal-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {};
            formData.forEach((value, key) => data[key] = value);
            
            // 모달 제목에 따라 다른 저장 로직 실행
            const modalTitle = document.getElementById('modal-title').textContent;
            
            if (modalTitle === '신규 이수 기록 등록') {
                // 새로운 이수 기록 저장
                const newRecord = {
                    id: Date.now(), // 고유 ID 생성
                    courseId: parseInt(data.courseId),
                    date: data.date,
                    approve: '승인대기'
                };
                
                if (!db.auditors[data.auditorName]) {
                    showToast('존재하지 않는 심사자입니다.');
                    return;
                }
                
                db.auditors[data.auditorName].records.push(newRecord);
                showToast('이수 기록이 등록되었습니다.');
                
            } else if (modalTitle === '신규 교육과정 등록') {
                // 새로운 교육과정 저장
                const newCourse = {
                    id: Math.max(...db.courses.map(c => c.id)) + 1,
                    name: data.name,
                    desc: data.desc,
                    startDate: data.startDate,
                    endDate: data.endDate,
                    type: data.type,
                    hours: parseInt(data.hours),
                    regDate: data.regDate
                };
                db.courses.push(newCourse);
                showToast('교육과정이 등록되었습니다.');
                
            } else if (modalTitle === '교육과정 수정') {
                // 교육과정 수정
                const editId = document.getElementById('modal-edit-id').value;
                const course = db.courses.find(c => c.id == editId);
                if (course) {
                    Object.assign(course, {
                        name: data.name,
                        desc: data.desc,
                        startDate: data.startDate,
                        endDate: data.endDate,
                        type: data.type,
                        hours: parseInt(data.hours),
                        regDate: data.regDate
                    });
                    showToast('교육과정이 수정되었습니다.');
                }
            }
            
            saveData();
            closeModal();
            renderAll();
        });
        
        // 네비게이션 이벤트
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('nav-link')) {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('main > section').forEach(s => s.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById(e.target.dataset.target).classList.add('active');
            }
        });

        // EDU-003 이벤트
        document.getElementById('courseSearchForm').addEventListener('submit', e => {
            e.preventDefault();
            const nameFilter = document.getElementById('courseNameInput').value.toLowerCase();
            const typeFilter = document.getElementById('courseTypeSelect').value;
            renderCourseTable(c => 
                c.name.toLowerCase().includes(nameFilter) && (typeFilter === '전체' || c.type === typeFilter)
            );
        });
        document.getElementById('courseSearchForm').addEventListener('reset', () => setTimeout(renderCourseTable, 0));
        
        document.getElementById('add-course-btn').addEventListener('click', () => {
            const formHtml = `
                <div class="form-group"><label for="modal-name">교육명</label><input type="text" id="modal-name" name="name" required></div>
                <div class="form-group"><label for="modal-desc">교육 정보</label><textarea id="modal-desc" name="desc" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;"></textarea></div>
                <div class="form-group"><label for="modal-startDate">시작일</label><input type="date" id="modal-startDate" name="startDate" required></div>
                <div class="form-group"><label for="modal-endDate">종료일</label><input type="date" id="modal-endDate" name="endDate" required></div>
                <div class="form-group"><label for="modal-type">필수여부</label><select id="modal-type" name="type"><option>필수</option><option>선택</option></select></div>
                <div class="form-group"><label for="modal-hours">인정시간</label><input type="number" id="modal-hours" name="hours" required></div>
                <div class="form-group"><label for="modal-regDate">등록일</label><input type="date" id="modal-regDate" name="regDate" value="${new Date().toISOString().slice(0,10)}" required></div>`;
            openModal('신규 교육과정 등록', formHtml);
        });

        document.querySelector('#courseTable tbody').addEventListener('click', e => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const row = btn.closest('tr');
            const id = row.dataset.id;
            
            if (btn.classList.contains('btn-edit-course')) {
                const course = db.courses.find(c => c.id == id);
                const formHtml = `
                    <div class="form-group"><label for="modal-name">교육명</label><input type="text" id="modal-name" name="name" required></div>
                    <div class="form-group"><label for="modal-desc">교육 정보</label><textarea id="modal-desc" name="desc" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;"></textarea></div>
                    <div class="form-group"><label for="modal-startDate">시작일</label><input type="date" id="modal-startDate" name="startDate" required></div>
                    <div class="form-group"><label for="modal-endDate">종료일</label><input type="date" id="modal-endDate" name="endDate" required></div>
                    <div class="form-group"><label for="modal-type">필수여부</label><select id="modal-type" name="type"><option>필수</option><option>선택</option></select></div>
                    <div class="form-group"><label for="modal-hours">인정시간</label><input type="number" id="modal-hours" name="hours" required></div>
                    <div class="form-group"><label for="modal-regDate">등록일</label><input type="date" id="modal-regDate" name="regDate" required></div>`;
                openModal('교육과정 수정', formHtml, course);
            } else if (btn.classList.contains('btn-delete-course')) {
                if (confirm(`'${row.cells[1].textContent}' 과정을 삭제하시겠습니까?`)) {
                    db.courses = db.courses.filter(c => c.id != id);
                    saveData();
                    renderAll();
                }
            }
        });

        // EDU-004 이벤트
        document.getElementById('auditorSearchForm').addEventListener('submit', e => {
            e.preventDefault();
            const dept = document.getElementById('deptSelect').value;
            const nameFilter = document.getElementById('auditorNameInput').value.toLowerCase();
            currentAuditor = nameFilter; // 심사자 이름으로 설정
            renderRecordTable();
        });

        // 부서 선택 변경 시 자동 업데이트
        document.getElementById('deptSelect').addEventListener('change', () => {
            renderRecordTable();
        });

        document.getElementById('add-record-btn').addEventListener('click', () => {
            const auditorOptions = Object.entries(db.auditors).map(([name, auditor]) => 
                `<option value="${name}">${name} (${auditor.info.dept} - ${auditor.info.rank})</option>`
            ).join('');
            const courseOptions = db.courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const formHtml = `
                <div class="form-group"><label for="modal-auditorName">심사자</label><select id="modal-auditorName" name="auditorName" required>${auditorOptions}</select></div>
                <div class="form-group"><label for="modal-courseId">교육과정</label><select id="modal-courseId" name="courseId" required>${courseOptions}</select></div>
                <div class="form-group"><label for="modal-date">이수일자</label><input type="date" id="modal-date" name="date" value="${new Date().toISOString().slice(0,10)}" required></div>
                <div class="form-group"><label for="modal-file">증빙자료</label><input type="file" id="modal-file" name="file"></div>`;
            openModal('신규 이수 기록 등록', formHtml);
        });

        document.querySelector('#recordTable tbody').addEventListener('click', e => {
            const btn = e.target.closest('button');
            if (!btn || !currentAuditor) return;
            const id = btn.closest('tr').dataset.id;
            
            if (btn.classList.contains('btn-edit-record')) {
                const record = db.auditors[currentAuditor].records.find(r => r.id == id);
                const options = db.courses.map(c => `<option value="${c.id}" ${c.id === record.courseId ? 'selected' : ''}>${c.name}</option>`).join('');
                const formHtml = `
                    <div class="form-group"><label for="modal-courseId">교육과정</label><select id="modal-courseId" name="courseId" required>${options}</select></div>
                    <div class="form-group"><label for="modal-date">이수일자</label><input type="date" id="modal-date" name="date" required></div>
                    <div class="form-group"><label for="modal-file">증빙자료</label><input type="file" id="modal-file" name="file"></div>`;
                openModal('이수 기록 수정', formHtml, record);
            } else if (btn.classList.contains('btn-delete-record')) {
                const courseName = db.courses.find(c => c.id == btn.closest('tr').dataset.courseId).name;
                if (confirm(`'${courseName}' 이수 기록을 삭제하시겠습니까?`)) {
                    db.auditors[currentAuditor].records = db.auditors[currentAuditor].records.filter(r => r.id != id);
                    saveData();
                    renderAll();
                }
            } else if (btn.classList.contains('btn-approve-record')) {
                const record = db.auditors[currentAuditor].records.find(r => r.id == id);
                if (record) {
                    record.approve = '승인';
                    saveData();
                    renderAll();
                }
            } else if (btn.classList.contains('btn-reject-record')) {
                const record = db.auditors[currentAuditor].records.find(r => r.id == id);
                if (record) {
                    record.approve = '반려';
                    saveData();
                    renderAll();
                }
            }
        });

        // EDU-005 이벤트
        const reportForm = document.getElementById('reportSearchForm');
        reportForm.addEventListener('submit', e => {
            e.preventDefault();
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const deptFilter = document.getElementById('reportDeptSelect').value;
            const nameFilter = document.getElementById('reportAuditorNameInput').value.toLowerCase();
            renderReportTable(rec => 
                (!startDate || rec.date >= startDate) && (!endDate || rec.date <= endDate) &&
                (deptFilter === '' || rec.dept === deptFilter) && rec.auditor.toLowerCase().includes(nameFilter)
            );
        });
        reportForm.addEventListener('reset', () => setTimeout(renderReportTable, 0));

        // EDU-006 이벤트 (들어야 하는 교육 목록)
        document.getElementById('myEducationSearchForm').addEventListener('submit', e => {
            e.preventDefault();
            renderRequiredEducationTable();
        });
        document.getElementById('myEducationSearchForm').addEventListener('reset', () => {
            document.getElementById('myEducationInfo').style.display = 'none';
            document.querySelector('#myEducationTable tbody').innerHTML = '<tr><td colspan="8">이름과 부서를 입력하고 조회해주세요.</td></tr>';
        });

        // 증빙자료 제출/보기 이벤트
        document.querySelector('#myEducationTable tbody').addEventListener('click', e => {
            const btn = e.target.closest('button');
            if (!btn) return;
            
            const row = btn.closest('tr');
            const courseName = row.cells[0].textContent;
            const courseType = row.cells[2].querySelector('.status').textContent;
            const courseHours = row.cells[3].textContent;
            
            if (btn.classList.contains('btn-submit-proof')) {
                // 증빙자료 제출 모달
                const formHtml = `
                    <div class="form-group"><label for="modal-courseName">교육명</label><input type="text" id="modal-courseName" value="${courseName}" readonly></div>
                    <div class="form-group"><label for="modal-courseType">교육구분</label><input type="text" id="modal-courseType" value="${courseType}" readonly></div>
                    <div class="form-group"><label for="modal-courseHours">인정시간</label><input type="text" id="modal-courseHours" value="${courseHours}" readonly></div>
                    <div class="form-group"><label for="modal-completionDate">이수완료일</label><input type="date" id="modal-completionDate" name="completionDate" required></div>
                    <div class="form-group"><label for="modal-proofFile">증빙자료</label><input type="file" id="modal-proofFile" name="proofFile" required></div>
                    <div class="form-group"><label for="modal-notes">비고</label><textarea id="modal-notes" name="notes" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;" placeholder="교육 내용 요약이나 특이사항을 입력하세요"></textarea></div>`;
                openModal('증빙자료 제출', formHtml);
                
            } else if (btn.classList.contains('btn-view-proof')) {
                // 증빙자료 보기 모달
                const formHtml = `
                    <div class="form-group"><label for="modal-courseName">교육명</label><input type="text" id="modal-courseName" value="${courseName}" readonly></div>
                    <div class="form-group"><label for="modal-courseType">교육구분</label><input type="text" id="modal-courseType" value="${courseType}" readonly></div>
                    <div class="form-group"><label for="modal-courseHours">인정시간</label><input type="text" id="modal-courseHours" value="${courseHours}" readonly></div>
                    <div class="form-group"><label for="modal-completionDate">이수완료일</label><input type="text" id="modal-completionDate" readonly></div>
                    <div class="form-group"><label for="modal-proofFile">증빙자료</label><input type="text" id="modal-proofFile" value="첨부된 파일명.pdf" readonly></div>
                    <div class="form-group"><label for="modal-notes">비고</label><textarea id="modal-notes" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;" readonly>교육 내용 요약이나 특이사항</textarea></div>`;
                openModal('증빙자료 보기', formHtml);
            }
        });

        // --- 공통 유틸리티 ---
        const showToast = (message) => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '1'; }, 100);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => { container.removeChild(toast); }, 500);
            }, 3000);
        };
        
        // 정렬 이벤트 리스너
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const table = header.closest('table');
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const sortBy = header.dataset.sort;
                const currentDir = header.dataset.dir || 'desc';
                const newDir = currentDir === 'asc' ? 'desc' : 'asc';
                
                // 모든 헤더의 정렬 방향 초기화
                table.querySelectorAll('th').forEach(th => th.removeAttribute('data-dir'));
                header.dataset.dir = newDir; // 현재 클릭된 헤더에만 방향 설정

                rows.sort((a, b) => {
                    // 셀 인덱스 찾기
                    const colIndex = Array.from(header.parentElement.children).indexOf(header);
                    let valA = a.cells[colIndex].textContent.trim();
                    let valB = b.cells[colIndex].textContent.trim();
                    
                    // 숫자나 날짜 비교
                    if (!isNaN(valA) && !isNaN(valB)) {
                        return (valA - valB) * (newDir === 'asc' ? 1 : -1);
                    }
                    if (valA.match(/^\d{4}-\d{2}-\d{2}$/) && valB.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        return (new Date(valA) - new Date(valB)) * (newDir === 'asc' ? 1 : -1);
                    }

                    // 문자열 비교
                    return valA.localeCompare(valB) * (newDir === 'asc' ? 1 : -1);
                });
                
                tbody.innerHTML = '';
                rows.forEach(row => tbody.appendChild(row));
            });
        });

        // --- 앱 시작 ---
        initData();
    });
    </script>

</body>
</html>