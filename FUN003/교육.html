<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>의약품통합정보시스템 - 교육 실적 관리</title>
    <!-- SheetJS 라이브러리 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root{
            --bg:#f7f8fa; --card:#ffffff; --line:#e5e7eb; --text:#111827; --muted:#6b7280; --primary:#2563eb; --danger:#dc2626; --ok:#059669; --warn:#d97706;
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;color:var(--text);background:var(--bg)}
        
        header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
        header h1{font-size:18px;margin:0 12px 0 0}
        #userInfo{display:flex;align-items:center;gap:8px}
        
        .container{padding:16px;max-width:1400px;margin:0 auto}
        .hidden{display:none !important}
        .row{display:grid;gap:12px}
        .row.two{grid-template-columns:1fr 1fr}
        .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:16px}
        .card h3{margin:0 0 8px 0;font-size:16px}
        
        nav{background-color:var(--card);border-bottom:1px solid var(--line);padding:10px 16px;text-align:center}
        nav a{text-decoration:none;color:var(--text);padding:8px 15px;border-radius:8px;margin:0 5px;font-weight:500;transition:all 0.2s}
        nav a.active,nav a:hover{background-color:var(--primary);color:white}
        
        main > section { display: none; padding-top: 20px; }
        main > section.active { display: block; }
        
        h2{font-size:20px;border-left:5px solid var(--primary);padding-left:10px;margin-bottom:20px;color:var(--text)}
        
        .search-area, .action-area, .info-box{border:1px solid var(--line);background-color:var(--card);padding:15px;margin-bottom:20px;border-radius:12px}
        .search-area form, .search-area{display:flex;gap:15px;align-items:center;flex-wrap:wrap}
        .search-area .form-group.date-range{display:flex;align-items:center;gap:8px}
        .search-area .form-group.date-range input{width:150px}
        
        .form-group{display:flex;align-items:center;gap:8px}
        label{font-weight:600;color:var(--muted)}
        
        input[type="text"], input[type="date"], select{padding:8px 10px;border:1px solid var(--line);border-radius:8px;height:35px;box-sizing:border-box;background:#fff}
        input[type="text"]{width:200px}
        
        .btn{padding:8px 12px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer;font-weight:500;color:var(--text);font-family:inherit;transition:all 0.2s}
        .btn:hover{background:var(--bg)}
        .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
        .btn-primary:hover{background:#1d4ed8}
        .btn-secondary{background:var(--muted);color:#fff;border-color:var(--muted)}
        .btn-search{background:var(--primary);color:#fff;border-color:var(--primary)}
        .btn-danger{background:var(--danger);color:#fff;border-color:var(--danger)}
        .btn-danger:hover{background:#b91c1c}
        
        .action-area{text-align:right}
        
        .table-container{overflow-x:auto;margin-top:0;border:1px solid var(--line);border-radius:8px;border-top-left-radius:0;border-top-right-radius:0}
        .table-hint{background:#f0f9ff;padding:8px 12px;margin-bottom:0;border-radius:6px;border-left:4px solid var(--primary);font-size:14px;color:var(--primary);width:100%;box-sizing:border-box;border-bottom-left-radius:0;border-bottom-right-radius:0}
        table{width:100%;border-collapse:separate;border-spacing:0}
        #courseTable{min-width:1200px}
        #recordTable{min-width:1600px}
        th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;font-size:13px;white-space:nowrap}
        /* 교육과정 관리 테이블 컬럼 너비 */
        #courseTable th:first-child, #courseTable td:first-child{width:80px;min-width:80px}
        #courseTable th:nth-child(2), #courseTable td:nth-child(2){width:200px;min-width:200px;white-space:normal;word-wrap:break-word}
        #courseTable th:nth-child(3), #courseTable td:nth-child(3){width:250px;min-width:250px;white-space:normal;word-wrap:break-word}
        #courseTable th:nth-child(4), #courseTable td:nth-child(4){width:180px;min-width:180px}
        #courseTable th:nth-child(5), #courseTable td:nth-child(5){width:80px;min-width:80px}
        #courseTable th:nth-child(6), #courseTable td:nth-child(6){width:80px;min-width:80px}
        #courseTable th:nth-child(7), #courseTable td:nth-child(7){width:150px;min-width:150px}
        #courseTable th:nth-child(8), #courseTable td:nth-child(8){width:100px;min-width:100px}
        #courseTable th:nth-child(9), #courseTable td:nth-child(9){width:100px;min-width:100px}
        #courseTable th:nth-child(10), #courseTable td:nth-child(10){width:120px;min-width:120px}
        
        /* 심사자별 교육 이수 현황 테이블 컬럼 너비 */
        #recordTable th:first-child, #recordTable td:first-child{width:120px;min-width:120px}
        #recordTable th:nth-child(2), #recordTable td:nth-child(2){width:100px;min-width:100px}
        #recordTable th:nth-child(3), #recordTable td:nth-child(3){width:100px;min-width:100px}
        #recordTable th:nth-child(4), #recordTable td:nth-child(4){width:250px;min-width:250px;white-space:normal;word-wrap:break-word}
        #recordTable th:nth-child(5), #recordTable td:nth-child(5){width:300px;min-width:300px;white-space:normal;word-wrap:break-word}
        #recordTable th:nth-child(6), #recordTable td:nth-child(6){width:180px;min-width:180px}
        #recordTable th:nth-child(7), #recordTable td:nth-child(7){width:100px;min-width:100px}
        #recordTable th:nth-child(8), #recordTable td:nth-child(8){width:80px;min-width:80px}
        #recordTable th:nth-child(9), #recordTable td:nth-child(9){width:80px;min-width:80px}
        #recordTable th:nth-child(10), #recordTable td:nth-child(10){width:150px;min-width:150px}
        #recordTable th:nth-child(11), #recordTable td:nth-child(11){width:100px;min-width:100px}
        #recordTable th:nth-child(12), #recordTable td:nth-child(12){width:100px;min-width:100px}
        #recordTable th:nth-child(13), #recordTable td:nth-child(13){width:120px;min-width:120px}
        thead th{color:var(--muted);font-weight:600;background:#fafafa;position:sticky;top:0}
        thead th.sortable{cursor:pointer}
        thead th.sortable:hover{background:#f3f4f6}
        thead th .sort-arrow{opacity:0.3}
        
        tbody tr:hover td{background:#fafafa}
        .required-missing{background-color:#fef2f2 !important;font-weight:700;color:var(--danger)}
        .link{color:var(--primary);text-decoration:none;cursor:pointer}
        .link:hover{text-decoration:underline}
        
        .manage-buttons{display:flex;gap:4px;flex-wrap:wrap;justify-content:center;align-items:center}
        .manage-buttons .btn{min-width:50px;font-size:11px}
        
        /* 테이블 개선 */
        #recordTable td{vertical-align:middle;padding:8px 6px}
        #recordTable th{font-size:13px;padding:10px 6px}
        #recordTable .status{font-size:11px;padding:2px 6px}
        
        /* 교육사업명 컬럼 개선 */
        #recordTable th:nth-child(3), #recordTable td:nth-child(3) {
            max-width: 200px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* 세부과정(프로그램)명 컬럼 개선 */
        #recordTable th:nth-child(4), #recordTable td:nth-child(4) {
            max-width: 250px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* 교육기간 컬럼 개선 */
        #recordTable th:nth-child(5), #recordTable td:nth-child(5) {
            max-width: 180px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* 관리 버튼 컬럼 개선 */
        #recordTable th:nth-child(12), #recordTable td:nth-child(12) {
            text-align: center;
            white-space: nowrap;
        }
        
        /* Modal Styles */
        .modal-overlay{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.5)}
        .modal-content{background:var(--card);margin:10% auto;padding:20px;border:1px solid var(--line);width:80%;max-width:600px;border-radius:12px;position:relative}
        .modal-header{padding-bottom:10px;border-bottom:1px solid var(--line);margin-bottom:20px}
        .modal-header h3{margin:0;font-size:18px}
        .close-btn{color:var(--muted);position:absolute;top:10px;right:20px;font-size:28px;font-weight:bold;cursor:pointer}
        .close-btn:hover{color:var(--text)}
        .modal-body .form-group{margin-bottom:15px;flex-direction:column;align-items:flex-start}
        .modal-body .form-group label{margin-bottom:5px}
        .modal-body .form-group input,.modal-body .form-group select{width:100%}
        .modal-footer{text-align:center;padding-top:20px;border-top:1px solid var(--line);margin-top:20px}
        
        /* Toast Notification Styles */
        #toast-container{position:fixed;bottom:20px;right:20px;z-index:2000}
        .toast{padding:15px 20px;background-color:var(--ok);color:white;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);opacity:0;transition:opacity 0.5s;margin-bottom:10px}
        
        /* Status styles */
        .status{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#fff}
        .status.ok{border-color:#bbf7d0;background:#ecfdf5;color:#166534}
        .status.wait{border-color:#fde68a;background:#fffbeb;color:#92400e}
        .status.bad{border-color:#fecaca;background:#fef2f2;color:#7f1d1d}
        
        /* 처리 완료 상태 스타일 */
        .status-info {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        .status-info p {
            margin: 8px 0;
        }
        .status-info em {
            color: var(--muted);
            font-style: italic;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container{padding:8px}
            .search-area form{flex-direction:column;align-items:stretch}
            .form-group{flex-direction:column;align-items:stretch}
            input[type="text"]{width:100%}
            .row.two{grid-template-columns:1fr}
            .table-container{overflow-x:auto;margin-top:16px;border-radius:6px}
            table{min-width:900px}
            th,td{padding:6px;font-size:11px}
            .manage-buttons{flex-direction:column;gap:2px}
            .manage-buttons .btn{font-size:10px;padding:4px 6px}
        }
        
        @media (max-width: 480px) {
            .table-container{overflow-x:scroll;margin-top:12px}
            table{min-width:800px}
            th,td{padding:4px;font-size:10px}
            .btn{font-size:11px;padding:6px 8px}
        }

        /* 승인/반려 모달 스타일 */
        .approval-info {
            max-width: 600px;
            margin: 0 auto;
        }

        .approval-info h4 {
            color: var(--primary);
            margin: 16px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--line);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-item label {
            font-weight: 600;
            color: var(--muted);
            font-size: 14px;
        }

        .info-item span {
            color: var(--text);
            font-size: 14px;
            padding: 4px 0;
        }

        .evidence-section {
            background: var(--bg);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .evidence-content {
            margin-top: 12px;
        }

        .evidence-item {
            margin-bottom: 16px;
        }

        .evidence-item label {
            font-weight: 600;
            color: var(--muted);
            font-size: 14px;
            display: block;
            margin-bottom: 8px;
        }

        .evidence-text {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--line);
            min-height: 60px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.5;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--line);
        }

        .file-name {
            color: var(--primary);
            font-weight: 500;
            font-size: 14px;
        }

        .no-file {
            color: var(--muted);
            font-style: italic;
            font-size: 14px;
        }

        .approval-actions {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--line);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .action-buttons .btn {
            flex: 1;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 14px;
        }

        /* 모든 row 클릭 가능 표시 */
        #recordTable tbody tr {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #recordTable tbody tr:hover {
            background-color: #f0f9ff;
            border-left: 4px solid var(--primary);
        }

        #recordTable tbody tr:hover td {
            color: var(--primary);
        }

        /* 승인대기 row 특별 표시 */
        #recordTable tbody tr[data-approve="승인대기"] {
            border-left: 3px solid var(--warn);
        }

        #recordTable tbody tr[data-approve="승인대기"]:hover {
            border-left: 4px solid var(--primary);
        }

        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>의약품통합정보시스템 - 교육 실적 관리</h1>
        <div id="userInfo" style="margin-left: auto; color: var(--muted); font-size: 14px;">
            <span id="currentUserInfo">신약심사부 - 홍길동</span>
            <button id="switchUserBtn" style="margin-left: 10px; padding: 4px 8px; font-size: 12px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">권한 전환</button>
        </div>
    </header>

    <nav>
        <a href="#" class="nav-link active" data-target="EDU-003">교육과정 관리</a>
        <a href="#" class="nav-link" data-target="EDU-004">심사자별 교육 이수 현황</a>
        <a href="#" class="nav-link" data-target="EDU-005">교육 실적 현황 보고서</a>
    </nav>

    <main class="container">
        <section id="EDU-003" class="active">
            <div class="card">
                <h2>교육과정 관리</h2>
                <div class="search-area">
                    <form id="courseSearchForm">
                         <div class="form-group"><label for="courseNameInput">교육사업명</label><input type="text" id="courseNameInput"></div>
                         <div class="form-group"><label for="courseDescInput">세부과정(프로그램)명</label><input type="text" id="courseDescInput"></div>
                         <div class="form-group date-range"><label for="startDateInput">교육기간</label><input type="date" id="startDateInput" placeholder="시작일"> ~ <input type="date" id="endDateInput" placeholder="종료일"></div>
                         <div class="form-group"><label for="courseTypeSelect">필수여부</label><select id="courseTypeSelect"><option value="전체">전체</option><option value="필수">필수</option><option value="선택">선택</option></select></div>
                         <div class="form-group"><label for="dataSourceSelect">데이터 소스</label><select id="dataSourceSelect"><option value="전체">전체</option><option value="API">평가원 교육관리시스템</option><option value="EXTERNAL">외부 교육기관</option></select></div>
                         <button type="submit" class="btn btn-search">조회</button><button type="reset" class="btn btn-secondary">초기화</button>
                    </form>
                    <div style="margin-top: 12px;">
                        <span id="searchResultInfo" style="color: var(--muted); font-weight: 500;">검색 결과: 전체</span>
                </div>
                </div>
                <div class="action-area">
                    <div>
                        <button id="sync-api-btn" class="btn btn-primary">API 동기화</button>
                        <button id="add-course-btn" class="btn btn-primary">신규 등록</button>
                        <button id="bulk-insert-btn" class="btn btn-secondary" style="display: none;">대량 등록</button>
                    </div>
                </div>
                <div class="table-container">
                <table id="courseTable">
                    <thead><tr>
                        <th class="sortable" data-sort="id">교육ID <span class="sort-arrow">↕</span></th>
                        <th class="sortable" data-sort="name">교육사업명 <span class="sort-arrow">↕</span></th>
                        <th>세부과정(프로그램)명</th>
                        <th class="sortable" data-sort="startDate">교육기간 <span class="sort-arrow">↕</span></th>
                        <th class="sortable" data-sort="type">필수여부 <span class="sort-arrow">↕</span></th>
                        <th class="sortable" data-sort="hours">인정시간 <span class="sort-arrow">↕</span></th>
                            <th class="sortable" data-sort="dataSource">데이터 소스 <span class="sort-arrow">↕</span></th>
                            <th class="sortable" data-sort="registrant">등록자 <span class="sort-arrow">↕</span></th>
                        <th class="sortable" data-sort="regDate">등록일 <span class="sort-arrow">↕</span></th>
                        <th>관리</th>
                    </tr></thead>
                    <tbody></tbody>
                </table>
                </div>
            </div>
        </section>

        <section id="EDU-004">
            <div class="card">
                <h2>심사자별 교육 이수 현황</h2>
                <div class="search-area">
                     <form id="auditorSearchForm">
                        <div class="form-group"><label for="deptSelect">부서 선택</label><select id="deptSelect"><option value="전체">전체 부서</option><option value="신약심사부">신약심사부</option><option value="허가총괄부">허가총괄부</option><option value="생물의약품부">생물의약품부</option><option value="품질안전부">품질안전부</option><option value="임상정책부">임상정책부</option></select></div>
                        <div class="form-group"><label for="auditorNameInput">심사자 검색</label><input type="text" id="auditorNameInput" placeholder="예: 홍길동, 김철수, 이영희, 박선우, 최민준"></div>
                        <div class="form-group"><label for="courseNameSearchInput">교육사업명</label><input type="text" id="courseNameSearchInput" placeholder="교육사업명을 입력하세요"></div>
                        <div class="form-group"><label for="courseDescSearchInput">세부과정명</label><input type="text" id="courseDescSearchInput" placeholder="세부과정명을 입력하세요"></div>
                        <div class="form-group date-range"><label for="coursePeriodStartInput">교육기간</label><input type="date" id="coursePeriodStartInput" placeholder="시작일"> ~ <input type="date" id="coursePeriodEndInput" placeholder="종료일"></div>
                        <div class="form-group date-range"><label for="completionStartInput">이수일</label><input type="date" id="completionStartInput" placeholder="시작일"> ~ <input type="date" id="completionEndInput" placeholder="종료일"></div>
                        <div class="form-group"><label for="courseTypeSearchSelect">필수여부</label><select id="courseTypeSearchSelect"><option value="전체">전체</option><option value="필수">필수</option><option value="선택">선택</option></select></div>
                        <div class="form-group"><label for="dataSourceSearchSelect">데이터 소스</label><select id="dataSourceSearchSelect"><option value="전체">전체</option><option value="API">평가원 교육관리시스템</option><option value="EXTERNAL">외부 교육기관</option></select></div>
                        <div class="form-group"><label for="statusSelect">상태</label><select id="statusSelect"><option value="전체">전체 상태</option><option value="승인완료">승인완료</option><option value="승인대기">승인대기</option><option value="반려">반려</option><option value="자동승인">자동승인</option></select></div>
                        <button type="submit" class="btn btn-search">검색</button>
                    </form>
                </div>
                <!-- auditorInfoBox 제거 -->
                <div class="action-area">
                    <div>
                        <button id="sync-records-api-btn" class="btn btn-primary">API 동기화</button>
                        <button class="btn btn-primary" id="add-record-btn">이수 기록 등록</button>
                        <button id="bulk-insert-records-btn" class="btn btn-secondary" style="display: none;">이수 기록 대량 등록</button>
                    </div>
                </div>
                <div class="table-hint">
                    💡 행을 클릭하면 이수 기록의 상세 정보와 증빙자료를 확인할 수 있습니다
                </div>
                <div class="table-container">
                <table id="recordTable">
                    <thead><tr>
                        <th>고유ID</th>
                        <th>부서</th>
                        <th>성명</th>
                        <th>교육사업명</th>
                        <th>세부과정(프로그램)명</th>
                        <th>교육기간</th>
                        <th>이수일</th>
                        <th>필수여부</th>
                        <th>인정시간</th>
                            <th>데이터 소스</th>
                            <th>등록자</th>
                        <th>상태</th>
                        <th>관리</th>
                    </tr></thead>
                    <tbody></tbody>
                </table>
                </div>
            </div>
        </section>

        <section id="EDU-005">
            <div class="card">
                <h2>교육 실적 현황 보고서</h2>
                
                <!-- 보고서 유형 선택 -->
                <div class="report-type-selector" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 16px; color: var(--text);">보고서 유형 선택</h3>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="reportType" value="personal" checked>
                            <span>개인별 보고서</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="reportType" value="department">
                            <span>부서별 보고서</span>
                        </label>
                    </div>
                </div>

                <!-- 개인별 보고서 -->
                <div id="personalReport" class="report-section">
                    <h3 style="margin: 0 0 15px 0; font-size: 18px; color: var(--primary);">개인별 교육 실적 보고서</h3>
                    <div class="search-area">
                        <form id="personalReportForm">
                            <div class="form-group"><label>조회기간</label><input type="date" id="personalStartDate"> ~ <input type="date" id="personalEndDate"></div>
                            <div class="form-group"><label for="personalDeptSelect">부서</label><select id="personalDeptSelect"><option value="">전체 부서</option><option value="신약심사부">신약심사부</option><option value="허가총괄부">허가총괄부</option><option value="생물의약품부">생물의약품부</option><option value="품질안전부">품질안전부</option><option value="임상정책부">임상정책부</option></select></div>
                            <div class="form-group"><label for="personalAuditorInput">심사자</label><input type="text" id="personalAuditorInput" placeholder="심사자 이름을 입력하세요 (예: 홍길동, 김철수)"></div>
                            <button type="submit" class="btn btn-search">조회</button><button type="reset" class="btn btn-secondary">초기화</button>
                        </form>
                    </div>
                    <div class="action-area" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span id="personalReportSummary"></span>
                        <div><button id="personalExcelBtn" class="btn btn-primary">엑셀 다운로드</button><button id="personalPrintBtn" class="btn btn-secondary">인쇄</button></div>
                    </div>
                    <div class="table-container">
                        <table id="personalReportTable">
                            <thead><tr>
                                <th>고유ID</th>
                                <th>부서</th>
                                <th>성명</th>
                                <th>교육사업명</th>
                                <th>세부과정(프로그램)명</th>
                                <th>교육기간</th>
                                <th>이수일자</th>
                                <th>인정시간</th>
                                <th>상태</th>
                                <th>데이터소스</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- 부서별 보고서 -->
                <div id="departmentReport" class="report-section" style="display: none;">
                    <h3 style="margin: 0 0 15px 0; font-size: 18px; color: var(--primary);">부서별 교육 실적 보고서</h3>
                    <div class="search-area">
                        <form id="departmentReportForm">
                            <div class="form-group"><label>조회기간</label><input type="date" id="deptStartDate"> ~ <input type="date" id="deptEndDate"></div>
                            <div class="form-group"><label for="deptReportSelect">부서</label><select id="deptReportSelect"><option value="">전체 부서</option><option value="신약심사부">신약심사부</option><option value="허가총괄부">허가총괄부</option><option value="생물의약품부">생물의약품부</option><option value="품질안전부">품질안전부</option><option value="임상정책부">임상정책부</option></select></div>
                            <div class="form-group"><label for="deptAuditorInput">심사자</label><input type="text" id="deptAuditorInput" placeholder="심사자 이름을 입력하세요 (예: 홍길동, 김철수)"></div>
                            <button type="submit" class="btn btn-search">조회</button><button type="reset" class="btn btn-secondary">초기화</button>
                        </form>
                    </div>
                    <div class="action-area" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span id="departmentReportSummary"></span>
                        <div><button id="departmentExcelBtn" class="btn btn-primary">엑셀 다운로드</button><button id="departmentPrintBtn" class="btn btn-secondary">인쇄</button></div>
                    </div>
                    <div class="table-container">
                        <table id="reportTable">
                            <thead><tr>
                                <th>부서</th>
                                <th>성명</th>
                                <th>교육사업명</th>
                                <th>세부과정(프로그램)명</th>
                                <th>교육기간</th>
                                <th>이수일자</th>
                                <th>필수여부</th>
                                <th>인정시간</th>
                                <th>상태</th>
                                <th>데이터소스</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </main>
    
    <div id="modal-popup" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-title"></h3><span class="close-btn">&times;</span></div>
            <form id="modal-form">
                <input type="hidden" id="modal-edit-id">
                <div class="modal-body" id="modal-body-content">
                    </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">저장</button>
                    <button type="button" class="btn btn-secondary close-btn-bottom">취소</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>

    <script src="database.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 데이터베이스 및 상태 관리 ---
        let db = {};
        let currentAuditor = null;
        let currentStatus = null;
        let sortState = {};

        // 데이터베이스에서 데이터 로드
        const initData = () => {
            // 별도 데이터베이스 파일에서 데이터 로드
            db = {
                courses: EducationDatabase.courses,
                auditors: EducationDatabase.auditors
            };
            
            // 현재 사용자 설정
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
            } else {
                currentUser = EducationDatabase.users["홍길동"];
            }
        };
                
        
        

        const saveData = () => {
            localStorage.setItem('eduDb', JSON.stringify(db));
            showToast('변경사항이 저장되었습니다.');
        };
        
        // --- UI 렌더링 함수 ---
        const renderAll = () => {
            renderCourseTable();
            renderRecordTable();
        };

        const renderCourseTable = (filterFn = () => true) => {
            const tbody = document.querySelector('#courseTable tbody');
            tbody.innerHTML = '';
            const filteredCourses = db.courses.filter(filterFn);
            
            // 검색 결과 개수 표시
            const searchResultInfo = document.getElementById('searchResultInfo');
            if (searchResultInfo) {
                searchResultInfo.textContent = `검색 결과: ${filteredCourses.length}건`;
            }
            
            if (filteredCourses.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="10" style="text-align: center; padding: 40px; color: var(--muted);">검색 조건에 맞는 교육과정이 없습니다.</td>';
                return;
            }
            
            filteredCourses.forEach(c => {
                const row = tbody.insertRow();
                row.dataset.id = c.id;
                row.style.cursor = 'pointer';
                
                // 데이터 소스 표시
                let dataSourceDisplay = '';
                if (c.dataSource === 'API') {
                    dataSourceDisplay = '<span class="status ok">평가원 교육관리시스템</span>';
                } else if (c.dataSource === 'EXTERNAL') {
                    dataSourceDisplay = '<span class="status wait">외부 교육기관</span>';
                } else {
                    dataSourceDisplay = '<span class="status bad">미분류</span>';
                }
                
                // 관리 버튼 (교육관리자만 수정/삭제 가능)
                let manageButtons = '';
                const currentUser = getCurrentUser();
                const isEducationManager = currentUser && currentUser.role === 'EDUCATION_MANAGER';
                
                if (c.dataSource === 'API') {
                    manageButtons = '<div class="manage-buttons"><button class="btn btn-secondary" style="height:30px;padding:0 10px;" disabled>평가원 데이터</button></div>';
                } else if (isEducationManager) {
                    manageButtons = `
                        <div class="manage-buttons">
                        <button class="btn btn-secondary btn-edit-course" style="height:30px;padding:0 10px;">수정</button>
                        <button class="btn btn-danger btn-delete-course" style="height:30px;padding:0 10px;">삭제</button>
                        </div>`;
                } else {
                    manageButtons = '<div class="manage-buttons"><button class="btn btn-secondary" style="height:30px;padding:0 10px;" disabled>관리 불가</button></div>';
                }
                
                row.innerHTML = `
                    <td>${c.id}</td>
                    <td>${c.name}</td>
                    <td>${c.desc || '교육과정 상세정보'}</td>
                    <td>${c.startDate} ~ ${c.endDate}</td>
                    <td><span class="status ${c.type === '필수' ? 'ok' : 'wait'}">${c.type}</span></td>
                    <td>${c.hours}</td>
                    <td>${dataSourceDisplay}</td>
                    <td>${c.registrant || '-'}</td>
                    <td>${c.regDate}</td>
                    <td>${manageButtons}</td>`;
            });
        };

        // 전역 변수로 현재 표시된 기록들을 저장
        let currentDisplayedRecords = [];

        const renderRecordTable = () => {
            const dept = document.getElementById('deptSelect')?.value || '전체';
            const nameFilter = document.getElementById('auditorNameInput')?.value || '';
            const courseNameFilter = document.getElementById('courseNameSearchInput')?.value || '';
            const courseDescFilter = document.getElementById('courseDescSearchInput')?.value || '';
            const coursePeriodStart = document.getElementById('coursePeriodStartInput')?.value || '';
            const coursePeriodEnd = document.getElementById('coursePeriodEndInput')?.value || '';
            const completionStart = document.getElementById('completionStartInput')?.value || '';
            const completionEnd = document.getElementById('completionEndInput')?.value || '';
            const courseTypeFilter = document.getElementById('courseTypeSearchSelect')?.value || '전체';
            const dataSourceFilter = document.getElementById('dataSourceSearchSelect')?.value || '전체';
            const statusFilter = document.getElementById('statusSelect')?.value || '전체';
            console.log('renderRecordTable 호출 - 부서:', dept, '이름 필터:', nameFilter, '교육사업명 필터:', courseNameFilter, '세부과정명 필터:', courseDescFilter, '교육기간:', coursePeriodStart, '~', coursePeriodEnd, '이수일:', completionStart, '~', completionEnd, '필수여부:', courseTypeFilter, '데이터소스:', dataSourceFilter, '상태 필터:', statusFilter);
            
            const tbody = document.querySelector('#recordTable tbody');
            tbody.innerHTML = '';
            currentDisplayedRecords = []; // 초기화

            // 부서별로 심사자 필터링
            let filteredAuditors = Object.entries(db.auditors);
            console.log('전체 심사자 수:', filteredAuditors.length);
            
            if (dept !== '전체') {
                filteredAuditors = filteredAuditors.filter(([name, auditor]) => 
                    auditor.info.dept === dept
                );
                console.log('부서 필터링 후 심사자 수:', filteredAuditors.length, '부서:', dept);
            }
            
            if (nameFilter) {
                filteredAuditors = filteredAuditors.filter(([name, auditor]) => 
                    name.toLowerCase().includes(nameFilter.toLowerCase())
                );
            }

            if (filteredAuditors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12">검색 결과가 없습니다.</td></tr>';
                return;
            }

            // 부서에 속한 모든 심사자 결과 표시 (이수 기록만)
            filteredAuditors.forEach(([name, auditor]) => {
                let recordsToDisplay = auditor.records.map(r => {
                    const course = db.courses.find(c => c.id === r.courseId);
                    return { 
                        ...r, 
                        // course 정보는 별도 필드로 추가 (ID 충돌 방지)
                        courseName: course?.name,
                        courseDesc: course?.desc,
                        courseStartDate: course?.startDate,
                        courseEndDate: course?.endDate,
                        courseType: course?.type,
                        courseHours: course?.hours,
                        courseRegDate: course?.regDate,
                        courseOrgName: course?.orgName,
                        courseRegistrant: course?.registrant,
                        status: 'completed', 
                        // 원본 approve 값 사용 (없으면 외부 교육기관은 승인대기, API는 승인)
                        approve: (() => {
                            // 원본 데이터에 approve 값이 있으면 그대로 사용
                            if (r.approve !== undefined && r.approve !== null && r.approve !== '') {
                                console.log('Using original approve value:', r.approve, 'for record:', r.id);
                                return r.approve;
                            }
                            // 원본 데이터에 approve 값이 없으면 기본값 설정
                            const result = r.dataSource === 'EXTERNAL' ? '승인대기' : '승인';
                            console.log('Using default approve value:', result, 'for record:', r.id);
                            return result;
                        })(),
                        auditorName: name, 
                        auditorDept: auditor.info.dept, 
                        // 승인대기 상태면 항상 EXTERNAL로 표시, 아니면 원본 dataSource 사용
                        dataSource: (() => {
                            const originalApprove = r.approve;
                            const originalDataSource = r.dataSource;
                            const result = (originalApprove === '승인대기' || originalDataSource === 'EXTERNAL') ? 'EXTERNAL' : (originalDataSource || 'EXTERNAL');
                            console.log('Data source processing for record', r.id, 'originalApprove:', originalApprove, 'originalDataSource:', originalDataSource, 'result:', result);
                            return result;
                        })(),
                        registrant: r.registrant || name
                    };
                });
                
                // 상태 필터링 적용
                if (statusFilter !== '전체') {
                    recordsToDisplay = recordsToDisplay.filter(rec => {
                        if (statusFilter === '승인완료') {
                            return rec.approve === '승인';
                        } else if (statusFilter === '승인대기') {
                            return rec.approve === '승인대기';
                        } else if (statusFilter === '반려') {
                            return rec.approve === '반려';
                        } else if (statusFilter === '자동승인') {
                            return rec.approve === '승인' && rec.dataSource === 'API';
                        }
                        return true;
                    });
                }
                
                // 교육사업명 필터링
                if (courseNameFilter) {
                    recordsToDisplay = recordsToDisplay.filter(rec => 
                        rec.courseName && rec.courseName.toLowerCase().includes(courseNameFilter.toLowerCase())
                    );
                }
                
                // 세부과정명 필터링
                if (courseDescFilter) {
                    recordsToDisplay = recordsToDisplay.filter(rec => 
                        rec.courseDesc && rec.courseDesc.toLowerCase().includes(courseDescFilter.toLowerCase())
                    );
                }
                
                // 교육기간 필터링
                if (coursePeriodStart || coursePeriodEnd) {
                    recordsToDisplay = recordsToDisplay.filter(rec => {
                        if (!rec.courseStartDate && !rec.courseEndDate) return false;
                        
                        const courseStart = rec.courseStartDate;
                        const courseEnd = rec.courseEndDate;
                        
                        if (coursePeriodStart && courseEnd && courseEnd < coursePeriodStart) return false;
                        if (coursePeriodEnd && courseStart && courseStart > coursePeriodEnd) return false;
                        
                        return true;
                    });
                }
                
                // 이수일 필터링
                if (completionStart || completionEnd) {
                    recordsToDisplay = recordsToDisplay.filter(rec => {
                        if (!rec.date) return false;
                        
                        const completionDate = rec.date;
                        
                        if (completionStart && completionDate < completionStart) return false;
                        if (completionEnd && completionDate > completionEnd) return false;
                        
                        return true;
                    });
                }
                
                // 필수여부 필터링
                if (courseTypeFilter !== '전체') {
                    recordsToDisplay = recordsToDisplay.filter(rec => 
                        rec.courseType === courseTypeFilter
                    );
                }
                
                // 데이터 소스 필터링
                if (dataSourceFilter !== '전체') {
                    recordsToDisplay = recordsToDisplay.filter(rec => 
                        rec.dataSource === dataSourceFilter
                    );
                }
                
                recordsToDisplay.forEach((rec, index) => {
                    const row = tbody.insertRow();
                    
                    // database.js에서 uniqueId 가져오기
                    const recordUniqueId = rec.uniqueId || `row_${name.replace(/\s+/g, '')}_${rec.id}`;
                    
                    // 고유한 row ID 생성 (문자+숫자 형태)
                    const rowId = `${recordUniqueId}_${index}`;
                    row.id = rowId;
                    
                    row.dataset.id = rec.id;
                    row.dataset.courseId = rec.courseId;
                    row.dataset.approve = rec.approve || '승인';
                    
                    // 원본 기록 ID를 보존하기 위해 originalId 추가 (심사자별 고유 ID)
                    const recordWithOriginalId = {
                        ...rec,
                        originalId: `${name}_${rec.id}` // 심사자명_원본ID로 고유 ID 생성
                    };
                    
                    // 현재 표시된 기록에 추가
                    currentDisplayedRecords.push(recordWithOriginalId);
                    
                    // 상태 표시 (승인/반려/대기)
                    let statusDisplay = '-';
                    if (rec.status === 'completed') {
                        if (rec.approve === '승인') {
                            statusDisplay = '<span class="status ok">승인</span>';
                        } else if (rec.approve === '반려') {
                            statusDisplay = '<span class="status bad">반려</span>';
                        } else {
                            statusDisplay = '<span class="status wait">승인대기</span>';
                        }
                    }
                    
                    // 관리 버튼 (권한에 따라 다르게 표시)
                    let manageButtons = '-';
                    const currentUser = getCurrentUser();
                    const isEducationManager = currentUser && currentUser.role === 'EDUCATION_MANAGER';
                    const isOwnRecord = rec.auditorName === currentUser?.userName;
                    
                    if (rec.status === 'completed') {
                        if (rec.dataSource === 'API') {
                            manageButtons = '<div class="manage-buttons"><button class="btn btn-secondary" style="height:28px;padding:0 8px;font-size:12px;" disabled>API 데이터</button></div>';
                        } else if (rec.approve === '승인대기') {
                            // 승인대기 상태인 경우
                            if (isEducationManager) {
                                // 교육관리 권한이 있으면 승인, 반려, 수정, 삭제 모두 가능
                            manageButtons = `
                                <div class="manage-buttons">
                                    <button class="btn btn-primary btn-approve-record" style="height:28px;padding:0 8px;font-size:12px;">승인</button>
                                    <button class="btn btn-danger btn-reject-record" style="height:28px;padding:0 8px;font-size:12px;">반려</button>
                                    <button class="btn btn-secondary btn-edit-record" style="height:28px;padding:0 8px;font-size:12px;">수정</button>
                                        <button class="btn btn-danger btn-delete-record" style="height:28px;padding:0 8px;font-size:12px;">삭제</button>
                                    </div>
                                    <div class="click-hint" style="font-size:11px;color:var(--muted);margin-top:4px;">
                                        💡 행을 클릭하여 증빙자료 확인
                                    </div>`;
                            } else if (isOwnRecord) {
                                // 본인 기록이면 수정만 가능
                                manageButtons = `
                                    <div class="manage-buttons">
                                        <button class="btn btn-secondary btn-edit-record" style="height:28px;padding:0 8px;font-size:12px;">수정</button>
                                </div>
                                <div class="click-hint" style="font-size:11px;color:var(--muted);margin-top:4px;">
                                    💡 행을 클릭하여 증빙자료 확인
                                </div>`;
                        } else {
                                // 다른 사람의 승인대기 기록은 관리 불가
                                manageButtons = '<div class="manage-buttons"><button class="btn btn-secondary" style="height:28px;padding:0 8px;font-size:12px;" disabled>관리 불가</button></div>';
                            }
                        } else {
                            // 승인 또는 반려된 기록
                            if (isEducationManager) {
                                // 교육관리 권한이 있으면 삭제 가능
                            manageButtons = `
                                <div class="manage-buttons">
                                    <button class="btn btn-danger btn-delete-record" style="height:28px;padding:0 8px;font-size:12px;">삭제</button>
                                </div>`;
                            } else if (isOwnRecord) {
                                // 본인 기록이면 삭제 가능
                                manageButtons = `
                                    <div class="manage-buttons">
                                        <button class="btn btn-danger btn-delete-record" style="height:28px;padding:0 8px;font-size:12px;">삭제</button>
                                    </div>`;
                            } else {
                                // 다른 사람의 승인/반려 기록은 관리 불가
                                manageButtons = '<div class="manage-buttons"><button class="btn btn-secondary" style="height:28px;padding:0 8px;font-size:12px;" disabled>관리 불가</button></div>';
                            }
                        }
                    }
                    
                    // 데이터 소스 표시 (승인대기 상태면 항상 외부 교육기관으로 표시)
                    let dataSourceDisplay = '';
                    if (rec.approve === '승인대기') {
                        dataSourceDisplay = '<span class="status wait">외부 교육기관</span>';
                    } else if (rec.dataSource === 'API') {
                        dataSourceDisplay = '<span class="status ok">평가원 교육관리시스템</span>';
                    } else if (rec.dataSource === 'EXTERNAL') {
                        dataSourceDisplay = '<span class="status wait">외부 교육기관</span>';
                    } else {
                        dataSourceDisplay = '<span class="status bad">미분류</span>';
                    }
                    
                    row.innerHTML = `
                        <td>${recordUniqueId}</td>
                        <td>${rec.auditorDept || '-'}</td>
                        <td>${rec.auditorName || '-'}</td>
                        <td>${rec.courseName || '-'}</td>
                        <td>${rec.courseDesc || '-'}</td>
                        <td>${rec.courseStartDate ? `${rec.courseStartDate} ~ ${rec.courseEndDate}` : '-'}</td>
                        <td>${rec.date || '-'}</td>
                        <td><span class="status ${rec.courseType === '필수' ? 'ok' : 'wait'}">${rec.courseType || '-'}</span></td>
                        <td>${rec.courseHours || 0}</td>
                        <td>${dataSourceDisplay}</td>
                        <td>${rec.registrant || '-'}</td>
                        <td>${statusDisplay}</td>
                        <td>${manageButtons}</td>`;
                });
            });
        };

        // 개인별 보고서 렌더링
        const renderPersonalReport = (startDate, endDate, deptFilter, auditorName) => {
            console.log('=== 개인별 보고서 렌더링 시작 ===');
            console.log('startDate:', startDate, 'endDate:', endDate, 'deptFilter:', deptFilter, 'auditorName:', auditorName);
            
            const tbody = document.querySelector('#personalReportTable tbody');
            if (!tbody) {
                console.error('personalReportTable tbody를 찾을 수 없습니다');
                return;
            }
            tbody.innerHTML = '';

            let count = 0;
            let totalHours = 0;
            let completedCount = 0;

            // 부서별로 모든 심사자 검색
            Object.entries(db.auditors).forEach(([name, auditor]) => {
                // 부서 필터링
                const deptMatch = !deptFilter || deptFilter === '' ? true : auditor.info.dept === deptFilter;
                // 심사자 이름 필터링
                const nameMatch = !auditorName || auditorName === '' ? true : name.toLowerCase().includes(auditorName.toLowerCase());
                
                console.log(`심사자 ${name}: 부서=${auditor.info.dept}, deptFilter=${deptFilter}, deptMatch=${deptMatch}, nameMatch=${nameMatch}`);
                
                if (auditor.records && deptMatch && nameMatch) {
            auditor.records.forEach(record => {
                const course = db.courses.find(c => c.id === record.courseId);
                if (course) {
                    const recordDate = record.date;
                    const isInRange = (!startDate || recordDate >= startDate) && (!endDate || recordDate <= endDate);
                    const isApproved = record.approve === '승인';
                    
                    if (isInRange && isApproved) {
                        const row = tbody.insertRow();
                        
                        // 고유한 row ID 생성 (문자+숫자 형태)
                        const rowId = `report_row_${name.replace(/\s+/g, '')}_${record.id}_${Date.now()}`;
                        row.id = rowId;
                        
                        // database.js에서 uniqueId 가져오기
                        const recordUniqueId = record.uniqueId || `row_${name.replace(/\s+/g, '')}_${record.id}`;
                        
                        row.innerHTML = `
                            <td>${recordUniqueId}</td>
                            <td>${auditor.info.dept}</td>
                            <td>${name}</td>
                            <td>${course.name}</td>
                            <td>${course.desc || '-'}</td>
                            <td>${course.startDate ? `${course.startDate} ~ ${course.endDate}` : '-'}</td>
                            <td>${recordDate}</td>
                            <td>${course.hours}시간</td>
                            <td><span class="status ${record.approve === '승인' ? 'ok' : record.approve === '반려' ? 'error' : 'wait'}">${record.approve || '승인대기'}</span></td>
                            <td>${record.dataSource === 'API' ? '평가원 교육관리시스템' : '외부 교육기관'}</td>
                        `;
                        count++;
                        totalHours += course.hours;
                        completedCount++;
                    }
                }
                    });
                }
            });

            if (count === 0) {
                tbody.innerHTML = '<tr><td colspan="10">검색 조건에 맞는 이수 기록이 없습니다.</td></tr>';
            }

            document.getElementById('personalReportSummary').innerHTML = `
                <strong>검색 결과:</strong> 총 ${count}건 | 
                <strong>총 이수시간:</strong> ${totalHours}시간 | 
                <strong>승인 완료:</strong> ${completedCount}건
            `;
        };

        // 부서별 보고서 렌더링
        const renderDepartmentReport = (startDate, endDate, deptFilter, auditorName) => {
            console.log('=== 부서별 보고서 렌더링 시작 ===');
            console.log('startDate:', startDate, 'endDate:', endDate, 'deptFilter:', deptFilter, 'auditorName:', auditorName);
            console.log('deptFilter type:', typeof deptFilter, 'deptFilter === "":', deptFilter === '', 'deptFilter === "전체":', deptFilter === '전체');
            
            const tbody = document.querySelector('#reportTable tbody');
            if (!tbody) {
                console.error('reportTable tbody를 찾을 수 없습니다');
                return;
            }
            tbody.innerHTML = '';

            let count = 0;
            let totalHours = 0;
            let completedCount = 0;
            const deptStats = {};
            const participantStats = {}; // 참여자별 통계

            Object.entries(db.auditors).forEach(([name, auditor]) => {
                // 부서 필터링 (전체 부서 또는 빈 값일 때는 모든 부서 포함)
                const deptMatch = !deptFilter || deptFilter === '' || deptFilter === '전체' ? true : auditor.info.dept === deptFilter;
                // 심사자 이름 필터링
                const nameMatch = !auditorName || auditorName === '' ? true : name.toLowerCase().includes(auditorName.toLowerCase());
                
                console.log(`심사자 ${name}: 부서=${auditor.info.dept}, deptFilter=${deptFilter}, deptMatch=${deptMatch}, nameMatch=${nameMatch}, records=${auditor.records ? auditor.records.length : 0}`);
                
                if (auditor.records && deptMatch && nameMatch) {
                    if (!deptStats[auditor.info.dept]) {
                        deptStats[auditor.info.dept] = { total: 0, completed: 0, hours: 0 };
                    }

                    auditor.records.forEach(record => {
                        const course = db.courses.find(c => c.id === record.courseId);
                        if (course) {
                            const recordDate = record.date;
                            const isInRange = (!startDate || recordDate >= startDate) && (!endDate || recordDate <= endDate);
                            const isApproved = record.approve === '승인';
                            
                            if (isInRange && isApproved) {
                                const row = tbody.insertRow();
                                
                                // database.js에서 uniqueId 가져오기
                                const recordUniqueId = record.uniqueId || `row_${name.replace(/\s+/g, '')}_${record.id}`;
                                
                                // 고유한 row ID 생성 (문자+숫자 형태)
                                const rowId = `dept_report_${recordUniqueId}_${Date.now()}`;
                                row.id = rowId;
                                
                                row.innerHTML = `
                                    <td>${auditor.info.dept}</td>
                                    <td>${name}</td>
                                    <td>${course.name}</td>
                                    <td>${course.desc || '-'}</td>
                                    <td>${course.startDate ? `${course.startDate} ~ ${course.endDate}` : '-'}</td>
                                    <td>${recordDate}</td>
                                    <td><span class="status ${course.type === '필수' ? 'ok' : 'wait'}">${course.type || '-'}</span></td>
                                    <td>${course.hours}시간</td>
                                    <td><span class="status ${record.approve === '승인' ? 'ok' : record.approve === '반려' ? 'error' : 'wait'}">${record.approve || '승인대기'}</span></td>
                                    <td>${record.dataSource === 'API' ? '평가원 교육관리시스템' : '외부 교육기관'}</td>
                                `;
                                count++;
                                totalHours += course.hours;
                                deptStats[auditor.info.dept].total++;
                                deptStats[auditor.info.dept].hours += course.hours;
                                completedCount++;
                                deptStats[auditor.info.dept].completed++;
                                
                                // 참여자별 통계 계산
                                if (!participantStats[name]) {
                                    participantStats[name] = {
                                        dept: auditor.info.dept,
                                        totalHours: 0,
                                        recordCount: 0
                                    };
                                }
                                participantStats[name].totalHours += course.hours;
                                participantStats[name].recordCount++;
                            }
                        }
                    });
                }
            });

            if (count === 0) {
                tbody.innerHTML = '<tr><td colspan="10">검색 조건에 맞는 이수 기록이 없습니다.</td></tr>';
            }

            const totalParticipants = Object.keys(participantStats).length;
            let summaryText = `<strong>검색 결과:</strong> 총 ${count}건 | <strong>총 참여자수:</strong> ${totalParticipants}명 | <strong>총 이수시간:</strong> ${totalHours}시간 | <strong>승인 완료:</strong> ${completedCount}건`;
            
            // 참여자별 총 이수 시간 표시
            if (totalParticipants > 0) {
                summaryText += '<br><strong>참여자별 총 이수시간:</strong> ';
                summaryText += Object.entries(participantStats)
                    .sort((a, b) => b[1].totalHours - a[1].totalHours) // 이수시간 순으로 정렬
                    .map(([name, stats]) => `${name}(${stats.dept}) ${stats.totalHours}시간`)
                    .join(' | ');
            }
            
            if (Object.keys(deptStats).length > 1) {
                summaryText += '<br><strong>부서별 현황:</strong> ';
                summaryText += Object.entries(deptStats).map(([dept, stats]) => 
                    `${dept} ${stats.completed}/${stats.total}건 (${stats.hours}시간)`
                ).join(' | ');
            }

            document.getElementById('departmentReportSummary').innerHTML = summaryText;
        };


        // --- 이수 기록 상세 모달 관리 ---
        const showRecordDetailsModal = (record) => {
            console.log('showRecordDetailsModal called with record:', record);
            console.log('Record approve status:', record.approve);
            console.log('Record dataSource:', record.dataSource);
            
            // 교육과정 정보 찾기
            const course = db.courses.find(c => c.id === record.courseId);
            console.log('Found course:', course);
            
            // 심사자 정보 찾기 - record에 auditorName이 있으면 사용, 없으면 찾기
            let auditor = null;
            let auditorName = record.auditorName;
            
            if (auditorName && db.auditors[auditorName]) {
                auditor = db.auditors[auditorName];
                console.log('Found auditor by auditorName:', auditor);
                } else {
                // auditorName이 없으면 모든 심사자에서 해당 기록을 찾기
                for (const [name, aud] of Object.entries(db.auditors)) {
                    if (aud.records && aud.records.find(r => r.id === record.id)) {
                        auditor = aud;
                        auditorName = name;
                        console.log('Found auditor by searching records:', auditor, 'name:', name);
                        break;
                    }
                }
            }
            console.log('Final auditor:', auditor);
            console.log('Final auditorName:', auditorName);
            
            const modalContent = `
                <div class="approval-info">
                    <h4>이수 기록 상세 정보</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>심사자명:</label>
                            <span>${auditorName || auditor?.info?.name || record.auditorName || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>부서:</label>
                            <span>${auditor?.info?.dept || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>교육사업명:</label>
                            <span>${course?.name || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>세부과정(프로그램)명:</label>
                            <span>${course?.desc || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>교육기간:</label>
                            <span>${course?.startDate ? `${course.startDate} ~ ${course.endDate}` : '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>이수일자:</label>
                            <span>${record.date || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>교육기관:</label>
                            <span>${course?.orgName || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>인정시간:</label>
                            <span>${course?.hours || 0}시간</span>
                        </div>
                        <div class="info-item">
                            <label>등록자:</label>
                            <span>${record.registrant || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>상태:</label>
                            <span>${record.approve || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>데이터 소스:</label>
                            <span>${record.approve === '승인대기' ? '외부 교육기관' : (record.dataSource === 'API' ? '평가원 교육관리시스템' : '외부 교육기관')}</span>
                        </div>
                    </div>
                    
                    <div class="evidence-section">
                        <h4>증빙자료</h4>
                        <div class="evidence-content">
                            ${record.notes ? `
                                <div class="evidence-item">
                                    <label>비고/상세내용:</label>
                                    <div class="evidence-text">${record.notes}</div>
                                </div>
                            ` : ''}
                            <div class="evidence-item">
                                <label>첨부파일:</label>
                                <div class="file-info">
                                    ${record.fileName ? `
                                        <span class="file-name">📎 ${record.fileName}</span>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="downloadFile('${record.fileName}')">다운로드</button>
                                    ` : '<span class="no-file">첨부된 파일이 없습니다.</span>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${(() => {
                        const shouldShowButtons = record.approve !== '승인' || record.dataSource === 'EXTERNAL';
                        console.log('=== BUTTON DEBUG ===');
                        console.log('Record ID:', record.id);
                        console.log('Record approve:', record.approve, '(type:', typeof record.approve, ')');
                        console.log('Record dataSource:', record.dataSource);
                        console.log('Should show buttons:', shouldShowButtons);
                        console.log('===================');
                        
                        if (!shouldShowButtons) {
                            return `<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 4px;">
                                <strong>디버그 정보:</strong><br>
                                승인 상태: "${record.approve}"<br>
                                데이터 소스: "${record.dataSource}"<br>
                                버튼 표시 조건: 승인이 아닌 경우 또는 EXTERNAL 데이터<br>
                                <em>승인/반려 버튼이 표시되지 않습니다.</em>
                            </div>`;
                        }
                        
                        // 승인 또는 반려가 완료된 경우 버튼을 숨김
                        if (record.approve === '승인' || record.approve === '반려') {
                            return `
                                <div class="approval-actions">
                                    <h4>처리 결과</h4>
                                    <div class="status-info">
                                        <p><strong>처리 상태:</strong> <span class="status ${record.approve === '승인' ? 'ok' : 'bad'}">${record.approve}</span></p>
                                        <p><em>처리가 완료되어 추가 작업이 불가능합니다.</em></p>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // 승인대기 상태인 경우 작성자만 수정 가능
                        if (record.approve === '승인대기') {
                            const currentUser = getCurrentUser();
                            const isAuthor = record.auditorName === currentUser.userName || record.registrant === currentUser.userName;
                            
                            if (isAuthor) {
                                return `
                                    <div class="approval-actions">
                                        <h4>처리 결과</h4>
                                        <div class="action-buttons">
                                            <button type="button" class="btn btn-primary" onclick="editRecord(${record.id})">
                                                ✏️ 내용 수정
                                            </button>
                                        </div>
                                        <div class="status-info" style="margin-top: 15px;">
                                            <p><strong>처리 상태:</strong> <span class="status wait">승인대기</span></p>
                                            <p><em>승인 대기 중입니다. 작성자는 내용을 수정할 수 있습니다.</em></p>
                                        </div>
                                    </div>
                                `;
                            } else {
                                return `
                                    <div class="approval-actions">
                                        <h4>처리 결과</h4>
                                        <div class="status-info">
                                            <p><strong>처리 상태:</strong> <span class="status wait">승인대기</span></p>
                                            <p><em>승인 대기 중입니다. 작성자만 수정할 수 있습니다.</em></p>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                        
                        return `
                            <div class="approval-actions">
                                <h4>처리 결과</h4>
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-success" onclick="processApproval('${record.id}', '승인')">
                                        ✅ 승인 처리
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="processApproval('${record.id}', '반려')">
                                        ❌ 반려 처리
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="deleteRecord('${record.id}')">
                                        🗑️ 이수 삭제
                                    </button>
                                </div>
                            </div>
                        `;
                    })()}
                </div>
            `;
            
            console.log('Opening record details modal');
            openModal('이수 기록 상세 정보', modalContent, { dataSource: record.dataSource });
        };

        // --- 승인/반려 모달 관리 ---
        const showApprovalModal = (record, action) => {
            console.log('showApprovalModal called with record:', record);
            console.log('showApprovalModal called with action:', action);
            
            // 간단한 테스트용 모달 내용
            const modalContent = `
                <div class="approval-info">
                    <h4>이수 기록 상세 정보</h4>
                    <p><strong>심사자명:</strong> ${record.auditorName || '-'}</p>
                    <p><strong>교육 ID:</strong> ${record.courseId || '-'}</p>
                    <p><strong>이수일자:</strong> ${record.date || '-'}</p>
                    <p><strong>상태:</strong> ${record.approve || '-'}</p>
                    <p><strong>비고:</strong> ${record.notes || '없음'}</p>
                    <p><strong>파일:</strong> ${record.fileName || '없음'}</p>
                    
                    <div class="approval-actions">
                        <h4>처리 결과</h4>
                        <div class="action-buttons">
                            ${action === 'approve' ? `
                                <button type="button" class="btn btn-success" onclick="processApproval('${record.id}', '승인')">
                                    ✅ 승인 처리
                                </button>
                                <button type="button" class="btn btn-danger" onclick="deleteRecord('${record.id}')">
                                    🗑️ 이수 삭제
                                </button>
                            ` : `
                                <button type="button" class="btn btn-danger" onclick="processApproval('${record.id}', '반려')">
                                    ❌ 반려 처리
                                </button>
                                <button type="button" class="btn btn-danger" onclick="deleteRecord('${record.id}')">
                                    🗑️ 이수 삭제
                                </button>
                            `}
                    </div>
                    </div>
                </div>
            `;
            
            console.log('Opening approval modal with action:', action);
            console.log('Modal content length:', modalContent.length);
            openModal(`${action === 'approve' ? '승인' : '반려'} 처리`, modalContent);
        };

        // 승인/반려 처리 함수
        window.processApproval = (recordId, action) => {
            try {
            console.log('=== PROCESS APPROVAL DEBUG ===');
            console.log('processApproval called with recordId:', recordId, 'action:', action);
                console.log('recordId type:', typeof recordId);
                
                // 즉시 알림으로 함수 호출 확인
                alert('processApproval 함수가 호출되었습니다. ID: ' + recordId + ', Action: ' + action);
                
                console.log('db.auditors:', db.auditors);
                
                // 모든 심사자에서 해당 ID의 기록을 직접 찾기
                let foundRecord = null;
                let foundAuditor = null;
                
                for (const [auditorName, auditor] of Object.entries(db.auditors)) {
                    console.log('Checking auditor:', auditorName, 'has records:', !!auditor.records);
                        if (auditor.records) {
                        console.log('Records in', auditorName, ':', auditor.records.map(r => ({ id: r.id, approve: r.approve })));
                        const record = auditor.records.find(r => {
                            const match = String(r.id) === String(recordId);
                            console.log('Comparing:', r.id, 'with', recordId, 'match:', match);
                            return match;
                        });
                        
                        if (record) {
                            foundRecord = record;
                            foundAuditor = auditorName;
                            console.log('Found record in auditor:', auditorName, 'record:', record);
                                break;
                            }
                        }
                    }
                
                if (!foundRecord) {
                    console.error('Record not found in database');
                    console.log('Searched for recordId:', recordId);
                    console.log('Available records:', Object.values(db.auditors).flatMap(a => a.records?.map(r => r.id) || []));
                    alert('기록을 찾을 수 없습니다. ID: ' + recordId);
                    return;
                }
                
                console.log('Processing approval for record:', foundRecord, 'in auditor:', foundAuditor);
                
                // 찾은 기록을 직접 수정
                const oldApprove = foundRecord.approve;
                foundRecord.approve = action;
                console.log('Updated record approve status from', oldApprove, 'to:', action);
                
                // 데이터 저장 및 화면 갱신
                console.log('Saving data...');
                    saveData();
                console.log('Rendering all...');
                    renderAll();
                console.log('Closing modal...');
                    closeModal();
                console.log('Showing toast...');
                    showToast(`이수 기록이 ${action} 처리되었습니다.`);
                    
                console.log('Approval process completed successfully');
                
            } catch (error) {
                console.error('Error in processApproval:', error);
                alert('승인/반려 처리 중 오류가 발생했습니다: ' + error.message);
            }
        };


        // 이수 기록 수정 함수 (승인대기 상태에서 작성자가 사용)
        window.editRecord = (recordId) => {
            console.log('editRecord called with recordId:', recordId);
            
            // 현재 표시된 기록에서 찾기
            const displayedRecord = currentDisplayedRecords.find(r => r.id === recordId);
            console.log('Found displayed record for edit:', displayedRecord);
            
            if (displayedRecord) {
                // 교육과정 옵션 생성 (외부 교육기관만)
                const courseOptions = db.courses
                    .filter(c => c.dataSource === 'EXTERNAL')
                    .map(c => `<option value="${c.id}" ${c.id === displayedRecord.courseId ? 'selected' : ''}>${c.name}</option>`)
                    .join('');
                
                const formHtml = `
                    <input type="hidden" id="modal-recordId" name="recordId" value="${displayedRecord.id}">
                    <div class="form-group">
                        <label for="modal-auditorName">심사자</label>
                        <input type="text" id="modal-auditorName" name="auditorName" value="${displayedRecord.auditorName}" readonly style="background-color: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label for="modal-courseId">교육과정</label>
                        <select id="modal-courseId" name="courseId" required>${courseOptions}</select>
                    </div>
                    <div class="form-group">
                        <label for="modal-date">이수일자</label>
                        <input type="date" id="modal-date" name="date" value="${displayedRecord.date}" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-file">증빙자료</label>
                        <input type="file" id="modal-file" name="file">
                        ${displayedRecord.fileName ? `<p style="font-size: 12px; color: var(--muted); margin-top: 5px;">현재 파일: ${displayedRecord.fileName}</p>` : ''}
                    </div>
                    <div class="form-group">
                        <label for="modal-notes">비고</label>
                        <textarea id="modal-notes" name="notes" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;" placeholder="교육 내용 요약이나 특이사항을 입력하세요">${displayedRecord.notes || ''}</textarea>
                    </div>
                `;
                
                openModal('이수 기록 수정', formHtml);
            } else {
                console.error('Could not find displayed record for edit');
                showToast('수정할 기록을 찾을 수 없습니다.');
            }
        };

        // 이수 기록 삭제 함수
        window.deleteRecord = (recordId) => {
            console.log('deleteRecord called with recordId:', recordId);
            
            // 현재 표시된 기록에서 찾기 (원본 ID 사용)
            const displayedRecord = currentDisplayedRecords.find(r => r.id === recordId);
            console.log('Found displayed record for deletion:', displayedRecord);
            
            if (displayedRecord) {
                const courseName = displayedRecord.courseName || '알 수 없는 교육';
                const auditorName = displayedRecord.auditorName || '알 수 없는 심사자';
                
                if (confirm(`'${courseName}' 이수 기록을 삭제하시겠습니까?\n심사자: ${auditorName}`)) {
                    // 원본 데이터에서 해당 기록을 찾아서 삭제
                    let found = false;
                    
                    // displayedRecord에서 실제 원본 기록의 ID 찾기
                    const actualRecordId = displayedRecord.id;
                    const actualAuditorName = displayedRecord.auditorName;
                    console.log('Looking for original record to delete with ID:', actualRecordId, 'in auditor:', actualAuditorName);
                    
                    // 특정 심사자에서 먼저 찾기
                    if (actualAuditorName && db.auditors[actualAuditorName] && db.auditors[actualAuditorName].records) {
                        const recordIndex = db.auditors[actualAuditorName].records.findIndex(r => r.id === actualRecordId);
                        if (recordIndex !== -1) {
                            db.auditors[actualAuditorName].records.splice(recordIndex, 1);
                            console.log('Deleted record from auditor:', actualAuditorName);
                            found = true;
                        }
                    }
                    
                    // 특정 심사자에서 찾지 못했다면 모든 심사자에서 찾기
                    if (!found) {
                        for (const [name, auditor] of Object.entries(db.auditors)) {
                            if (auditor.records) {
                                const recordIndex = auditor.records.findIndex(r => r.id === actualRecordId);
                                if (recordIndex !== -1) {
                                    auditor.records.splice(recordIndex, 1);
                                    console.log('Deleted record from auditor:', name);
                                    found = true;
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (found) {
                        saveData();
                        renderAll();
                        closeModal();
                        showToast('이수 기록이 삭제되었습니다.');
                    } else {
                        console.error('Could not find original record to delete');
                        showToast('기록을 찾을 수 없습니다.');
                    }
                }
            } else {
                console.error('Could not find displayed record for deletion');
                showToast('기록을 찾을 수 없습니다.');
            }
        };

        // 파일 다운로드 함수 (시뮬레이션)
        window.downloadFile = (fileName) => {
            showToast(`파일 다운로드: ${fileName} (시뮬레이션)`);
        };

        // --- 모달 관리 ---
        const openModal = (title, content, data = null) => {
            console.log('openModal called with title:', title);
        const modal = document.getElementById('modal-popup');
        const modalTitle = document.getElementById('modal-title');
        const modalFooter = document.querySelector('.modal-footer');
        
            console.log('Modal element:', modal);
            console.log('Modal title element:', modalTitle);
        
            if (modalTitle) {
            modalTitle.textContent = title;
            }
            
            const modalBody = document.getElementById('modal-body-content');
            console.log('Modal body element:', modalBody);
            if (modalBody) {
                modalBody.innerHTML = content;
            }
            
            // 데이터 소스가 API인 경우, 상세 정보 모달인 경우, 또는 승인/반려 처리 모달인 경우 모달 푸터 숨기기
            if ((data && data.dataSource === 'API' && title === '이수 기록 상세 정보') || 
                title === '이수 기록 상세 정보' || 
                title === '교육과정 상세보기' ||
                title === '승인 처리' || 
                title === '반려 처리') {
                if (modalFooter) {
                    modalFooter.style.display = 'none';
                }
            } else {
                if (modalFooter) {
                    modalFooter.style.display = 'block';
                }
            }
            
            if (data) {
                Object.keys(data).forEach(key => {
                    const input = document.getElementById(`modal-${key}`);
                    if (input) input.value = data[key];
                });
            }
            
            if (modal) {
            modal.style.display = 'block';
                console.log('Modal displayed');
            } else {
                console.error('Modal element not found!');
            }
        };
        
        const closeModal = () => {
            const modal = document.getElementById('modal-popup');
            modal.style.display = 'none';
            document.getElementById('modal-form').reset();
        };
        
        // 모달 닫기 이벤트
        document.querySelectorAll('.close-btn, .close-btn-bottom').forEach(btn => {
            btn.addEventListener('click', closeModal);
        });
        
        // 모달 외부 클릭 시 닫기
        document.getElementById('modal-popup').addEventListener('click', (e) => {
            if (e.target.id === 'modal-popup') closeModal();
        });
        
        // 모달 폼 제출 이벤트
        document.getElementById('modal-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {};
            formData.forEach((value, key) => data[key] = value);
            
            // 모달 제목에 따라 다른 저장 로직 실행
            const modalTitle = document.getElementById('modal-title').textContent;
            
            if (modalTitle === '신규 이수 기록 등록' || modalTitle === '내 이수 기록 등록' || modalTitle === '이수 기록 등록 (관리자)') {
                // 선택된 교육과정의 데이터 소스 확인
                const selectedCourse = db.courses.find(c => c.id === parseInt(data.courseId));
                const isApiCourse = selectedCourse && selectedCourse.dataSource === 'API';
                
                // 파일명 추출
                const fileInput = document.getElementById('modal-file');
                const fileName = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0].name : null;
                
                // 심사자 정보 처리 (관리자인 경우)
                let auditorName = data.auditorName;
                let auditorDept = data.auditorDept;
                
                // 관리자가 새로운 심사자를 등록하는 경우
                if (modalTitle === '이수 기록 등록 (관리자)') {
                    if (!auditorName || !auditorDept) {
                        showToast('심사자 이름과 부서를 모두 입력해주세요.');
                        return;
                    }
                    
                    // 심사자가 존재하지 않으면 생성
                    if (!db.auditors[auditorName]) {
                        db.auditors[auditorName] = {
                            info: {
                                name: auditorName,
                                dept: auditorDept,
                                rank: '심사원' // 기본값
                            },
                            records: []
                        };
                        saveData();
                    }
                }
                
                // 새로운 이수 기록 저장
                const newRecord = {
                    id: Date.now(), // 고유 ID 생성
                    courseId: parseInt(data.courseId),
                    date: data.date,
                    approve: data.status || (isApiCourse ? '승인' : '승인대기'), // 폼에서 선택한 상태 사용, 없으면 기본값
                    dataSource: isApiCourse ? 'API' : 'EXTERNAL',
                    registrant: auditorName,
                    auditorName: auditorName, // 심사자 이름 추가
                    notes: data.notes || '',
                    fileName: fileName
                };
                
                if (!db.auditors[auditorName]) {
                    showToast('존재하지 않는 심사자입니다.');
                    return;
                }
                
                db.auditors[auditorName].records.push(newRecord);
                saveData();
                renderRecordTable();
                
                if (isApiCourse) {
                    showToast('이수 기록이 등록되었습니다. (평가원 교육관리시스템 교육과정으로 자동 승인 처리됨)');
                } else {
                    showToast('이수 기록이 등록되었습니다. (외부 교육기관 교육과정으로 승인대기 상태)');
                }
                
                closeModal();
                
            } else if (modalTitle === '신규 교육과정 등록') {
                // 새로운 교육과정 저장 (외부 교육기관 등록)
                const newCourse = {
                    id: Math.max(...db.courses.map(c => c.id)) + 1,
                    name: data.name,
                    desc: data.desc,
                    startDate: data.startDate,
                    endDate: data.endDate,
                    type: data.type,
                    hours: parseInt(data.hours),
                    regDate: data.regDate,
                    dataSource: 'EXTERNAL',
                    orgName: data.orgName,
                    registrant: data.registrant
                };
                db.courses.push(newCourse);
                saveData();
                renderAll();
                showToast('교육과정이 등록되었습니다.');
                closeModal();
                
            } else if (modalTitle === '교육과정 수정') {
                // 교육과정 수정
                const editId = document.getElementById('modal-edit-id').value;
                const course = db.courses.find(c => c.id == editId);
                if (course) {
                    Object.assign(course, {
                        name: data.name,
                        desc: data.desc,
                        startDate: data.startDate,
                        endDate: data.endDate,
                        type: data.type,
                        hours: parseInt(data.hours),
                        registrant: data.registrant,
                        regDate: data.regDate
                    });
                    saveData();
                    renderAll();
                    showToast('교육과정이 수정되었습니다.');
                    closeModal();
                }
            } else if (modalTitle === '이수 기록 수정') {
                // 이수 기록 수정
                const recordId = parseInt(data.recordId || data.id);
                console.log('=== 이수 기록 수정 디버그 ===');
                console.log('modalTitle:', modalTitle);
                console.log('data:', data);
                console.log('recordId:', recordId);
                
                // 모든 심사자에서 해당 기록을 찾아서 수정
                let found = false;
                for (const [name, auditor] of Object.entries(db.auditors)) {
                    if (auditor.records) {
                        const record = auditor.records.find(r => r.id === recordId);
                        if (record) {
                            console.log('찾은 기록:', record);
                            console.log('수정 전:', JSON.stringify(record));
                            
                            // 파일명 추출
                            const fileInput = document.getElementById('modal-file');
                            const fileName = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0].name : record.fileName;
                            
                            // 기록 수정
                            Object.assign(record, {
                                courseId: parseInt(data.courseId),
                                date: data.date,
                                notes: data.notes,
                                fileName: fileName
                            });
                            
                            console.log('수정 후:', JSON.stringify(record));
                            found = true;
                            break;
                        }
                    }
                }
                
                if (found) {
                    console.log('이수 기록 수정 성공');
                    saveData();
                    renderRecordTable();
                    showToast('이수 기록이 수정되었습니다.');
                    closeModal();
                    
                    // 승인대기 상태인 경우 상세보기를 다시 열어서 수정된 내용 확인 가능
                    setTimeout(() => {
                        const updatedRecord = currentDisplayedRecords.find(r => r.id === recordId);
                        if (updatedRecord && updatedRecord.approve === '승인대기') {
                            showRecordDetailsModal(updatedRecord);
                        }
                    }, 100);
                    
                } else {
                    console.error('수정할 이수 기록을 찾을 수 없습니다. ID:', recordId);
                    console.log('사용 가능한 기록들:', Object.values(db.auditors).flatMap(a => a.records?.map(r => ({id: r.id, courseId: r.courseId})) || []));
                    showToast('수정할 이수 기록을 찾을 수 없습니다.');
                }
            }
        });
        
        // 네비게이션 이벤트
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('nav-link')) {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('main > section').forEach(s => s.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById(e.target.dataset.target).classList.add('active');
            }
        });

        // EDU-003 이벤트
        document.getElementById('courseSearchForm').addEventListener('submit', e => {
            e.preventDefault();
            const nameFilter = document.getElementById('courseNameInput').value.toLowerCase();
            const descFilter = document.getElementById('courseDescInput').value.toLowerCase();
            const typeFilter = document.getElementById('courseTypeSelect').value;
            const dataSourceFilter = document.getElementById('dataSourceSelect').value;
            const startDateFilter = document.getElementById('startDateInput').value;
            const endDateFilter = document.getElementById('endDateInput').value;
            
            renderCourseTable(c => {
                // 교육사업명 필터
                const nameMatch = !nameFilter || c.name.toLowerCase().includes(nameFilter);
                
                // 세부과정(프로그램)명 필터
                const descMatch = !descFilter || (c.desc && c.desc.toLowerCase().includes(descFilter));
                
                // 필수여부 필터
                const typeMatch = typeFilter === '전체' || c.type === typeFilter;
                
                // 데이터 소스 필터
                const dataSourceMatch = dataSourceFilter === '전체' || c.dataSource === dataSourceFilter;
                
                // 교육기간 필터
                let dateMatch = true;
                if (startDateFilter) {
                    dateMatch = dateMatch && c.startDate >= startDateFilter;
                }
                if (endDateFilter) {
                    dateMatch = dateMatch && c.endDate <= endDateFilter;
                }
                
                return nameMatch && descMatch && typeMatch && dataSourceMatch && dateMatch;
            });
        });
        document.getElementById('courseSearchForm').addEventListener('reset', () => setTimeout(renderCourseTable, 0));
        
        // 교육과정 테이블 행 클릭 이벤트 - 교육과정 상세보기 모달 열기
        document.addEventListener('click', function(e) {
            const courseTable = document.getElementById('courseTable');
            if (courseTable && courseTable.contains(e.target)) {
                const row = e.target.closest('tr');
                if (row && row.dataset.id && !e.target.closest('.manage-buttons')) {
                    // 클릭된 행의 교육과정 데이터 가져오기
                    const courseId = row.dataset.id;
                    const course = db.courses.find(c => c.id == courseId);
                    
                    if (course) {
                        // 교육과정 상세보기 모달 열기
                        try {
                            const formHtml = `
                                <div class="form-group"><label for="modal-name">교육사업명</label><input type="text" id="modal-name" name="name" value="${course.name || ''}" readonly style="background-color: #f5f5f5;"></div>
                                <div class="form-group"><label for="modal-desc">세부과정(프로그램)명</label><textarea id="modal-desc" name="desc" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;background-color: #f5f5f5;" readonly>${course.desc || ''}</textarea></div>
                                <div class="form-group"><label for="modal-startDate">시작일</label><input type="date" id="modal-startDate" name="startDate" value="${course.startDate || ''}" readonly style="background-color: #f5f5f5;"></div>
                                <div class="form-group"><label for="modal-endDate">종료일</label><input type="date" id="modal-endDate" name="endDate" value="${course.endDate || ''}" readonly style="background-color: #f5f5f5;"></div>
                                <div class="form-group"><label for="modal-type">필수여부</label><select id="modal-type" name="type" disabled style="background-color: #f5f5f5;"><option value="필수" ${course.type === '필수' ? 'selected' : ''}>필수</option><option value="선택" ${course.type === '선택' ? 'selected' : ''}>선택</option></select></div>
                                <div class="form-group"><label for="modal-hours">인정시간</label><input type="number" id="modal-hours" name="hours" value="${course.hours || ''}" readonly style="background-color: #f5f5f5;"></div>
                                <div class="form-group"><label for="modal-orgName">교육기관</label><input type="text" id="modal-orgName" name="orgName" value="${course.orgName || ''}" readonly style="background-color: #f5f5f5;"></div>
                                <div class="form-group"><label for="modal-registrant">등록자</label><input type="text" id="modal-registrant" name="registrant" value="${course.registrant || ''}" readonly style="background-color: #f5f5f5;"></div>
                                <div class="form-group"><label for="modal-regDate">등록일</label><input type="date" id="modal-regDate" name="regDate" value="${course.regDate || ''}" readonly style="background-color: #f5f5f5;"></div>
                                <div class="form-group"><label for="modal-dataSource">데이터 소스</label><input type="text" id="modal-dataSource" name="dataSource" value="${course.dataSource === 'API' ? '평가원 교육관리시스템' : '외부 교육기관'}" readonly style="background-color: #f5f5f5;"></div>`;
                                
                            openModal('교육과정 상세보기', formHtml);
                        } catch (error) {
                            console.error('교육과정 상세보기 모달 열기 오류:', error);
                            showToast('교육과정 상세보기 모달을 여는 중 오류가 발생했습니다: ' + error.message);
                        }
                    } else {
                        console.error('교육과정 데이터를 찾을 수 없습니다. ID:', courseId);
                        showToast('교육과정 데이터를 찾을 수 없습니다.');
                    }
                }
            }
        });
        
        // API 동기화 버튼
        document.getElementById('sync-api-btn').addEventListener('click', () => {
            syncWithAPI();
        });

        // 이수 기록 API 동기화 버튼
        document.getElementById('sync-records-api-btn').addEventListener('click', () => {
            syncRecordsWithAPI();
        });

        
        // Bulk Insert 버튼 이벤트
        document.getElementById('bulk-insert-btn').addEventListener('click', () => {
            showBulkInsertModal();
        });

        // 권한 전환 버튼 이벤트
        document.getElementById('switchUserBtn').addEventListener('click', () => {
            switchUserRole();
        });
        
        document.getElementById('add-course-btn').addEventListener('click', () => {
            try {
                // 현재 로그인한 사용자 정보 가져오기
                const currentUser = getCurrentUser();
                
            const formHtml = `
                <div class="form-group"><label for="modal-name">교육사업명</label><input type="text" id="modal-name" name="name" required></div>
                <div class="form-group"><label for="modal-desc">세부과정(프로그램)명</label><textarea id="modal-desc" name="desc" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;"></textarea></div>
                <div class="form-group"><label for="modal-startDate">시작일</label><input type="date" id="modal-startDate" name="startDate" required></div>
                <div class="form-group"><label for="modal-endDate">종료일</label><input type="date" id="modal-endDate" name="endDate" required></div>
                <div class="form-group"><label for="modal-type">필수여부</label><select id="modal-type" name="type"><option>필수</option><option>선택</option></select></div>
                <div class="form-group"><label for="modal-hours">인정시간</label><input type="number" id="modal-hours" name="hours" required></div>
                    <div class="form-group"><label for="modal-orgName">교육기관</label><input type="text" id="modal-orgName" name="orgName" value="${currentUser.orgName}" readonly style="background-color: #f5f5f5;"></div>
                    <div class="form-group"><label for="modal-registrant">등록자</label><input type="text" id="modal-registrant" name="registrant" value="${currentUser.userName}" readonly style="background-color: #f5f5f5;"></div>
                <div class="form-group"><label for="modal-regDate">등록일</label><input type="date" id="modal-regDate" name="regDate" value="${new Date().toISOString().slice(0,10)}" required></div>`;
                
            openModal('신규 교육과정 등록', formHtml);
            } catch (error) {
                console.error('신규 등록 버튼 오류:', error);
                showToast('신규 등록 중 오류가 발생했습니다: ' + error.message);
            }
        });

        document.querySelector('#courseTable tbody').addEventListener('click', e => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const row = btn.closest('tr');
            const id = row.dataset.id;
            
            if (btn.classList.contains('btn-edit-course')) {
                const course = db.courses.find(c => c.id == id);
                const formHtml = `
                    <div class="form-group"><label for="modal-name">교육사업명</label><input type="text" id="modal-name" name="name" required></div>
                    <div class="form-group"><label for="modal-desc">세부과정(프로그램)명</label><textarea id="modal-desc" name="desc" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;"></textarea></div>
                    <div class="form-group"><label for="modal-startDate">시작일</label><input type="date" id="modal-startDate" name="startDate" required></div>
                    <div class="form-group"><label for="modal-endDate">종료일</label><input type="date" id="modal-endDate" name="endDate" required></div>
                    <div class="form-group"><label for="modal-type">필수여부</label><select id="modal-type" name="type"><option>필수</option><option>선택</option></select></div>
                    <div class="form-group"><label for="modal-hours">인정시간</label><input type="number" id="modal-hours" name="hours" required></div>
                    <div class="form-group"><label for="modal-registrant">등록자</label><input type="text" id="modal-registrant" name="registrant" placeholder="등록자 이름을 입력하세요" required></div>
                    <div class="form-group"><label for="modal-regDate">등록일</label><input type="date" id="modal-regDate" name="regDate" required></div>`;
                openModal('교육과정 수정', formHtml, course);
            } else if (btn.classList.contains('btn-delete-course')) {
                if (confirm(`'${row.cells[1].textContent}' 과정을 삭제하시겠습니까?`)) {
                    db.courses = db.courses.filter(c => c.id != id);
                    saveData();
                    renderAll();
                }
            }
        });

        // EDU-004 이벤트
        document.getElementById('auditorSearchForm').addEventListener('submit', e => {
            e.preventDefault();
            const dept = document.getElementById('deptSelect').value;
            const nameFilter = document.getElementById('auditorNameInput').value.toLowerCase();
            const courseNameFilter = document.getElementById('courseNameSearchInput').value.toLowerCase();
            const courseDescFilter = document.getElementById('courseDescSearchInput').value.toLowerCase();
            const coursePeriodStart = document.getElementById('coursePeriodStartInput').value;
            const coursePeriodEnd = document.getElementById('coursePeriodEndInput').value;
            const completionStart = document.getElementById('completionStartInput').value;
            const completionEnd = document.getElementById('completionEndInput').value;
            const courseTypeFilter = document.getElementById('courseTypeSearchSelect').value;
            const dataSourceFilter = document.getElementById('dataSourceSearchSelect').value;
            const statusFilter = document.getElementById('statusSelect').value;
            currentAuditor = nameFilter; // 심사자 이름으로 설정
            currentStatus = statusFilter; // 상태 필터 설정
            renderRecordTable();
        });

        // 부서 선택 변경 시 자동 업데이트
        const deptSelectElement = document.getElementById('deptSelect');
        if (deptSelectElement) {
            deptSelectElement.addEventListener('change', (e) => {
                console.log('부서 선택 변경:', e.target.value);
                renderRecordTable();
            });
            console.log('부서 선택 이벤트 리스너 등록 완료');
        } else {
            console.error('deptSelect 요소를 찾을 수 없습니다.');
        }

        // 상태 선택 변경 시 자동 업데이트
        const statusSelectElement = document.getElementById('statusSelect');
        if (statusSelectElement) {
            statusSelectElement.addEventListener('change', (e) => {
                console.log('상태 선택 변경:', e.target.value);
                renderRecordTable();
            });
            console.log('상태 선택 이벤트 리스너 등록 완료');
        } else {
            console.error('statusSelect 요소를 찾을 수 없습니다.');
        }

        document.getElementById('add-record-btn').addEventListener('click', () => {
            try {
                // 현재 로그인한 사용자 정보 가져오기
                const currentUser = getCurrentUser();
                const isEducationManager = currentUser && currentUser.role === 'EDUCATION_MANAGER';
                
                // 현재 사용자가 심사자 목록에 없으면 추가
                if (!db.auditors[currentUser.userName]) {
                    db.auditors[currentUser.userName] = {
                        info: {
                            name: currentUser.userName,
                            dept: currentUser.orgName,
                            rank: '심사원' // 기본값
                        },
                        records: []
                    };
                    saveData();
                }
                
            const courseOptions = db.courses
                .filter(c => c.dataSource === 'EXTERNAL')
                .map(c => `<option value="${c.id}">${c.name}</option>`)
                .join('');
                
                // 부서 목록 생성
                const deptOptions = ['신약심사부', '허가총괄부', '생물의약품부', '품질안전부', '임상정책부']
                    .map(dept => `<option value="${dept}">${dept}</option>`)
                    .join('');
                
                // 심사자 선택 옵션 생성 (관리자인 경우)
                let auditorSelectHtml = '';
                if (isEducationManager) {
                    auditorSelectHtml = `
                        <div class="form-group">
                            <label for="modal-auditorDept">부서</label>
                            <select id="modal-auditorDept" name="auditorDept" required>
                                <option value="">부서를 선택하세요</option>
                                ${deptOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="modal-auditorName">심사자 이름</label>
                            <input type="text" id="modal-auditorName" name="auditorName" placeholder="심사자 이름을 입력하세요" required>
                        </div>`;
                } else {
                    auditorSelectHtml = `
                        <div class="form-group">
                            <label for="modal-auditorName">심사자</label>
                            <input type="text" id="modal-auditorName" name="auditorName" value="${currentUser.userName}" readonly style="background-color: #f5f5f5;">
                        </div>`;
                }
                
            const formHtml = `
                    ${auditorSelectHtml}
                <div class="form-group"><label for="modal-courseId">교육과정</label><select id="modal-courseId" name="courseId" required>${courseOptions}</select></div>
                <div class="form-group"><label for="modal-date">이수일자</label><input type="date" id="modal-date" name="date" value="${new Date().toISOString().slice(0,10)}" required></div>
                <div class="form-group"><label for="modal-status">상태</label><select id="modal-status" name="status" required><option value="승인대기">승인대기</option><option value="승인">승인</option><option value="반려">반려</option></select></div>
                    <div class="form-group"><label for="modal-file">증빙자료</label><input type="file" id="modal-file" name="file"></div>
                    <div class="form-group"><label for="modal-notes">비고</label><textarea id="modal-notes" name="notes" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;" placeholder="교육 내용 요약이나 특이사항을 입력하세요"></textarea></div>`;
                
                const modalTitle = isEducationManager ? '이수 기록 등록 (관리자)' : '내 이수 기록 등록';
                openModal(modalTitle, formHtml);
                
                // 관리자인 경우 부서 선택 시 해당 부서의 심사자 목록 표시
                if (isEducationManager) {
                    const auditorDeptSelect = document.getElementById('modal-auditorDept');
                    const auditorNameInput = document.getElementById('modal-auditorName');
                    
                    // 부서별 심사자 목록을 표시할 컨테이너 추가
                    const auditorListContainer = document.createElement('div');
                    auditorListContainer.id = 'auditorListContainer';
                    auditorListContainer.style.marginTop = '8px';
                    auditorListContainer.style.display = 'none';
                    auditorDeptSelect.parentNode.appendChild(auditorListContainer);
                    
                    auditorDeptSelect.addEventListener('change', function() {
                        const selectedDept = this.value;
                        auditorNameInput.value = '';
                        auditorListContainer.innerHTML = '';
                        auditorListContainer.style.display = 'none';
                        
                        if (selectedDept) {
                            // 해당 부서의 심사자 목록 가져오기
                            const deptAuditors = Object.keys(db.auditors).filter(name => 
                                db.auditors[name].info.dept === selectedDept
                            );
                            
                            if (deptAuditors.length > 0) {
                                auditorListContainer.innerHTML = `
                                    <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">
                                        ${selectedDept} 소속 심사자:
                                    </div>
                                    <div style="max-height: 100px; overflow-y: auto; border: 1px solid var(--line); border-radius: 4px; padding: 8px; background: #f9f9f9;">
                                        ${deptAuditors.map(name => 
                                            `<div style="padding: 2px 0; cursor: pointer; font-size: 12px;" onclick="document.getElementById('modal-auditorName').value='${name}'">${name}</div>`
                                        ).join('')}
                                    </div>
                                `;
                                auditorListContainer.style.display = 'block';
                            } else {
                                auditorListContainer.innerHTML = `
                                    <div style="font-size: 12px; color: var(--muted);">
                                        ${selectedDept}에 등록된 심사자가 없습니다.
                                    </div>
                                `;
                                auditorListContainer.style.display = 'block';
                            }
                        }
                    });
                }
                
            } catch (error) {
                console.error('이수 기록 등록 버튼 오류:', error);
                showToast('이수 기록 등록 중 오류가 발생했습니다: ' + error.message);
            }
        });

        // 이수 기록 대량 등록 버튼 이벤트
        document.getElementById('bulk-insert-records-btn').addEventListener('click', () => {
            showBulkInsertRecordsModal();
        });

        document.querySelector('#recordTable tbody').addEventListener('click', e => {
            console.log('Table clicked, target:', e.target);
            const btn = e.target.closest('button');
            const row = e.target.closest('tr');
            console.log('Button found:', btn);
            console.log('Row found:', row);
            if (!row) {
                console.log('No row found, returning');
                return;
            }
            const id = row.dataset.id;
            console.log('Row ID:', id);
            
            // 모든 row를 클릭했을 때 (버튼이 아닌 경우)
            if (!btn) {
                console.log('Row clicked, ID:', id);
                console.log('Row dataset:', row.dataset);
                
                // 현재 표시된 기록에서 찾기 (원본 ID 사용)
                const record = currentDisplayedRecords.find(r => r.id == id);
                console.log('Current displayed records:', currentDisplayedRecords.length);
                console.log('Looking for record with ID:', id);
                console.log('Found record:', record);
                
                if (record) {
                    console.log('Showing record details modal for record:', record);
                    showRecordDetailsModal(record);
                    return;
                } else {
                    console.log('Record not found in displayed records for ID:', id);
                    console.log('Available displayed record IDs:', currentDisplayedRecords.map(r => r.id));
                }
            }
            
            if (!btn) return;
            
            if (btn.classList.contains('btn-edit-record')) {
                console.log('=== 수정 버튼 클릭 디버그 ===');
                console.log('클릭된 버튼:', btn);
                console.log('찾고 있는 ID:', id);
                
                // 모든 심사자에서 해당 ID의 기록을 찾기
                let record = null;
                let auditorName = null;
                
                for (const [name, auditor] of Object.entries(db.auditors)) {
                    if (auditor.records) {
                        const foundRecord = auditor.records.find(r => r.id == id);
                        if (foundRecord) {
                            record = foundRecord;
                            auditorName = name;
                            console.log('기록 찾음:', foundRecord, '심사자:', name);
                            break;
                        }
                    }
                }
                
                if (record) {
                    console.log('수정할 기록:', record);
                    const options = db.courses
                        .filter(c => c.dataSource === 'EXTERNAL')
                        .map(c => `<option value="${c.id}" ${c.id === record.courseId ? 'selected' : ''}>${c.name}</option>`)
                        .join('');
                    const formHtml = `
                        <input type="hidden" id="modal-recordId" name="recordId" value="${record.id}">
                        <div class="form-group"><label for="modal-courseId">교육과정</label><select id="modal-courseId" name="courseId" required>${options}</select></div>
                        <div class="form-group"><label for="modal-date">이수일자</label><input type="date" id="modal-date" name="date" value="${record.date || ''}" required></div>
                        <div class="form-group"><label for="modal-file">증빙자료</label><input type="file" id="modal-file" name="file"></div>
                        <div class="form-group"><label for="modal-notes">비고</label><textarea id="modal-notes" name="notes" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;" placeholder="교육 내용 요약이나 특이사항을 입력하세요">${record.notes || ''}</textarea></div>`;
                    console.log('수정 모달 열기');
                    openModal('이수 기록 수정', formHtml, record);
                } else {
                    console.error('수정할 기록을 찾을 수 없습니다. ID:', id);
                    showToast('수정할 기록을 찾을 수 없습니다.');
                }
            } else if (btn.classList.contains('btn-delete-record')) {
                const courseName = db.courses.find(c => c.id == btn.closest('tr').dataset.courseId).name;
                if (confirm(`'${courseName}' 이수 기록을 삭제하시겠습니까?`)) {
                    // 모든 심사자에서 해당 ID의 기록을 찾아서 삭제
                    for (const [name, auditor] of Object.entries(db.auditors)) {
                        if (auditor.records) {
                            const recordIndex = auditor.records.findIndex(r => r.id == id);
                            if (recordIndex !== -1) {
                                auditor.records.splice(recordIndex, 1);
                                break;
                            }
                        }
                    }
                    saveData();
                    renderAll();
                }
            } else if (btn.classList.contains('btn-approve-record')) {
                // 현재 표시된 기록에서 찾기 (원본 ID 사용)
                const record = currentDisplayedRecords.find(r => r.id == id);
                console.log('Approve button clicked, found record:', record);
                
                if (record) {
                    showApprovalModal(record, 'approve');
                } else {
                    console.error('Record not found for approve button');
                    showToast('기록을 찾을 수 없습니다.');
                }
            } else if (btn.classList.contains('btn-reject-record')) {
                // 현재 표시된 기록에서 찾기 (원본 ID 사용)
                const record = currentDisplayedRecords.find(r => r.id == id);
                console.log('Reject button clicked, found record:', record);
                
                if (record) {
                    showApprovalModal(record, 'reject');
                } else {
                    console.error('Record not found for reject button');
                    showToast('기록을 찾을 수 없습니다.');
                }
            }
        });

        // EDU-005 이벤트 - 보고서 유형 선택
        document.querySelectorAll('input[name="reportType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const personalReport = document.getElementById('personalReport');
                const departmentReport = document.getElementById('departmentReport');
                
                if (e.target.value === 'personal') {
                    personalReport.style.display = 'block';
                    departmentReport.style.display = 'none';
                } else {
                    personalReport.style.display = 'none';
                    departmentReport.style.display = 'block';
                }
            });
        });

        // 개인별 보고서 이벤트
        const personalReportForm = document.getElementById('personalReportForm');
        personalReportForm.addEventListener('submit', e => {
            e.preventDefault();
            const startDate = document.getElementById('personalStartDate').value;
            const endDate = document.getElementById('personalEndDate').value;
            const deptFilter = document.getElementById('personalDeptSelect').value;
            const auditorName = document.getElementById('personalAuditorInput').value.trim();
            renderPersonalReport(startDate, endDate, deptFilter, auditorName);
        });
        personalReportForm.addEventListener('reset', () => {
            document.getElementById('personalReportSummary').innerHTML = '';
            document.querySelector('#personalReportTable tbody').innerHTML = '';
        });

        // 부서별 보고서 이벤트
        const departmentReportForm = document.getElementById('departmentReportForm');
        departmentReportForm.addEventListener('submit', e => {
            e.preventDefault();
            const startDate = document.getElementById('deptStartDate').value;
            const endDate = document.getElementById('deptEndDate').value;
            const deptFilter = document.getElementById('deptReportSelect').value;
            const auditorName = document.getElementById('deptAuditorInput').value.trim();
            renderDepartmentReport(startDate, endDate, deptFilter, auditorName);
        });
        departmentReportForm.addEventListener('reset', () => {
            document.getElementById('departmentReportSummary').innerHTML = '';
            document.querySelector('#reportTable tbody').innerHTML = '';
        });

        // 엑셀 다운로드 이벤트
        document.getElementById('personalExcelBtn').addEventListener('click', () => {
            downloadPersonalReportExcel();
        });
        document.getElementById('departmentExcelBtn').addEventListener('click', () => {
            downloadDepartmentReportExcel();
        });

        // 인쇄 이벤트
        document.getElementById('personalPrintBtn').addEventListener('click', () => {
            printPersonalReport();
        });
        document.getElementById('departmentPrintBtn').addEventListener('click', () => {
            printDepartmentReport();
        });

        // 엑셀 다운로드 함수들
        const downloadPersonalReportExcel = () => {
            const table = document.getElementById('personalReportTable');
            const data = [];
            
            // 헤더 추가
            const headers = ['고유ID', '부서', '성명', '교육사업명', '세부과정(프로그램)명', '교육기간', '이수일자', '인정시간', '상태', '데이터소스'];
            data.push(headers);
            
            // 데이터 추가
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach(cell => {
                    rowData.push(cell.textContent.trim());
                });
                data.push(rowData);
            });
            
            // Excel 파일로 변환
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '개인별 교육실적 보고서');
            
            // 파일 다운로드
            XLSX.writeFile(wb, `개인별_교육실적보고서_${new Date().toISOString().slice(0,10)}.xlsx`);
            
            showToast('개인별 교육실적 보고서가 다운로드되었습니다.');
        };

        const downloadDepartmentReportExcel = () => {
            const table = document.getElementById('reportTable');
            const data = [];
            
            // 헤더 추가
            const headers = ['부서', '성명', '교육사업명', '세부과정(프로그램)명', '교육기간', '이수일자', '필수여부', '인정시간', '상태', '데이터소스'];
            data.push(headers);
            
            // 데이터 추가
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach(cell => {
                    rowData.push(cell.textContent.trim());
                });
                data.push(rowData);
            });
            
            // Excel 파일로 변환
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '부서별 교육실적 보고서');
            
            // 파일 다운로드
            XLSX.writeFile(wb, `부서별_교육실적보고서_${new Date().toISOString().slice(0,10)}.xlsx`);
            
            showToast('부서별 교육실적 보고서가 다운로드되었습니다.');
        };

        // 인쇄 함수들
        const printPersonalReport = () => {
            const printWindow = window.open('', '_blank');
            const table = document.getElementById('personalReportTable');
            const summary = document.getElementById('personalReportSummary').innerHTML;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>개인별 교육실적 보고서</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #2c3e50; text-align: center; }
                        .summary { background: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 5px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
                        .status.ok { background: #d4edda; color: #155724; }
                        .status.wait { background: #fff3cd; color: #856404; }
                        .status.error { background: #f8d7da; color: #721c24; }
                    </style>
                </head>
                <body>
                    <h1>개인별 교육실적 보고서</h1>
                    <div class="summary">${summary}</div>
                    ${table.outerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        };

        const printDepartmentReport = () => {
            const printWindow = window.open('', '_blank');
            const table = document.getElementById('reportTable');
            const summary = document.getElementById('departmentReportSummary').innerHTML;
            
            const htmlContent = '<html>' +
                '<head>' +
                    '<title>부서별 교육실적 보고서</title>' +
                    '<style>' +
                        'body { font-family: Arial, sans-serif; margin: 20px; }' +
                        'h1 { color: #2c3e50; text-align: center; }' +
                        '.summary { background: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 5px; }' +
                        'table { width: 100%; border-collapse: collapse; margin: 20px 0; }' +
                        'th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }' +
                        'th { background-color: #f2f2f2; font-weight: bold; }' +
                        '.status { padding: 4px 8px; border-radius: 4px; font-size: 12px; }' +
                        '.status.ok { background: #d4edda; color: #155724; }' +
                        '.status.wait { background: #fff3cd; color: #856404; }' +
                        '.status.error { background: #f8d7da; color: #721c24; }' +
                    '</style>' +
                '</head>' +
                '<body>' +
                    '<h1>부서별 교육실적 보고서</h1>' +
                    '<div class="summary">' + summary + '</div>' +
                    table.outerHTML +
                '</body>' +
                '</html>';
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.print();
        };

        // --- 사용자 정보 관리 ---
        const getCurrentUser = () => {
            // 실제로는 세션 또는 토큰에서 사용자 정보를 가져와야 함
            // 현재는 localStorage에서 사용자 정보를 가져오는 것으로 시뮬레이션
            const userInfo = localStorage.getItem('currentUser');
            if (userInfo) {
                return JSON.parse(userInfo);
            }
            // 기본값 반환 (기존 데이터에 있는 심사자로 설정)
            return {
                orgName: "신약심사부",
                userName: "홍길동",
                role: "EDUCATION_MANAGER", // 교육 관리 권한
                permissions: ["COURSE_MANAGE", "BULK_INSERT", "RECORD_MANAGE"]
            };
        };

        // 권한 체크 함수
        const hasPermission = (permission) => {
            const currentUser = getCurrentUser();
            return currentUser.permissions && currentUser.permissions.includes(permission);
        };

        // 교육 관리 권한 체크
        const isEducationManager = () => {
            const currentUser = getCurrentUser();
            return currentUser.role === "EDUCATION_MANAGER" || hasPermission("COURSE_MANAGE");
        };

        const updateUserInfo = () => {
            const currentUser = getCurrentUser();
            const userInfoElement = document.getElementById('currentUserInfo');
            if (userInfoElement) {
                userInfoElement.textContent = `${currentUser.orgName} - ${currentUser.userName}`;
            }
        };


        // --- API 동기화 ---
        const syncWithAPI = async () => {
            try {
                showToast('API 동기화를 시작합니다...');
                
                // 실제 API 호출 시뮬레이션
                // 평가원 교육관리시스템에서 등록한 실제 교육과정 데이터
                const mockApiData = [
                    {
                        id: 30,
                        name: "2025년 신규 의약품 심사 가이드라인",
                        desc: "2025년도 신규 의약품 심사 기준 및 가이드라인",
                        startDate: "2025-04-01",
                        endDate: "2025-04-30",
                        type: "필수",
                        hours: 8,
                        regDate: new Date().toISOString().slice(0,10),
                        dataSource: "API",
                        orgName: "평가원 교육관리시스템",
                        registrant: "이평가"
                    },
                    {
                        id: 31,
                        name: "의약품 임상시험 데이터 분석",
                        desc: "임상시험 데이터 분석 및 해석 방법론",
                        startDate: "2025-05-15",
                        endDate: "2025-05-25",
                        type: "선택",
                        hours: 12,
                        regDate: new Date().toISOString().slice(0,10),
                        dataSource: "API",
                        orgName: "평가원 교육관리시스템",
                        registrant: "박데이터"
                    },
                    {
                        id: 32,
                        name: "의약품 안전성 모니터링 실무",
                        desc: "의약품 안전성 모니터링 및 부작용 관리 실무 교육",
                        startDate: "2025-06-01",
                        endDate: "2025-06-15",
                        type: "필수",
                        hours: 10,
                        regDate: new Date().toISOString().slice(0,10),
                        dataSource: "API",
                        orgName: "평가원 교육관리시스템",
                        registrant: "김안전"
                    },
                    {
                        id: 33,
                        name: "바이오의약품 심사 실무",
                        desc: "바이오의약품 심사 기준 및 실무 교육",
                        startDate: "2025-07-01",
                        endDate: "2025-07-10",
                        type: "필수",
                        hours: 14,
                        regDate: new Date().toISOString().slice(0,10),
                        dataSource: "API",
                        orgName: "평가원 교육관리시스템",
                        registrant: "최바이오"
                    },
                    {
                        id: 34,
                        name: "의약품 품질관리 심화과정",
                        desc: "의약품 품질관리 고급 실무 및 검사 방법론",
                        startDate: "2025-08-01",
                        endDate: "2025-08-20",
                        type: "선택",
                        hours: 16,
                        regDate: new Date().toISOString().slice(0,10),
                        dataSource: "API",
                        orgName: "평가원 교육관리시스템",
                        registrant: "강품질"
                    }
                ];
                
                // 중복되지 않는 새 데이터만 추가
                const existingIds = new Set(db.courses.map(c => c.id));
                const newCourses = mockApiData.filter(course => !existingIds.has(course.id));
                
                if (newCourses.length > 0) {
                    db.courses.push(...newCourses);
                    saveData();
                    renderAll();
                    showToast(`API 동기화가 완료되었습니다. ${newCourses.length}개의 새로운 교육과정이 추가되었습니다.`);
                } else {
                    showToast('API 동기화가 완료되었습니다. 추가할 새로운 교육과정이 없습니다.');
                }
                
            } catch (error) {
                showToast('API 동기화 중 오류가 발생했습니다.');
                console.error('API 동기화 오류:', error);
            }
        };

        // 이수 기록 API 동기화 함수
        const syncRecordsWithAPI = async () => {
            try {
                showToast('이수 기록 API 동기화를 시작합니다...');
                
                // database.js에서 API 동기화용 이수 기록 데이터 가져오기
                const mockRecordsApiData = EducationDatabase.apiRecords;
                
                // 중복되지 않는 새 이수 기록만 추가
                let addedCount = 0;
                
                mockRecordsApiData.forEach(record => {
                    if (!db.auditors[record.auditorName]) {
                        db.auditors[record.auditorName] = {
                            info: {
                                name: record.auditorName,
                                dept: record.dept,
                                rank: record.rank
                            },
                            records: []
                        };
                    }
                    
                    if (!db.auditors[record.auditorName].records) {
                        db.auditors[record.auditorName].records = [];
                    }
                    
                    // 중복 체크: 같은 ID의 기록이 이미 있는지 확인
                    const existingRecord = db.auditors[record.auditorName].records.find(r => r.id === record.id);
                    if (!existingRecord) {
                        db.auditors[record.auditorName].records.push({
                            id: record.id,
                            courseId: record.courseId,
                            date: record.completionDate,
                            status: record.status,
                            dataSource: record.dataSource,
                            registrant: record.registrant,
                            auditorName: record.auditorName, // 심사자 이름 추가
                            approve: '승인' // API에서 가져온 데이터는 이미 승인된 것만
                        });
                        addedCount++;
                    }
                });
                
                if (addedCount > 0) {
                    saveData();
                    renderAll();
                    showToast(`이수 기록 API 동기화가 완료되었습니다. ${addedCount}개의 새로운 이수 기록이 추가되었습니다. (자동 승인 처리됨)`);
                } else {
                    showToast('이수 기록 API 동기화가 완료되었습니다. 추가할 새로운 이수 기록이 없습니다.');
                }
                
            } catch (error) {
                console.error('이수 기록 API 동기화 오류:', error);
                showToast('이수 기록 API 동기화 중 오류가 발생했습니다: ' + error.message);
            }
        };

        // --- 공통 유틸리티 ---
        const showToast = (message) => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '1'; }, 100);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => { container.removeChild(toast); }, 500);
            }, 3000);
        };
        
        // 정렬 이벤트 리스너
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const table = header.closest('table');
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const sortBy = header.dataset.sort;
                const currentDir = header.dataset.dir || 'desc';
                const newDir = currentDir === 'asc' ? 'desc' : 'asc';
                
                // 모든 헤더의 정렬 방향 초기화
                table.querySelectorAll('th').forEach(th => th.removeAttribute('data-dir'));
                header.dataset.dir = newDir; // 현재 클릭된 헤더에만 방향 설정

                rows.sort((a, b) => {
                    // 셀 인덱스 찾기
                    const colIndex = Array.from(header.parentElement.children).indexOf(header);
                    let valA = a.cells[colIndex].textContent.trim();
                    let valB = b.cells[colIndex].textContent.trim();
                    
                    // 숫자나 날짜 비교
                    if (!isNaN(valA) && !isNaN(valB)) {
                        return (valA - valB) * (newDir === 'asc' ? 1 : -1);
                    }
                    if (valA.match(/^\d{4}-\d{2}-\d{2}$/) && valB.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        return (new Date(valA) - new Date(valB)) * (newDir === 'asc' ? 1 : -1);
                    }

                    // 문자열 비교
                    return valA.localeCompare(valB) * (newDir === 'asc' ? 1 : -1);
                });
                
                tbody.innerHTML = '';
                rows.forEach(row => tbody.appendChild(row));
            });
        });


        // --- Bulk Insert 기능 (엑셀 파일 처리) ---
        const showBulkInsertModal = () => {
            if (!isEducationManager()) {
                alert('교육 관리 권한이 필요합니다.');
                return;
            }

            // 별도 HTML 파일을 팝업으로 열기
            const popup = window.open('bulk-insert.html', 'bulkInsertPopup', 'width=900,height=700,scrollbars=yes,resizable=yes');
        };

        // --- 이수 기록 Bulk Insert 기능 ---
        const showBulkInsertRecordsModal = () => {
            if (!isEducationManager()) {
                alert('교육 관리 권한이 필요합니다.');
                return;
            }

            // 별도 HTML 파일을 팝업으로 열기
            const popup = window.open('bulk-insert-records.html', 'bulkInsertRecordsPopup', 'width=1000,height=800,scrollbars=yes,resizable=yes');
            
            // 팝업이 로드된 후 교육과정 데이터 전송
            popup.addEventListener('load', () => {
                popup.postMessage({
                    type: 'COURSE_DATABASE',
                    courses: db.courses
                }, '*');
            });
        };

        // 팝업에서 전달받은 데이터 처리
        const handleBulkInsertData = (coursesData) => {
            if (!isEducationManager()) {
                alert('교육 관리 권한이 필요합니다.');
                return;
            }

            if (coursesData.length === 0) {
                alert('등록할 교육과정이 없습니다.');
                return;
            }

            // 교육과정 추가
            const newCourses = coursesData.map((course, index) => ({
                id: db.courses.length + index + 1,
                name: course.name,
                desc: course.desc,
                startDate: course.startDate,
                endDate: course.endDate,
                type: course.type,
                hours: course.hours,
                regDate: new Date().toISOString().slice(0, 10),
                dataSource: "EXTERNAL",
                orgName: course.orgName,
                registrant: course.registrant
            }));

            db.courses.push(...newCourses);
            localStorage.setItem('eduDb', JSON.stringify(db));
            
            alert(`${newCourses.length}개의 교육과정이 성공적으로 등록되었습니다.`);
            renderAll();
        };

        // 이수 기록 대량 등록 데이터 처리
        const handleBulkInsertRecordsData = (recordsData) => {
            if (!isEducationManager()) {
                alert('교육 관리 권한이 필요합니다.');
                return;
            }

            if (recordsData.length === 0) {
                alert('등록할 이수 기록이 없습니다.');
                return;
            }

            let successCount = 0;
            let errorCount = 0;

            recordsData.forEach(record => {
                try {
                    // 심사자가 존재하지 않으면 생성
                    if (!db.auditors[record.auditorName]) {
                        db.auditors[record.auditorName] = {
                            info: {
                                name: record.auditorName,
                                dept: record.dept,
                                rank: '심사원' // 기본값
                            },
                            records: []
                        };
                    }

                    // 교육과정 정보 확인
                    const course = db.courses.find(c => c.id == record.courseId);
                    if (!course) {
                        console.error('교육과정을 찾을 수 없습니다:', record.courseId);
                        errorCount++;
                        return;
                    }

                    // 승인여부 변환 ('대기' -> '승인대기')
                    let approveStatus = record.approval;
                    if (approveStatus === '대기') {
                        approveStatus = '승인대기';
                    }
                    
                    // 이수 기록 생성
                    const newRecord = {
                        id: Date.now() + Math.random(), // 고유 ID 생성
                        courseId: parseInt(record.courseId),
                        date: record.completionDate,
                        status: 'completed',
                        dataSource: course.dataSource === 'API' ? 'API' : 'EXTERNAL',
                        registrant: record.auditorName,
                        auditorName: record.auditorName,
                        approve: approveStatus,
                        notes: '',
                        fileName: ''
                    };

                    // 이수 기록 추가
                    db.auditors[record.auditorName].records.push(newRecord);
                    successCount++;

                } catch (error) {
                    console.error('이수 기록 등록 오류:', error, record);
                    errorCount++;
                }
            });

            if (successCount > 0) {
                saveData();
                renderAll();
            }

            let message = `${successCount}개의 이수 기록이 성공적으로 등록되었습니다.`;
            if (errorCount > 0) {
                message += `\n${errorCount}개의 기록은 등록에 실패했습니다.`;
            }
            alert(message);
        };

        // 권한에 따른 UI 업데이트
        const updateUIByPermission = () => {
            const bulkInsertBtn = document.getElementById('bulk-insert-btn');
            const bulkInsertRecordsBtn = document.getElementById('bulk-insert-records-btn');
            
            if (isEducationManager()) {
                if (bulkInsertBtn) {
                    bulkInsertBtn.style.display = 'inline-block';
                }
                if (bulkInsertRecordsBtn) {
                    bulkInsertRecordsBtn.style.display = 'inline-block';
                }
            } else {
                if (bulkInsertBtn) {
                    bulkInsertBtn.style.display = 'none';
                }
                if (bulkInsertRecordsBtn) {
                    bulkInsertRecordsBtn.style.display = 'none';
                }
            }
        };

        // 사용자 권한 전환 기능
        const switchUserRole = () => {
            const currentUser = getCurrentUser();
            const isManager = isEducationManager();
            
            if (isManager) {
                // 교육 관리자에서 일반 사용자로 전환
                const newUser = {
                    orgName: "신약심사부",
                    userName: "김일반",
                    role: "AUDITOR",
                    permissions: ["RECORD_MANAGE"]
                };
                localStorage.setItem('currentUser', JSON.stringify(newUser));
            } else {
                // 일반 사용자에서 교육 관리자로 전환
                const newUser = {
                    orgName: "신약심사부",
                    userName: "홍길동",
                    role: "EDUCATION_MANAGER",
                    permissions: ["COURSE_MANAGE", "BULK_INSERT", "RECORD_MANAGE"]
                };
                localStorage.setItem('currentUser', JSON.stringify(newUser));
            }
            
            updateUserInfo();
            updateUIByPermission();
            renderAll(); // 테이블 새로고침
        };

        // 팝업 메시지 리스너
        window.addEventListener('message', (event) => {
            if (event.data.type === 'bulkInsertCourses') {
                handleBulkInsertData(event.data.data);
            } else if (event.data.type === 'bulkInsertRecords') {
                handleBulkInsertRecordsData(event.data.data);
            } else if (event.data.type === 'REQUEST_COURSE_DATABASE') {
                // 이수 기록 대량 등록 팝업에서 교육과정 데이터 요청 시 응답
                event.source.postMessage({
                    type: 'COURSE_DATABASE',
                    courses: db.courses
                }, '*');
            }
        });

        // --- 앱 시작 ---
        initData();
        updateUserInfo();
        updateUIByPermission();
        
        // 초기 검색 결과 개수 표시
        const searchResultInfo = document.getElementById('searchResultInfo');
        if (searchResultInfo) {
            searchResultInfo.textContent = `검색 결과: ${db.courses.length}건`;
        }
    });
</script>
</body>
</html>