<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ì•½í’ˆí†µí•©ì •ë³´ì‹œìŠ¤í…œ - êµìœ¡ ì‹¤ì  ê´€ë¦¬</title>
    <!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root{
            --bg:#f7f8fa; --card:#ffffff; --line:#e5e7eb; --text:#111827; --muted:#6b7280; --primary:#2563eb; --danger:#dc2626; --ok:#059669; --warn:#d97706;
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;color:var(--text);background:var(--bg)}
        
        header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
        header h1{font-size:18px;margin:0 12px 0 0}
        #userInfo{display:flex;align-items:center;gap:8px}
        
        .container{padding:16px;max-width:1400px;margin:0 auto}
        .hidden{display:none !important}
        .row{display:grid;gap:12px}
        .row.two{grid-template-columns:1fr 1fr}
        .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:16px}
        .card h3{margin:0 0 8px 0;font-size:16px}
        
        nav{background-color:var(--card);border-bottom:1px solid var(--line);padding:10px 16px;text-align:center}
        nav a{text-decoration:none;color:var(--text);padding:8px 15px;border-radius:8px;margin:0 5px;font-weight:500;transition:all 0.2s}
        nav a.active,nav a:hover{background-color:var(--primary);color:white}
        
        main > section { display: none; padding-top: 20px; }
        main > section.active { display: block; }
        
        h2{font-size:20px;border-left:5px solid var(--primary);padding-left:10px;margin-bottom:20px;color:var(--text)}
        
        .search-area, .action-area, .info-box{border:1px solid var(--line);background-color:var(--card);padding:15px;margin-bottom:20px;border-radius:12px}
        .search-area form, .search-area{display:flex;gap:15px;align-items:center;flex-wrap:wrap}
        .search-area .form-group.date-range{display:flex;align-items:center;gap:8px}
        .search-area .form-group.date-range input{width:150px}
        
        .form-group{display:flex;align-items:center;gap:8px}
        label{font-weight:600;color:var(--muted)}
        
        input[type="text"], input[type="date"], select{padding:8px 10px;border:1px solid var(--line);border-radius:8px;height:35px;box-sizing:border-box;background:#fff}
        input[type="text"]{width:200px}
        
        .btn{padding:8px 12px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer;font-weight:500;color:var(--text);font-family:inherit;transition:all 0.2s}
        .btn:hover{background:var(--bg)}
        .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
        .btn-primary:hover{background:#1d4ed8}
        .btn-secondary{background:var(--muted);color:#fff;border-color:var(--muted)}
        .btn-search{background:var(--primary);color:#fff;border-color:var(--primary)}
        .btn-danger{background:var(--danger);color:#fff;border-color:var(--danger)}
        .btn-danger:hover{background:#b91c1c}
        
        .action-area{text-align:right}
        
        .table-container{overflow-x:auto;margin-top:0;border:1px solid var(--line);border-radius:8px;border-top-left-radius:0;border-top-right-radius:0}
        .table-hint{background:#f0f9ff;padding:8px 12px;margin-bottom:0;border-radius:6px;border-left:4px solid var(--primary);font-size:14px;color:var(--primary);width:100%;box-sizing:border-box;border-bottom-left-radius:0;border-bottom-right-radius:0}
        table{width:100%;border-collapse:separate;border-spacing:0}
        #courseTable{min-width:1200px}
        #recordTable{min-width:1600px}
        th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;font-size:13px;white-space:nowrap}
        /* êµìœ¡ê³¼ì • ê´€ë¦¬ í…Œì´ë¸” ì»¬ëŸ¼ ë„ˆë¹„ */
        #courseTable th:first-child, #courseTable td:first-child{width:80px;min-width:80px}
        #courseTable th:nth-child(2), #courseTable td:nth-child(2){width:200px;min-width:200px;white-space:normal;word-wrap:break-word}
        #courseTable th:nth-child(3), #courseTable td:nth-child(3){width:250px;min-width:250px;white-space:normal;word-wrap:break-word}
        #courseTable th:nth-child(4), #courseTable td:nth-child(4){width:180px;min-width:180px}
        #courseTable th:nth-child(5), #courseTable td:nth-child(5){width:80px;min-width:80px}
        #courseTable th:nth-child(6), #courseTable td:nth-child(6){width:80px;min-width:80px}
        #courseTable th:nth-child(7), #courseTable td:nth-child(7){width:150px;min-width:150px}
        #courseTable th:nth-child(8), #courseTable td:nth-child(8){width:100px;min-width:100px}
        #courseTable th:nth-child(9), #courseTable td:nth-child(9){width:100px;min-width:100px}
        #courseTable th:nth-child(10), #courseTable td:nth-child(10){width:120px;min-width:120px}
        
        /* ì‹¬ì‚¬ìë³„ êµìœ¡ ì´ìˆ˜ í˜„í™© í…Œì´ë¸” ì»¬ëŸ¼ ë„ˆë¹„ */
        #recordTable th:first-child, #recordTable td:first-child{width:120px;min-width:120px}
        #recordTable th:nth-child(2), #recordTable td:nth-child(2){width:100px;min-width:100px}
        #recordTable th:nth-child(3), #recordTable td:nth-child(3){width:100px;min-width:100px}
        #recordTable th:nth-child(4), #recordTable td:nth-child(4){width:250px;min-width:250px;white-space:normal;word-wrap:break-word}
        #recordTable th:nth-child(5), #recordTable td:nth-child(5){width:300px;min-width:300px;white-space:normal;word-wrap:break-word}
        #recordTable th:nth-child(6), #recordTable td:nth-child(6){width:180px;min-width:180px}
        #recordTable th:nth-child(7), #recordTable td:nth-child(7){width:100px;min-width:100px}
        #recordTable th:nth-child(8), #recordTable td:nth-child(8){width:80px;min-width:80px}
        #recordTable th:nth-child(9), #recordTable td:nth-child(9){width:80px;min-width:80px}
        #recordTable th:nth-child(10), #recordTable td:nth-child(10){width:150px;min-width:150px}
        #recordTable th:nth-child(11), #recordTable td:nth-child(11){width:100px;min-width:100px}
        #recordTable th:nth-child(12), #recordTable td:nth-child(12){width:100px;min-width:100px}
        #recordTable th:nth-child(13), #recordTable td:nth-child(13){width:120px;min-width:120px}
        thead th{color:var(--muted);font-weight:600;background:#fafafa;position:sticky;top:0}
        thead th.sortable{cursor:pointer}
        thead th.sortable:hover{background:#f3f4f6}
        thead th .sort-arrow{opacity:0.3}
        
        tbody tr:hover td{background:#fafafa}
        .required-missing{background-color:#fef2f2 !important;font-weight:700;color:var(--danger)}
        .link{color:var(--primary);text-decoration:none;cursor:pointer}
        .link:hover{text-decoration:underline}
        
        .manage-buttons{display:flex;gap:4px;flex-wrap:wrap;justify-content:center;align-items:center}
        .manage-buttons .btn{min-width:50px;font-size:11px}
        
        /* í…Œì´ë¸” ê°œì„  */
        #recordTable td{vertical-align:middle;padding:8px 6px}
        #recordTable th{font-size:13px;padding:10px 6px}
        #recordTable .status{font-size:11px;padding:2px 6px}
        
        /* êµìœ¡ì‚¬ì—…ëª… ì»¬ëŸ¼ ê°œì„  */
        #recordTable th:nth-child(3), #recordTable td:nth-child(3) {
            max-width: 200px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* ì„¸ë¶€ê³¼ì •(í”„ë¡œê·¸ë¨)ëª… ì»¬ëŸ¼ ê°œì„  */
        #recordTable th:nth-child(4), #recordTable td:nth-child(4) {
            max-width: 250px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* êµìœ¡ê¸°ê°„ ì»¬ëŸ¼ ê°œì„  */
        #recordTable th:nth-child(5), #recordTable td:nth-child(5) {
            max-width: 180px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* ê´€ë¦¬ ë²„íŠ¼ ì»¬ëŸ¼ ê°œì„  */
        #recordTable th:nth-child(12), #recordTable td:nth-child(12) {
            text-align: center;
            white-space: nowrap;
        }
        
        /* Modal Styles */
        .modal-overlay{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.5)}
        .modal-content{background:var(--card);margin:10% auto;padding:20px;border:1px solid var(--line);width:80%;max-width:600px;border-radius:12px;position:relative}
        .modal-header{padding-bottom:10px;border-bottom:1px solid var(--line);margin-bottom:20px}
        .modal-header h3{margin:0;font-size:18px}
        .close-btn{color:var(--muted);position:absolute;top:10px;right:20px;font-size:28px;font-weight:bold;cursor:pointer}
        .close-btn:hover{color:var(--text)}
        .modal-body .form-group{margin-bottom:15px;flex-direction:column;align-items:flex-start}
        .modal-body .form-group label{margin-bottom:5px}
        .modal-body .form-group input,.modal-body .form-group select{width:100%}
        .modal-footer{text-align:center;padding-top:20px;border-top:1px solid var(--line);margin-top:20px}
        
        /* Toast Notification Styles */
        #toast-container{position:fixed;bottom:20px;right:20px;z-index:2000}
        .toast{padding:15px 20px;background-color:var(--ok);color:white;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);opacity:0;transition:opacity 0.5s;margin-bottom:10px}
        
        /* Status styles */
        .status{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#fff}
        .status.ok{border-color:#bbf7d0;background:#ecfdf5;color:#166534}
        .status.wait{border-color:#fde68a;background:#fffbeb;color:#92400e}
        .status.bad{border-color:#fecaca;background:#fef2f2;color:#7f1d1d}
        
        /* ì²˜ë¦¬ ì™„ë£Œ ìƒíƒœ ìŠ¤íƒ€ì¼ */
        .status-info {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        .status-info p {
            margin: 8px 0;
        }
        .status-info em {
            color: var(--muted);
            font-style: italic;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container{padding:8px}
            .search-area form{flex-direction:column;align-items:stretch}
            .form-group{flex-direction:column;align-items:stretch}
            input[type="text"]{width:100%}
            .row.two{grid-template-columns:1fr}
            .table-container{overflow-x:auto;margin-top:16px;border-radius:6px}
            table{min-width:900px}
            th,td{padding:6px;font-size:11px}
            .manage-buttons{flex-direction:column;gap:2px}
            .manage-buttons .btn{font-size:10px;padding:4px 6px}
        }
        
        @media (max-width: 480px) {
            .table-container{overflow-x:scroll;margin-top:12px}
            table{min-width:800px}
            th,td{padding:4px;font-size:10px}
            .btn{font-size:11px;padding:6px 8px}
        }

        /* ìŠ¹ì¸/ë°˜ë ¤ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .approval-info {
            max-width: 600px;
            margin: 0 auto;
        }

        .approval-info h4 {
            color: var(--primary);
            margin: 16px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--line);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-item label {
            font-weight: 600;
            color: var(--muted);
            font-size: 14px;
        }

        .info-item span {
            color: var(--text);
            font-size: 14px;
            padding: 4px 0;
        }

        .evidence-section {
            background: var(--bg);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .evidence-content {
            margin-top: 12px;
        }

        .evidence-item {
            margin-bottom: 16px;
        }

        .evidence-item label {
            font-weight: 600;
            color: var(--muted);
            font-size: 14px;
            display: block;
            margin-bottom: 8px;
        }

        .evidence-text {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--line);
            min-height: 60px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.5;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--line);
        }

        .file-name {
            color: var(--primary);
            font-weight: 500;
            font-size: 14px;
        }

        .no-file {
            color: var(--muted);
            font-style: italic;
            font-size: 14px;
        }

        .approval-actions {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--line);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .action-buttons .btn {
            flex: 1;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 14px;
        }

        /* ëª¨ë“  row í´ë¦­ ê°€ëŠ¥ í‘œì‹œ */
        #recordTable tbody tr {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #recordTable tbody tr:hover {
            background-color: #f0f9ff;
            border-left: 4px solid var(--primary);
        }

        #recordTable tbody tr:hover td {
            color: var(--primary);
        }

        /* ìŠ¹ì¸ëŒ€ê¸° row íŠ¹ë³„ í‘œì‹œ */
        #recordTable tbody tr[data-approve="ìŠ¹ì¸ëŒ€ê¸°"] {
            border-left: 3px solid var(--warn);
        }

        #recordTable tbody tr[data-approve="ìŠ¹ì¸ëŒ€ê¸°"]:hover {
            border-left: 4px solid var(--primary);
        }

        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>ì˜ì•½í’ˆí†µí•©ì •ë³´ì‹œìŠ¤í…œ - êµìœ¡ ì‹¤ì  ê´€ë¦¬</h1>
        <div id="userInfo" style="margin-left: auto; color: var(--muted); font-size: 14px;">
            <span id="currentUserInfo">ì‹ ì•½ì‹¬ì‚¬ë¶€ - í™ê¸¸ë™</span>
            <button id="switchUserBtn" style="margin-left: 10px; padding: 4px 8px; font-size: 12px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">ê¶Œí•œ ì „í™˜</button>
        </div>
    </header>

    <nav>
        <a href="#" class="nav-link active" data-target="EDU-003">êµìœ¡ê³¼ì • ê´€ë¦¬</a>
        <a href="#" class="nav-link" data-target="EDU-004">ì‹¬ì‚¬ìë³„ êµìœ¡ ì´ìˆ˜ í˜„í™©</a>
        <a href="#" class="nav-link" data-target="EDU-005">êµìœ¡ ì‹¤ì  í˜„í™© ë³´ê³ ì„œ</a>
    </nav>

    <main class="container">
        <section id="EDU-003" class="active">
            <div class="card">
                <h2>êµìœ¡ê³¼ì • ê´€ë¦¬</h2>
                <div class="search-area">
                    <form id="courseSearchForm">
                         <div class="form-group"><label for="courseNameInput">êµìœ¡ì‚¬ì—…ëª…</label><input type="text" id="courseNameInput"></div>
                         <div class="form-group"><label for="courseDescInput">ì„¸ë¶€ê³¼ì •(í”„ë¡œê·¸ë¨)ëª…</label><input type="text" id="courseDescInput"></div>
                         <div class="form-group date-range"><label for="startDateInput">êµìœ¡ê¸°ê°„</label><input type="date" id="startDateInput" placeholder="ì‹œì‘ì¼"> ~ <input type="date" id="endDateInput" placeholder="ì¢…ë£Œì¼"></div>
                         <div class="form-group"><label for="courseTypeSelect">í•„ìˆ˜ì—¬ë¶€</label><select id="courseTypeSelect"><option value="ì „ì²´">ì „ì²´</option><option value="í•„ìˆ˜">í•„ìˆ˜</option><option value="ì„ íƒ">ì„ íƒ</option></select></div>
                         <div class="form-group"><label for="dataSourceSelect">ë°ì´í„° ì†ŒìŠ¤</label><select id="dataSourceSelect"><option value="ì „ì²´">ì „ì²´</option><option value="API">í‰ê°€ì› êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ</option><option value="EXTERNAL">ì™¸ë¶€ êµìœ¡ê¸°ê´€</option></select></div>
                         <button type="submit" class="btn btn-search">ì¡°íšŒ</button><button type="reset" class="btn btn-secondary">ì´ˆê¸°í™”</button>
                    </form>
                    <div style="margin-top: 12px;">
                        <span id="searchResultInfo" style="color: var(--muted); font-weight: 500;">ê²€ìƒ‰ ê²°ê³¼: ì „ì²´</span>
                </div>
                </div>
                <div class="action-area">
                    <div>
                        <button id="sync-api-btn" class="btn btn-primary">API ë™ê¸°í™”</button>
                        <button id="add-course-btn" class="btn btn-primary">ì‹ ê·œ ë“±ë¡</button>
                        <button id="bulk-insert-btn" class="btn btn-secondary" style="display: none;">ëŒ€ëŸ‰ ë“±ë¡</button>
                    </div>
                </div>
                <div class="table-container">
                <table id="courseTable">
                    <thead><tr>
                        <th class="sortable" data-sort="id">êµìœ¡ID <span class="sort-arrow">â†•</span></th>
                        <th class="sortable" data-sort="name">êµìœ¡ì‚¬ì—…ëª… <span class="sort-arrow">â†•</span></th>
                        <th>ì„¸ë¶€ê³¼ì •(í”„ë¡œê·¸ë¨)ëª…</th>
                        <th class="sortable" data-sort="startDate">êµìœ¡ê¸°ê°„ <span class="sort-arrow">â†•</span></th>
                        <th class="sortable" data-sort="type">í•„ìˆ˜ì—¬ë¶€ <span class="sort-arrow">â†•</span></th>
                        <th class="sortable" data-sort="hours">ì¸ì •ì‹œê°„ <span class="sort-arrow">â†•</span></th>
                            <th class="sortable" data-sort="dataSource">ë°ì´í„° ì†ŒìŠ¤ <span class="sort-arrow">â†•</span></th>
                            <th class="sortable" data-sort="registrant">ë“±ë¡ì <span class="sort-arrow">â†•</span></th>
                        <th class="sortable" data-sort="regDate">ë“±ë¡ì¼ <span class="sort-arrow">â†•</span></th>
                        <th>ê´€ë¦¬</th>
                    </tr></thead>
                    <tbody></tbody>
                </table>
                </div>
            </div>
        </section>

        <section id="EDU-004">
            <div class="card">
                <h2>ì‹¬ì‚¬ìë³„ êµìœ¡ ì´ìˆ˜ í˜„í™©</h2>
                <div class="search-area">
                     <form id="auditorSearchForm">
                        <div class="form-group"><label for="deptSelect">ë¶€ì„œ ì„ íƒ</label><select id="deptSelect"><option value="ì „ì²´">ì „ì²´ ë¶€ì„œ</option><option value="ì‹ ì•½ì‹¬ì‚¬ë¶€">ì‹ ì•½ì‹¬ì‚¬ë¶€</option><option value="í—ˆê°€ì´ê´„ë¶€">í—ˆê°€ì´ê´„ë¶€</option><option value="ìƒë¬¼ì˜ì•½í’ˆë¶€">ìƒë¬¼ì˜ì•½í’ˆë¶€</option><option value="í’ˆì§ˆì•ˆì „ë¶€">í’ˆì§ˆì•ˆì „ë¶€</option><option value="ì„ìƒì •ì±…ë¶€">ì„ìƒì •ì±…ë¶€</option></select></div>
                        <div class="form-group"><label for="auditorNameInput">ì‹¬ì‚¬ì ê²€ìƒ‰</label><input type="text" id="auditorNameInput" placeholder="ì˜ˆ: í™ê¸¸ë™, ê¹€ì² ìˆ˜, ì´ì˜í¬, ë°•ì„ ìš°, ìµœë¯¼ì¤€"></div>
                        <div class="form-group"><label for="courseNameSearchInput">êµìœ¡ì‚¬ì—…ëª…</label><input type="text" id="courseNameSearchInput" placeholder="êµìœ¡ì‚¬ì—…ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></div>
                        <div class="form-group"><label for="courseDescSearchInput">ì„¸ë¶€ê³¼ì •ëª…</label><input type="text" id="courseDescSearchInput" placeholder="ì„¸ë¶€ê³¼ì •ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></div>
                        <div class="form-group date-range"><label for="coursePeriodStartInput">êµìœ¡ê¸°ê°„</label><input type="date" id="coursePeriodStartInput" placeholder="ì‹œì‘ì¼"> ~ <input type="date" id="coursePeriodEndInput" placeholder="ì¢…ë£Œì¼"></div>
                        <div class="form-group date-range"><label for="completionStartInput">ì´ìˆ˜ì¼</label><input type="date" id="completionStartInput" placeholder="ì‹œì‘ì¼"> ~ <input type="date" id="completionEndInput" placeholder="ì¢…ë£Œì¼"></div>
                        <div class="form-group"><label for="courseTypeSearchSelect">í•„ìˆ˜ì—¬ë¶€</label><select id="courseTypeSearchSelect"><option value="ì „ì²´">ì „ì²´</option><option value="í•„ìˆ˜">í•„ìˆ˜</option><option value="ì„ íƒ">ì„ íƒ</option></select></div>
                        <div class="form-group"><label for="dataSourceSearchSelect">ë°ì´í„° ì†ŒìŠ¤</label><select id="dataSourceSearchSelect"><option value="ì „ì²´">ì „ì²´</option><option value="API">í‰ê°€ì› êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ</option><option value="EXTERNAL">ì™¸ë¶€ êµìœ¡ê¸°ê´€</option></select></div>
                        <div class="form-group"><label for="statusSelect">ìƒíƒœ</label><select id="statusSelect"><option value="ì „ì²´">ì „ì²´ ìƒíƒœ</option><option value="ìŠ¹ì¸ì™„ë£Œ">ìŠ¹ì¸ì™„ë£Œ</option><option value="ìŠ¹ì¸ëŒ€ê¸°">ìŠ¹ì¸ëŒ€ê¸°</option><option value="ë°˜ë ¤">ë°˜ë ¤</option><option value="ìë™ìŠ¹ì¸">ìë™ìŠ¹ì¸</option></select></div>
                        <button type="submit" class="btn btn-search">ê²€ìƒ‰</button>
                    </form>
                </div>
                <!-- auditorInfoBox ì œê±° -->
                <div class="action-area">
                    <div>
                        <button id="sync-records-api-btn" class="btn btn-primary">API ë™ê¸°í™”</button>
                        <button class="btn btn-primary" id="add-record-btn">ì´ìˆ˜ ê¸°ë¡ ë“±ë¡</button>
                        <button id="bulk-insert-records-btn" class="btn btn-secondary" style="display: none;">ì´ìˆ˜ ê¸°ë¡ ëŒ€ëŸ‰ ë“±ë¡</button>
                    </div>
                </div>
                <div class="table-hint">
                    ğŸ’¡ í–‰ì„ í´ë¦­í•˜ë©´ ì´ìˆ˜ ê¸°ë¡ì˜ ìƒì„¸ ì •ë³´ì™€ ì¦ë¹™ìë£Œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                </div>
                <div class="table-container">
                <table id="recordTable">
                    <thead><tr>
                        <th>ê³ ìœ ID</th>
                        <th>ë¶€ì„œ</th>
                        <th>ì„±ëª…</th>
                        <th>êµìœ¡ì‚¬ì—…ëª…</th>
                        <th>ì„¸ë¶€ê³¼ì •(í”„ë¡œê·¸ë¨)ëª…</th>
                        <th>êµìœ¡ê¸°ê°„</th>
                        <th>ì´ìˆ˜ì¼</th>
                        <th>í•„ìˆ˜ì—¬ë¶€</th>
                        <th>ì¸ì •ì‹œê°„</th>
                            <th>ë°ì´í„° ì†ŒìŠ¤</th>
                            <th>ë“±ë¡ì</th>
                        <th>ìƒíƒœ</th>
                        <th>ê´€ë¦¬</th>
                    </tr></thead>
                    <tbody></tbody>
                </table>
                </div>
            </div>
        </section>

        <section id="EDU-005">
            <div class="card">
                <h2>êµìœ¡ ì‹¤ì  í˜„í™© ë³´ê³ ì„œ</h2>
                
                <!-- ë³´ê³ ì„œ ìœ í˜• ì„ íƒ -->
                <div class="report-type-selector" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 16px; color: var(--text);">ë³´ê³ ì„œ ìœ í˜• ì„ íƒ</h3>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="reportType" value="personal" checked>
                            <span>ê°œì¸ë³„ ë³´ê³ ì„œ</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="reportType" value="department">
                            <span>ë¶€ì„œë³„ ë³´ê³ ì„œ</span>
                        </label>
                    </div>
                </div>

                <!-- ê°œì¸ë³„ ë³´ê³ ì„œ -->
                <div id="personalReport" class="report-section">
                    <h3 style="margin: 0 0 15px 0; font-size: 18px; color: var(--primary);">ê°œì¸ë³„ êµìœ¡ ì‹¤ì  ë³´ê³ ì„œ</h3>
                    <div class="search-area">
                        <form id="personalReportForm">
                            <div class="form-group"><label>ì¡°íšŒê¸°ê°„</label><input type="date" id="personalStartDate"> ~ <input type="date" id="personalEndDate"></div>
                            <div class="form-group"><label for="personalDeptSelect">ë¶€ì„œ</label><select id="personalDeptSelect"><option value="">ì „ì²´ ë¶€ì„œ</option><option value="ì‹ ì•½ì‹¬ì‚¬ë¶€">ì‹ ì•½ì‹¬ì‚¬ë¶€</option><option value="í—ˆê°€ì´ê´„ë¶€">í—ˆê°€ì´ê´„ë¶€</option><option value="ìƒë¬¼ì˜ì•½í’ˆë¶€">ìƒë¬¼ì˜ì•½í’ˆë¶€</option><option value="í’ˆì§ˆì•ˆì „ë¶€">í’ˆì§ˆì•ˆì „ë¶€</option><option value="ì„ìƒì •ì±…ë¶€">ì„ìƒì •ì±…ë¶€</option></select></div>
                            <div class="form-group"><label for="personalAuditorInput">ì‹¬ì‚¬ì</label><input type="text" id="personalAuditorInput" placeholder="ì‹¬ì‚¬ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í™ê¸¸ë™, ê¹€ì² ìˆ˜)"></div>
                            <button type="submit" class="btn btn-search">ì¡°íšŒ</button><button type="reset" class="btn btn-secondary">ì´ˆê¸°í™”</button>
                        </form>
                    </div>
                    <div class="action-area" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span id="personalReportSummary"></span>
                        <div><button id="personalExcelBtn" class="btn btn-primary">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button><button id="personalPrintBtn" class="btn btn-secondary">ì¸ì‡„</button></div>
                    </div>
                    <div class="table-container">
                        <table id="personalReportTable">
                            <thead><tr>
                                <th>ê³ ìœ ID</th>
                                <th>ë¶€ì„œ</th>
                                <th>ì„±ëª…</th>
                                <th>êµìœ¡ì‚¬ì—…ëª…</th>
                                <th>ì„¸ë¶€ê³¼ì •(í”„ë¡œê·¸ë¨)ëª…</th>
                                <th>êµìœ¡ê¸°ê°„</th>
                                <th>ì´ìˆ˜ì¼ì</th>
                                <th>ì¸ì •ì‹œê°„</th>
                                <th>ìƒíƒœ</th>
                                <th>ë°ì´í„°ì†ŒìŠ¤</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- ë¶€ì„œë³„ ë³´ê³ ì„œ -->
                <div id="departmentReport" class="report-section" style="display: none;">
                    <h3 style="margin: 0 0 15px 0; font-size: 18px; color: var(--primary);">ë¶€ì„œë³„ êµìœ¡ ì‹¤ì  ë³´ê³ ì„œ</h3>
                    <div class="search-area">
                        <form id="departmentReportForm">
                            <div class="form-group"><label>ì¡°íšŒê¸°ê°„</label><input type="date" id="deptStartDate"> ~ <input type="date" id="deptEndDate"></div>
                            <div class="form-group"><label for="deptReportSelect">ë¶€ì„œ</label><select id="deptReportSelect"><option value="">ì „ì²´ ë¶€ì„œ</option><option value="ì‹ ì•½ì‹¬ì‚¬ë¶€">ì‹ ì•½ì‹¬ì‚¬ë¶€</option><option value="í—ˆê°€ì´ê´„ë¶€">í—ˆê°€ì´ê´„ë¶€</option><option value="ìƒë¬¼ì˜ì•½í’ˆë¶€">ìƒë¬¼ì˜ì•½í’ˆë¶€</option><option value="í’ˆì§ˆì•ˆì „ë¶€">í’ˆì§ˆì•ˆì „ë¶€</option><option value="ì„ìƒì •ì±…ë¶€">ì„ìƒì •ì±…ë¶€</option></select></div>
                            <div class="form-group"><label for="deptAuditorInput">ì‹¬ì‚¬ì</label><input type="text" id="deptAuditorInput" placeholder="ì‹¬ì‚¬ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í™ê¸¸ë™, ê¹€ì² ìˆ˜)"></div>
                            <button type="submit" class="btn btn-search">ì¡°íšŒ</button><button type="reset" class="btn btn-secondary">ì´ˆê¸°í™”</button>
                        </form>
                    </div>
                    <div class="action-area" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span id="departmentReportSummary"></span>
                        <div><button id="departmentExcelBtn" class="btn btn-primary">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button><button id="departmentPrintBtn" class="btn btn-secondary">ì¸ì‡„</button></div>
                    </div>
                    <div class="table-container">
                        <table id="reportTable">
                            <thead><tr>
                                <th>ë¶€ì„œ</th>
                                <th>ì„±ëª…</th>
                                <th>êµìœ¡ì‚¬ì—…ëª…</th>
                                <th>ì„¸ë¶€ê³¼ì •(í”„ë¡œê·¸ë¨)ëª…</th>
                                <th>êµìœ¡ê¸°ê°„</th>
                                <th>ì´ìˆ˜ì¼ì</th>
                                <th>í•„ìˆ˜ì—¬ë¶€</th>
                                <th>ì¸ì •ì‹œê°„</th>
                                <th>ìƒíƒœ</th>
                                <th>ë°ì´í„°ì†ŒìŠ¤</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </main>
    
    <div id="modal-popup" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-title"></h3><span class="close-btn">&times;</span></div>
            <form id="modal-form">
                <input type="hidden" id="modal-edit-id">
                <div class="modal-body" id="modal-body-content">
                    </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                    <button type="button" class="btn btn-secondary close-btn-bottom">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>

    <script src="database.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- ë°ì´í„°ë² ì´ìŠ¤ ë° ìƒíƒœ ê´€ë¦¬ ---
        let db = {};
        let currentAuditor = null;
        let currentStatus = null;
        let sortState = {};

        // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°ì´í„° ë¡œë“œ
        const initData = () => {
            // ë³„ë„ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì—ì„œ ë°ì´í„° ë¡œë“œ
            db = {
                courses: EducationDatabase.courses,
                auditors: EducationDatabase.auditors
            };
            
            // í˜„ì¬ ì‚¬ìš©ì ì„¤ì •
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
            } else {
                currentUser = EducationDatabase.users["í™ê¸¸ë™"];
            }
        };
                
        
        

        const saveData = () => {
            localStorage.setItem('eduDb', JSON.stringify(db));
            showToast('ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        };
        
        // --- UI ë Œë”ë§ í•¨ìˆ˜ ---
        const renderAll = () => {
            renderCourseTable();
            renderRecordTable();
        };

        const renderCourseTable = (filterFn = () => true) => {
            const tbody = document.querySelector('#courseTable tbody');
            tbody.innerHTML = '';
            const filteredCourses = db.courses.filter(filterFn);
            
            // ê²€ìƒ‰ ê²°ê³¼ ê°œìˆ˜ í‘œì‹œ
            const searchResultInfo = document.getElementById('searchResultInfo');
            if (searchResultInfo) {
                searchResultInfo.textContent = `ê²€ìƒ‰ ê²°ê³¼: ${filteredCourses.length}ê±´`;
            }
            
            if (filteredCourses.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="10" style="text-align: center; padding: 40px; color: var(--muted);">ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” êµìœ¡ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</td>';
                return;
            }
            
            filteredCourses.forEach(c => {
                const row = tbody.insertRow();
                row.dataset.id = c.id;
                row.style.cursor = 'pointer';
                
                // ë°ì´í„° ì†ŒìŠ¤ í‘œì‹œ
                let dataSourceDisplay = '';
                if (c.dataSource === 'API') {
                    dataSourceDisplay = '<span class="status ok">í‰ê°€ì› êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ</span>';
                } else if (c.dataSource === 'EXTERNAL') {
                    dataSourceDisplay = '<span class="status wait">ì™¸ë¶€ êµìœ¡ê¸°ê´€</span>';
                } else {
                    dataSourceDisplay = '<span class="status bad">ë¯¸ë¶„ë¥˜</span>';
                }
                
                // ê´€ë¦¬ ë²„íŠ¼ (êµìœ¡ê´€ë¦¬ìë§Œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥)
                let manageButtons = '';
                const currentUser = getCurrentUser();
                const isEducationManager = currentUser && currentUser.role === 'EDUCATION_MANAGER';
                
                if (c.dataSource === 'API') {
                    manageButtons = '<div class="manage-buttons"><button class="btn btn-secondary" style="height:30px;padding:0 10px;" disabled>í‰ê°€ì› ë°ì´í„°</button></div>';
                } else if (isEducationManager) {
                    manageButtons = `
                        <div class="manage-buttons">
                        <button class="btn btn-secondary btn-edit-course" style="height:30px;padding:0 10px;">ìˆ˜ì •</button>
                        <button class="btn btn-danger btn-delete-course" style="height:30px;padding:0 10px;">ì‚­ì œ</button>
                        </div>`;
                } else {
                    manageButtons = '<div class="manage-buttons"><button class="btn btn-secondary" style="height:30px;padding:0 10px;" disabled>ê´€ë¦¬ ë¶ˆê°€</button></div>';
                }
                
                row.innerHTML = `
                    <td>${c.id}</td>
                    <td>${c.name}</td>
                    <td>${c.desc || 'êµìœ¡ê³¼ì • ìƒì„¸ì •ë³´'}</td>
                    <td>${c.startDate} ~ ${c.endDate}</td>
                    <td><span class="status ${c.type === 'í•„ìˆ˜' ? 'ok' : 'wait'}">${c.type}</span></td>
                    <td>${c.hours}</td>
                    <td>${dataSourceDisplay}</td>
                    <td>${c.registrant || '-'}</td>
                    <td>${c.regDate}</td>
                    <td>${manageButtons}</td>`;
            });
        };

        // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ í‘œì‹œëœ ê¸°ë¡ë“¤ì„ ì €ì¥
        let currentDisplayedRecords = [];

        const renderRecordTable = () => {
            const dept = document.getElementById('deptSelect')?.value || 'ì „ì²´';
            const nameFilter = document.getElementById('auditorNameInput')?.value || '';
            const courseNameFilter = document.getElementById('courseNameSearchInput')?.value || '';
            const courseDescFilter = document.getElementById('courseDescSearchInput')?.value || '';
            const coursePeriodStart = document.getElementById('coursePeriodStartInput')?.value || '';
            const coursePeriodEnd = document.getElementById('coursePeriodEndInput')?.value || '';
            const completionStart = document.getElementById('completionStartInput')?.value || '';
            const completionEnd = document.getElementById('completionEndInput')?.value || '';
            const courseTypeFilter = document.getElementById('courseTypeSearchSelect')?.value || 'ì „ì²´';
            const dataSourceFilter = document.getElementById('dataSourceSearchSelect')?.value || 'ì „ì²´';
            const statusFilter = document.getElementById('statusSelect')?.value || 'ì „ì²´';
            console.log('renderRecordTable í˜¸ì¶œ - ë¶€ì„œ:', dept, 'ì´ë¦„ í•„í„°:', nameFilter, 'êµìœ¡ì‚¬ì—…ëª… í•„í„°:', courseNameFilter, 'ì„¸ë¶€ê³¼ì •ëª… í•„í„°:', courseDescFilter, 'êµìœ¡ê¸°ê°„:', coursePeriodStart, '~', coursePeriodEnd, 'ì´ìˆ˜ì¼:', completionStart, '~', completionEnd, 'í•„ìˆ˜ì—¬ë¶€:', courseTypeFilter, 'ë°ì´í„°ì†ŒìŠ¤:', dataSourceFilter, 'ìƒíƒœ í•„í„°:', statusFilter);
            
            const tbody = document.querySelector('#recordTable tbody');
            tbody.innerHTML = '';
            currentDisplayedRecords = []; // ì´ˆê¸°í™”

            // ë¶€ì„œë³„ë¡œ ì‹¬ì‚¬ì í•„í„°ë§
            let filteredAuditors = Object.entries(db.auditors);
            console.log('ì „ì²´ ì‹¬ì‚¬ì ìˆ˜:', filteredAuditors.length);
            
            if (dept !== 'ì „ì²´') {
                filteredAuditors = filteredAuditors.filter(([name, auditor]) => 
                    auditor.info.dept === dept
                );
                console.log('ë¶€ì„œ í•„í„°ë§ í›„ ì‹¬ì‚¬ì ìˆ˜:', filteredAuditors.length, 'ë¶€ì„œ:', dept);
            }
            
            if (nameFilter) {
                filteredAuditors = filteredAuditors.filter(([name, auditor]) => 
                    name.toLowerCase().includes(nameFilter.toLowerCase())
                );
            }

            if (filteredAuditors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            // ë¶€ì„œì— ì†í•œ ëª¨ë“  ì‹¬ì‚¬ì ê²°ê³¼ í‘œì‹œ (ì´ìˆ˜ ê¸°ë¡ë§Œ)
            filteredAuditors.forEach(([name, auditor]) => {
                let recordsToDisplay = auditor.records.map(r => {
                    const course = db.courses.find(c => c.id === r.courseId);
                    return { 
                        ...r, 
                        // course ì •ë³´ëŠ” ë³„ë„ í•„ë“œë¡œ ì¶”ê°€ (ID ì¶©ëŒ ë°©ì§€)
                        courseName: course?.name,
                        courseDesc: course?.desc,
                        courseStartDate: course?.startDate,
                        courseEndDate: course?.endDate,
                        courseType: course?.type,
                        courseHours: course?.hours,
                        courseRegDate: course?.regDate,
                        courseOrgName: course?.orgName,
                        courseRegistrant: course?.registrant,
                        status: 'completed', 
                        // ì›ë³¸ approve ê°’ ì‚¬ìš© (ì—†ìœ¼ë©´ ì™¸ë¶€ êµìœ¡ê¸°ê´€ì€ ìŠ¹ì¸ëŒ€ê¸°, APIëŠ” ìŠ¹ì¸)
                        approve: (() => {
                            // ì›ë³¸ ë°ì´í„°ì— approve ê°’ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                            if (r.approve !== undefined && r.approve !== null && r.approve !== '') {
                                console.log('Using original approve value:', r.approve, 'for record:', r.id);
                                return r.approve;
                            }
                            // ì›ë³¸ ë°ì´í„°ì— approve ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
                            const result = r.dataSource === 'EXTERNAL' ? 'ìŠ¹ì¸ëŒ€ê¸°' : 'ìŠ¹ì¸';
                            console.log('Using default approve value:', result, 'for record:', r.id);
                            return result;
                        })(),
                        auditorName: name, 
                        auditorDept: auditor.info.dept, 
                        // ìŠ¹ì¸ëŒ€ê¸° ìƒíƒœë©´ í•­ìƒ EXTERNALë¡œ í‘œì‹œ, ì•„ë‹ˆë©´ ì›ë³¸ dataSource ì‚¬ìš©
                        dataSource: (() => {
                            const originalApprove = r.approve;
                            const originalDataSource = r.dataSource;
                            const result = (originalApprove === 'ìŠ¹ì¸ëŒ€ê¸°' || originalDataSource === 'EXTERNAL') ? 'EXTERNAL' : (originalDataSource || 'EXTERNAL');
                            console.log('Data source processing for record', r.id, 'originalApprove:', originalApprove, 'originalDataSource:', originalDataSource, 'result:', result);
                            return result;
                        })(),
                        registrant: r.registrant || name
                    };
                });
                
                // ìƒíƒœ í•„í„°ë§ ì ìš©
                if (statusFilter !== 'ì „ì²´') {
                    recordsToDisplay = recordsToDisplay.filter(rec => {
                        if (statusFilter === 'ìŠ¹ì¸ì™„ë£Œ') {
                            return rec.approve === 'ìŠ¹ì¸';
                        } else if (statusFilter === 'ìŠ¹ì¸ëŒ€ê¸°') {
                            return rec.approve === 'ìŠ¹ì¸ëŒ€ê¸°';
                        } else if (statusFilter === 'ë°˜ë ¤') {
                            return rec.approve === 'ë°˜ë ¤';
                        } else if (statusFilter === 'ìë™ìŠ¹ì¸') {
                            return rec.approve === 'ìŠ¹ì¸' && rec.dataSource === 'API';
                        }
                        return true;
                    });
                }
                
                // êµìœ¡ì‚¬ì—…ëª… í•„í„°ë§
                if (courseNameFilter) {
                    recordsToDisplay = recordsToDisplay.filter(rec => 
                        rec.courseName && rec.courseName.toLowerCase().includes(courseNameFilter.toLowerCase())
                    );
                }
                
                // ì„¸ë¶€ê³¼ì •ëª… í•„í„°ë§
                if (courseDescFilter) {
                    recordsToDisplay = recordsToDisplay.filter(rec => 
                        rec.courseDesc && rec.courseDesc.toLowerCase().includes(courseDescFilter.toLowerCase())
                    );
                }
                
                // êµìœ¡ê¸°ê°„ í•„í„°ë§
                if (coursePeriodStart || coursePeriodEnd) {
                    recordsToDisplay = recordsToDisplay.filter(rec => {
                        if (!rec.courseStartDate && !rec.courseEndDate) return false;
                        
                        const courseStart = rec.courseStartDate;
                        const courseEnd = rec.courseEndDate;
                        
                        if (coursePeriodStart && courseEnd && courseEnd < coursePeriodStart) return false;
                        if (coursePeriodEnd && courseStart && courseStart > coursePeriodEnd) return false;
                        
                        return true;
                    });
                }
                
                // ì´ìˆ˜ì¼ í•„í„°ë§
                if (completionStart || completionEnd) {
                    recordsToDisplay = recordsToDisplay.filter(rec => {
                        if (!rec.date) return false;
                        
                        const completionDate = rec.date;
                        
                        if (completionStart && completionDate < completionStart) return false;
                        if (completionEnd && completionDate > completionEnd) return false;
                        
                        return true;
                    });
                }
                
                // í•„ìˆ˜ì—¬ë¶€ í•„í„°ë§
                if (courseTypeFilter !== 'ì „ì²´') {
                    recordsToDisplay = recordsToDisplay.filter(rec => 
                        rec.courseType === courseTypeFilter
                    );
                }
                
                // ë°ì´í„° ì†ŒìŠ¤ í•„í„°ë§
                if (dataSourceFilter !== 'ì „ì²´') {
                    recordsToDisplay = recordsToDisplay.filter(rec => 
                        rec.dataSource === dataSourceFilter
                    );
                }
                
                recordsToDisplay.forEach((rec, index) => {
                    const row = tbody.insertRow();
                    
                    // database.jsì—ì„œ uniqueId ê°€ì ¸ì˜¤ê¸°
                    const recordUniqueId = rec.uniqueId || `row_${name.replace(/\s+/g, '')}_${rec.id}`;
                    
                    // ê³ ìœ í•œ row ID ìƒì„± (ë¬¸ì+ìˆ«ì í˜•íƒœ)
                    const rowId = `${recordUniqueId}_${index}`;
                    row.id = rowId;
                    
                    row.dataset.id = rec.id;
                    row.dataset.courseId = rec.courseId;
                    row.dataset.approve = rec.approve || 'ìŠ¹ì¸';
                    
                    // ì›ë³¸ ê¸°ë¡ IDë¥¼ ë³´ì¡´í•˜ê¸° ìœ„í•´ originalId ì¶”ê°€ (ì‹¬ì‚¬ìë³„ ê³ ìœ  ID)
                    const recordWithOriginalId = {
                        ...rec,
                        originalId: `${name}_${rec.id}` // ì‹¬ì‚¬ìëª…_ì›ë³¸IDë¡œ ê³ ìœ  ID ìƒì„±
                    };
                    
                    // í˜„ì¬ í‘œì‹œëœ ê¸°ë¡ì— ì¶”ê°€
                    currentDisplayedRecords.push(recordWithOriginalId);
                    
                    // ìƒíƒœ í‘œì‹œ (ìŠ¹ì¸/ë°˜ë ¤/ëŒ€ê¸°)
                    let statusDisplay = '-';
                    if (rec.status === 'completed') {
                        if (rec.approve === 'ìŠ¹ì¸') {
                            statusDisplay = '<span class="status ok">ìŠ¹ì¸</span>';
                        } else if (rec.approve === 'ë°˜ë ¤') {
                            statusDisplay = '<span class="status bad">ë°˜ë ¤</span>';
                        } else {
                            statusDisplay = '<span class="status wait">ìŠ¹ì¸ëŒ€ê¸°</span>';
                        }
                    }
                    
                    // ê´€ë¦¬ ë²„íŠ¼ (ê¶Œí•œì— ë”°ë¼ ë‹¤ë¥´ê²Œ í‘œì‹œ)
                    let manageButtons = '-';
                    const currentUser = getCurrentUser();
                    const isEducationManager = currentUser && currentUser.role === 'EDUCATION_MANAGER';
                    const isOwnRecord = rec.auditorName === currentUser?.userName;
                    
                    if (rec.status === 'completed') {
                        if (rec.dataSource === 'API') {
                            manageButtons = '<div class="manage-buttons"><button class="btn btn-secondary" style="height:28px;padding:0 8px;font-size:12px;" disabled>API ë°ì´í„°</button></div>';
                        } else if (rec.approve === 'ìŠ¹ì¸ëŒ€ê¸°') {
                            // ìŠ¹ì¸ëŒ€ê¸° ìƒíƒœì¸ ê²½ìš°
                            if (isEducationManager) {
                                // êµìœ¡ê´€ë¦¬ ê¶Œí•œì´ ìˆìœ¼ë©´ ìŠ¹ì¸, ë°˜ë ¤, ìˆ˜ì •, ì‚­ì œ ëª¨ë‘ ê°€ëŠ¥
                            manageButtons = `
                                <div class="manage-buttons">
                                    <button class="btn btn-primary btn-approve-record" style="height:28px;padding:0 8px;font-size:12px;">ìŠ¹ì¸</button>
                                    <button class="btn btn-danger btn-reject-record" style="height:28px;padding:0 8px;font-size:12px;">ë°˜ë ¤</button>
                                    <button class="btn btn-secondary btn-edit-record" style="height:28px;padding:0 8px;font-size:12px;">ìˆ˜ì •</button>
                                        <button class="btn btn-danger btn-delete-record" style="height:28px;padding:0 8px;font-size:12px;">ì‚­ì œ</button>
                                    </div>
                                    <div class="click-hint" style="font-size:11px;color:var(--muted);margin-top:4px;">
                                        ğŸ’¡ í–‰ì„ í´ë¦­í•˜ì—¬ ì¦ë¹™ìë£Œ í™•ì¸
                                    </div>`;
                            } else if (isOwnRecord) {
                                // ë³¸ì¸ ê¸°ë¡ì´ë©´ ìˆ˜ì •ë§Œ ê°€ëŠ¥
                                manageButtons = `
                                    <div class="manage-buttons">
                                        <button class="btn btn-secondary btn-edit-record" style="height:28px;padding:0 8px;font-size:12px;">ìˆ˜ì •</button>
                                </div>
                                <div class="click-hint" style="font-size:11px;color:var(--muted);margin-top:4px;">
                                    ğŸ’¡ í–‰ì„ í´ë¦­í•˜ì—¬ ì¦ë¹™ìë£Œ í™•ì¸
                                </div>`;
                        } else {
                                // ë‹¤ë¥¸ ì‚¬ëŒì˜ ìŠ¹ì¸ëŒ€ê¸° ê¸°ë¡ì€ ê´€ë¦¬ ë¶ˆê°€
                                manageButtons = '<div class="manage-buttons"><button class="btn btn-secondary" style="height:28px;padding:0 8px;font-size:12px;" disabled>ê´€ë¦¬ ë¶ˆê°€</button></div>';
                            }
                        } else {
                            // ìŠ¹ì¸ ë˜ëŠ” ë°˜ë ¤ëœ ê¸°ë¡
                            if (isEducationManager) {
                                // êµìœ¡ê´€ë¦¬ ê¶Œí•œì´ ìˆìœ¼ë©´ ì‚­ì œ ê°€ëŠ¥
                            manageButtons = `
                                <div class="manage-buttons">
                                    <button class="btn btn-danger btn-delete-record" style="height:28px;padding:0 8px;font-size:12px;">ì‚­ì œ</button>
                                </div>`;
                            } else if (isOwnRecord) {
                                // ë³¸ì¸ ê¸°ë¡ì´ë©´ ì‚­ì œ ê°€ëŠ¥
                                manageButtons = `
                                    <div class="manage-buttons">
                                        <button class="btn btn-danger btn-delete-record" style="height:28px;padding:0 8px;font-size:12px;">ì‚­ì œ</button>
                                    </div>`;
                            } else {
                                // ë‹¤ë¥¸ ì‚¬ëŒì˜ ìŠ¹ì¸/ë°˜ë ¤ ê¸°ë¡ì€ ê´€ë¦¬ ë¶ˆê°€
                                manageButtons = '<div class="manage-buttons"><button class="btn btn-secondary" style="height:28px;padding:0 8px;font-size:12px;" disabled>ê´€ë¦¬ ë¶ˆê°€</button></div>';
                            }
                        }
                    }
                    
                    // ë°ì´í„° ì†ŒìŠ¤ í‘œì‹œ (ìŠ¹ì¸ëŒ€ê¸° ìƒíƒœë©´ í•­ìƒ ì™¸ë¶€ êµìœ¡ê¸°ê´€ìœ¼ë¡œ í‘œì‹œ)
                    let dataSourceDisplay = '';
                    if (rec.approve === 'ìŠ¹ì¸ëŒ€ê¸°') {
                        dataSourceDisplay = '<span class="status wait">ì™¸ë¶€ êµìœ¡ê¸°ê´€</span>';
                    } else if (rec.dataSource === 'API') {
                        dataSourceDisplay = '<span class="status ok">í‰ê°€ì› êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ</span>';
                    } else if (rec.dataSource === 'EXTERNAL') {
                        dataSourceDisplay = '<span class="status wait">ì™¸ë¶€ êµìœ¡ê¸°ê´€</span>';
                    } else {
                        dataSourceDisplay = '<span class="status bad">ë¯¸ë¶„ë¥˜</span>';
                    }
                    
                    row.innerHTML = `
                        <td>${recordUniqueId}</td>
                        <td>${rec.auditorDept || '-'}</td>
                        <td>${rec.auditorName || '-'}</td>
                        <td>${rec.courseName || '-'}</td>
                        <td>${rec.courseDesc || '-'}</td>
                        <td>${rec.courseStartDate ? `${rec.courseStartDate} ~ ${rec.courseEndDate}` : '-'}</td>
                        <td>${rec.date || '-'}</td>
                        <td><span class="status ${rec.courseType === 'í•„ìˆ˜' ? 'ok' : 'wait'}">${rec.courseType || '-'}</span></td>
                        <td>${rec.courseHours || 0}</td>
                        <td>${dataSourceDisplay}</td>
                        <td>${rec.registrant || '-'}</td>
                        <td>${statusDisplay}</td>
                        <td>${manageButtons}</td>`;
                });
            });
        };

        // ê°œì¸ë³„ ë³´ê³ ì„œ ë Œë”ë§
        const renderPersonalReport = (startDate, endDate, deptFilter, auditorName) => {
            console.log('=== ê°œì¸ë³„ ë³´ê³ ì„œ ë Œë”ë§ ì‹œì‘ ===');
            console.log('startDate:', startDate, 'endDate:', endDate, 'deptFilter:', deptFilter, 'auditorName:', auditorName);
            
            const tbody = document.querySelector('#personalReportTable tbody');
            if (!tbody) {
                console.error('personalReportTable tbodyë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            tbody.innerHTML = '';

            let count = 0;
            let totalHours = 0;
            let completedCount = 0;

            // ë¶€ì„œë³„ë¡œ ëª¨ë“  ì‹¬ì‚¬ì ê²€ìƒ‰
            Object.entries(db.auditors).forEach(([name, auditor]) => {
                // ë¶€ì„œ í•„í„°ë§
                const deptMatch = !deptFilter || deptFilter === '' ? true : auditor.info.dept === deptFilter;
                // ì‹¬ì‚¬ì ì´ë¦„ í•„í„°ë§
                const nameMatch = !auditorName || auditorName === '' ? true : name.toLowerCase().includes(auditorName.toLowerCase());
                
                console.log(`ì‹¬ì‚¬ì ${name}: ë¶€ì„œ=${auditor.info.dept}, deptFilter=${deptFilter}, deptMatch=${deptMatch}, nameMatch=${nameMatch}`);
                
                if (auditor.records && deptMatch && nameMatch) {
            auditor.records.forEach(record => {
                const course = db.courses.find(c => c.id === record.courseId);
                if (course) {
                    const recordDate = record.date;
                    const isInRange = (!startDate || recordDate >= startDate) && (!endDate || recordDate <= endDate);
                    const isApproved = record.approve === 'ìŠ¹ì¸';
                    
                    if (isInRange && isApproved) {
                        const row = tbody.insertRow();
                        
                        // ê³ ìœ í•œ row ID ìƒì„± (ë¬¸ì+ìˆ«ì í˜•íƒœ)
                        const rowId = `report_row_${name.replace(/\s+/g, '')}_${record.id}_${Date.now()}`;
                        row.id = rowId;
                        
                        // database.jsì—ì„œ uniqueId ê°€ì ¸ì˜¤ê¸°
                        const recordUniqueId = record.uniqueId || `row_${name.replace(/\s+/g, '')}_${record.id}`;
                        
                        row.innerHTML = `
                            <td>${recordUniqueId}</td>
                            <td>${auditor.info.dept}</td>
                            <td>${name}</td>
                            <td>${course.name}</td>
                            <td>${course.desc || '-'}</td>
                            <td>${course.startDate ? `${course.startDate} ~ ${course.endDate}` : '-'}</td>
                            <td>${recordDate}</td>
                            <td>${course.hours}ì‹œê°„</td>
                            <td><span class="status ${record.approve === 'ìŠ¹ì¸' ? 'ok' : record.approve === 'ë°˜ë ¤' ? 'error' : 'wait'}">${record.approve || 'ìŠ¹ì¸ëŒ€ê¸°'}</span></td>
                            <td>${record.dataSource === 'API' ? 'í‰ê°€ì› êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ' : 'ì™¸ë¶€ êµìœ¡ê¸°ê´€'}</td>
                        `;
                        count++;
                        totalHours += course.hours;
                        completedCount++;
                    }
                }
                    });
                }
            });

            if (count === 0) {
                tbody.innerHTML = '<tr><td colspan="10">ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ì´ìˆ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }

            document.getElementById('personalReportSummary').innerHTML = `
                <strong>ê²€ìƒ‰ ê²°ê³¼:</strong> ì´ ${count}ê±´ | 
                <strong>ì´ ì´ìˆ˜ì‹œê°„:</strong> ${totalHours}ì‹œê°„ | 
                <strong>ìŠ¹ì¸ ì™„ë£Œ:</strong> ${completedCount}ê±´
            `;
        };

        // ë¶€ì„œë³„ ë³´ê³ ì„œ ë Œë”ë§
        const renderDepartmentReport = (startDate, endDate, deptFilter, auditorName) => {
            console.log('=== ë¶€ì„œë³„ ë³´ê³ ì„œ ë Œë”ë§ ì‹œì‘ ===');
            console.log('startDate:', startDate, 'endDate:', endDate, 'deptFilter:', deptFilter, 'auditorName:', auditorName);
            console.log('deptFilter type:', typeof deptFilter, 'deptFilter === "":', deptFilter === '', 'deptFilter === "ì „ì²´":', deptFilter === 'ì „ì²´');
            
            const tbody = document.querySelector('#reportTable tbody');
            if (!tbody) {
                console.error('reportTable tbodyë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            tbody.innerHTML = '';

            let count = 0;
            let totalHours = 0;
            let completedCount = 0;
            const deptStats = {};
            const participantStats = {}; // ì°¸ì—¬ìë³„ í†µê³„

            Object.entries(db.auditors).forEach(([name, auditor]) => {
                // ë¶€ì„œ í•„í„°ë§ (ì „ì²´ ë¶€ì„œ ë˜ëŠ” ë¹ˆ ê°’ì¼ ë•ŒëŠ” ëª¨ë“  ë¶€ì„œ í¬í•¨)
                const deptMatch = !deptFilter || deptFilter === '' || deptFilter === 'ì „ì²´' ? true : auditor.info.dept === deptFilter;
                // ì‹¬ì‚¬ì ì´ë¦„ í•„í„°ë§
                const nameMatch = !auditorName || auditorName === '' ? true : name.toLowerCase().includes(auditorName.toLowerCase());
                
                console.log(`ì‹¬ì‚¬ì ${name}: ë¶€ì„œ=${auditor.info.dept}, deptFilter=${deptFilter}, deptMatch=${deptMatch}, nameMatch=${nameMatch}, records=${auditor.records ? auditor.records.length : 0}`);
                
                if (auditor.records && deptMatch && nameMatch) {
                    if (!deptStats[auditor.info.dept]) {
                        deptStats[auditor.info.dept] = { total: 0, completed: 0, hours: 0 };
                    }

                    auditor.records.forEach(record => {
                        const course = db.courses.find(c => c.id === record.courseId);
                        if (course) {
                            const recordDate = record.date;
                            const isInRange = (!startDate || recordDate >= startDate) && (!endDate || recordDate <= endDate);
                            const isApproved = record.approve === 'ìŠ¹ì¸';
                            
                            if (isInRange && isApproved) {
                                const row = tbody.insertRow();
                                
                                // database.jsì—ì„œ uniqueId ê°€ì ¸ì˜¤ê¸°
                                const recordUniqueId = record.uniqueId || `row_${name.replace(/\s+/g, '')}_${record.id}`;
                                
                                // ê³ ìœ í•œ row ID ìƒì„± (ë¬¸ì+ìˆ«ì í˜•íƒœ)
                                const rowId = `dept_report_${recordUniqueId}_${Date.now()}`;
                                row.id = rowId;
                                
                                row.innerHTML = `
                                    <td>${auditor.info.dept}</td>
                                    <td>${name}</td>
                                    <td>${course.name}</td>
                                    <td>${course.desc || '-'}</td>
                                    <td>${course.startDate ? `${course.startDate} ~ ${course.endDate}` : '-'}</td>
                                    <td>${recordDate}</td>
                                    <td><span class="status ${course.type === 'í•„ìˆ˜' ? 'ok' : 'wait'}">${course.type || '-'}</span></td>
                                    <td>${course.hours}ì‹œê°„</td>
                                    <td><span class="status ${record.approve === 'ìŠ¹ì¸' ? 'ok' : record.approve === 'ë°˜ë ¤' ? 'error' : 'wait'}">${record.approve || 'ìŠ¹ì¸ëŒ€ê¸°'}</span></td>
                                    <td>${record.dataSource === 'API' ? 'í‰ê°€ì› êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ' : 'ì™¸ë¶€ êµìœ¡ê¸°ê´€'}</td>
                                `;
                                count++;
                                totalHours += course.hours;
                                deptStats[auditor.info.dept].total++;
                                deptStats[auditor.info.dept].hours += course.hours;
                                completedCount++;
                                deptStats[auditor.info.dept].completed++;
                                
                                // ì°¸ì—¬ìë³„ í†µê³„ ê³„ì‚°
                                if (!participantStats[name]) {
                                    participantStats[name] = {
                                        dept: auditor.info.dept,
                                        totalHours: 0,
                                        recordCount: 0
                                    };
                                }
                                participantStats[name].totalHours += course.hours;
                                participantStats[name].recordCount++;
                            }
                        }
                    });
                }
            });

            if (count === 0) {
                tbody.innerHTML = '<tr><td colspan="10">ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ì´ìˆ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }

            const totalParticipants = Object.keys(participantStats).length;
            let summaryText = `<strong>ê²€ìƒ‰ ê²°ê³¼:</strong> ì´ ${count}ê±´ | <strong>ì´ ì°¸ì—¬ììˆ˜:</strong> ${totalParticipants}ëª… | <strong>ì´ ì´ìˆ˜ì‹œê°„:</strong> ${totalHours}ì‹œê°„ | <strong>ìŠ¹ì¸ ì™„ë£Œ:</strong> ${completedCount}ê±´`;
            
            // ì°¸ì—¬ìë³„ ì´ ì´ìˆ˜ ì‹œê°„ í‘œì‹œ
            if (totalParticipants > 0) {
                summaryText += '<br><strong>ì°¸ì—¬ìë³„ ì´ ì´ìˆ˜ì‹œê°„:</strong> ';
                summaryText += Object.entries(participantStats)
                    .sort((a, b) => b[1].totalHours - a[1].totalHours) // ì´ìˆ˜ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬
                    .map(([name, stats]) => `${name}(${stats.dept}) ${stats.totalHours}ì‹œê°„`)
                    .join(' | ');
            }
            
            if (Object.keys(deptStats).length > 1) {
                summaryText += '<br><strong>ë¶€ì„œë³„ í˜„í™©:</strong> ';
                summaryText += Object.entries(deptStats).map(([dept, stats]) => 
                    `${dept} ${stats.completed}/${stats.total}ê±´ (${stats.hours}ì‹œê°„)`
                ).join(' | ');
            }

            document.getElementById('departmentReportSummary').innerHTML = summaryText;
        };


        // --- ì´ìˆ˜ ê¸°ë¡ ìƒì„¸ ëª¨ë‹¬ ê´€ë¦¬ ---
        const showRecordDetailsModal = (record) => {
            console.log('showRecordDetailsModal called with record:', record);
            console.log('Record approve status:', record.approve);
            console.log('Record dataSource:', record.dataSource);
            
            // êµìœ¡ê³¼ì • ì •ë³´ ì°¾ê¸°
            const course = db.courses.find(c => c.id === record.courseId);
            console.log('Found course:', course);
            
            // ì‹¬ì‚¬ì ì •ë³´ ì°¾ê¸° - recordì— auditorNameì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì°¾ê¸°
            let auditor = null;
            let auditorName = record.auditorName;
            
            if (auditorName && db.auditors[auditorName]) {
                auditor = db.auditors[auditorName];
                console.log('Found auditor by auditorName:', auditor);
                } else {
                // auditorNameì´ ì—†ìœ¼ë©´ ëª¨ë“  ì‹¬ì‚¬ìì—ì„œ í•´ë‹¹ ê¸°ë¡ì„ ì°¾ê¸°
                for (const [name, aud] of Object.entries(db.auditors)) {
                    if (aud.records && aud.records.find(r => r.id === record.id)) {
                        auditor = aud;
                        auditorName = name;
                        console.log('Found auditor by searching records:', auditor, 'name:', name);
                        break;
                    }
                }
            }
            console.log('Final auditor:', auditor);
            console.log('Final auditorName:', auditorName);
            
            const modalContent = `
                <div class="approval-info">
                    <h4>ì´ìˆ˜ ê¸°ë¡ ìƒì„¸ ì •ë³´</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>ì‹¬ì‚¬ìëª…:</label>
                            <span>${auditorName || auditor?.info?.name || record.auditorName || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>ë¶€ì„œ:</label>
                            <span>${auditor?.info?.dept || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>êµìœ¡ì‚¬ì—…ëª…:</label>
                            <span>${course?.name || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>ì„¸ë¶€ê³¼ì •(í”„ë¡œê·¸ë¨)ëª…:</label>
                            <span>${course?.desc || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>êµìœ¡ê¸°ê°„:</label>
                            <span>${course?.startDate ? `${course.startDate} ~ ${course.endDate}` : '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>ì´ìˆ˜ì¼ì:</label>
                            <span>${record.date || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>êµìœ¡ê¸°ê´€:</label>
                            <span>${course?.orgName || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>ì¸ì •ì‹œê°„:</label>
                            <span>${course?.hours || 0}ì‹œê°„</span>
                        </div>
                        <div class="info-item">
                            <label>ë“±ë¡ì:</label>
                            <span>${record.registrant || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>ìƒíƒœ:</label>
                            <span>${record.approve || '-'}</span>
                        </div>
                        <div class="info-item">
                            <label>ë°ì´í„° ì†ŒìŠ¤:</label>
                            <span>${record.approve === 'ìŠ¹ì¸ëŒ€ê¸°' ? 'ì™¸ë¶€ êµìœ¡ê¸°ê´€' : (record.dataSource === 'API' ? 'í‰ê°€ì› êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ' : 'ì™¸ë¶€ êµìœ¡ê¸°ê´€')}</span>
                        </div>
                    </div>
                    
                    <div class="evidence-section">
                        <h4>ì¦ë¹™ìë£Œ</h4>
                        <div class="evidence-content">
                            ${record.notes ? `
                                <div class="evidence-item">
                                    <label>ë¹„ê³ /ìƒì„¸ë‚´ìš©:</label>
                                    <div class="evidence-text">${record.notes}</div>
                                </div>
                            ` : ''}
                            <div class="evidence-item">
                                <label>ì²¨ë¶€íŒŒì¼:</label>
                                <div class="file-info">
                                    ${record.fileName ? `
                                        <span class="file-name">ğŸ“ ${record.fileName}</span>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="downloadFile('${record.fileName}')">ë‹¤ìš´ë¡œë“œ</button>
                                    ` : '<span class="no-file">ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</span>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${(() => {
                        const shouldShowButtons = record.approve !== 'ìŠ¹ì¸' || record.dataSource === 'EXTERNAL';
                        console.log('=== BUTTON DEBUG ===');
                        console.log('Record ID:', record.id);
                        console.log('Record approve:', record.approve, '(type:', typeof record.approve, ')');
                        console.log('Record dataSource:', record.dataSource);
                        console.log('Should show buttons:', shouldShowButtons);
                        console.log('===================');
                        
                        if (!shouldShowButtons) {
                            return `<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 4px;">
                                <strong>ë””ë²„ê·¸ ì •ë³´:</strong><br>
                                ìŠ¹ì¸ ìƒíƒœ: "${record.approve}"<br>
                                ë°ì´í„° ì†ŒìŠ¤: "${record.dataSource}"<br>
                                ë²„íŠ¼ í‘œì‹œ ì¡°ê±´: ìŠ¹ì¸ì´ ì•„ë‹Œ ê²½ìš° ë˜ëŠ” EXTERNAL ë°ì´í„°<br>
                                <em>ìŠ¹ì¸/ë°˜ë ¤ ë²„íŠ¼ì´ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</em>
                            </div>`;
                        }
                        
                        // ìŠ¹ì¸ ë˜ëŠ” ë°˜ë ¤ê°€ ì™„ë£Œëœ ê²½ìš° ë²„íŠ¼ì„ ìˆ¨ê¹€
                        if (record.approve === 'ìŠ¹ì¸' || record.approve === 'ë°˜ë ¤') {
                            return `
                                <div class="approval-actions">
                                    <h4>ì²˜ë¦¬ ê²°ê³¼</h4>
                                    <div class="status-info">
                                        <p><strong>ì²˜ë¦¬ ìƒíƒœ:</strong> <span class="status ${record.approve === 'ìŠ¹ì¸' ? 'ok' : 'bad'}">${record.approve}</span></p>
                                        <p><em>ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì–´ ì¶”ê°€ ì‘ì—…ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</em></p>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // ìŠ¹ì¸ëŒ€ê¸° ìƒíƒœì¸ ê²½ìš° ì‘ì„±ìë§Œ ìˆ˜ì • ê°€ëŠ¥
                        if (record.approve === 'ìŠ¹ì¸ëŒ€ê¸°') {
                            const currentUser = getCurrentUser();
                            const isAuthor = record.auditorName === currentUser.userName || record.registrant === currentUser.userName;
                            
                            if (isAuthor) {
                                return `
                                    <div class="approval-actions">
                                        <h4>ì²˜ë¦¬ ê²°ê³¼</h4>
                                        <div class="action-buttons">
                                            <button type="button" class="btn btn-primary" onclick="editRecord(${record.id})">
                                                âœï¸ ë‚´ìš© ìˆ˜ì •
                                            </button>
                                        </div>
                                        <div class="status-info" style="margin-top: 15px;">
                                            <p><strong>ì²˜ë¦¬ ìƒíƒœ:</strong> <span class="status wait">ìŠ¹ì¸ëŒ€ê¸°</span></p>
                                            <p><em>ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ì‘ì„±ìëŠ” ë‚´ìš©ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</em></p>
                                        </div>
                                    </div>
                                `;
                            } else {
                                return `
                                    <div class="approval-actions">
                                        <h4>ì²˜ë¦¬ ê²°ê³¼</h4>
                                        <div class="status-info">
                                            <p><strong>ì²˜ë¦¬ ìƒíƒœ:</strong> <span class="status wait">ìŠ¹ì¸ëŒ€ê¸°</span></p>
                                            <p><em>ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ì‘ì„±ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</em></p>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                        
                        return `
                            <div class="approval-actions">
                                <h4>ì²˜ë¦¬ ê²°ê³¼</h4>
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-success" onclick="processApproval('${record.id}', 'ìŠ¹ì¸')">
                                        âœ… ìŠ¹ì¸ ì²˜ë¦¬
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="processApproval('${record.id}', 'ë°˜ë ¤')">
                                        âŒ ë°˜ë ¤ ì²˜ë¦¬
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="deleteRecord('${record.id}')">
                                        ğŸ—‘ï¸ ì´ìˆ˜ ì‚­ì œ
                                    </button>
                                </div>
                            </div>
                        `;
                    })()}
                </div>
            `;
            
            console.log('Opening record details modal');
            openModal('ì´ìˆ˜ ê¸°ë¡ ìƒì„¸ ì •ë³´', modalContent, { dataSource: record.dataSource });
        };

        // --- ìŠ¹ì¸/ë°˜ë ¤ ëª¨ë‹¬ ê´€ë¦¬ ---
        const showApprovalModal = (record, action) => {
            console.log('showApprovalModal called with record:', record);
            console.log('showApprovalModal called with action:', action);
            
            // ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ìš© ëª¨ë‹¬ ë‚´ìš©
            const modalContent = `
                <div class="approval-info">
                    <h4>ì´ìˆ˜ ê¸°ë¡ ìƒì„¸ ì •ë³´</h4>
                    <p><strong>ì‹¬ì‚¬ìëª…:</strong> ${record.auditorName || '-'}</p>
                    <p><strong>êµìœ¡ ID:</strong> ${record.courseId || '-'}</p>
                    <p><strong>ì´ìˆ˜ì¼ì:</strong> ${record.date || '-'}</p>
                    <p><strong>ìƒíƒœ:</strong> ${record.approve || '-'}</p>
                    <p><strong>ë¹„ê³ :</strong> ${record.notes || 'ì—†ìŒ'}</p>
                    <p><strong>íŒŒì¼:</strong> ${record.fileName || 'ì—†ìŒ'}</p>
                    
                    <div class="approval-actions">
                        <h4>ì²˜ë¦¬ ê²°ê³¼</h4>
                        <div class="action-buttons">
                            ${action === 'approve' ? `
                                <button type="button" class="btn btn-success" onclick="processApproval('${record.id}', 'ìŠ¹ì¸')">
                                    âœ… ìŠ¹ì¸ ì²˜ë¦¬
                                </button>
                                <button type="button" class="btn btn-danger" onclick="deleteRecord('${record.id}')">
                                    ğŸ—‘ï¸ ì´ìˆ˜ ì‚­ì œ
                                </button>
                            ` : `
                                <button type="button" class="btn btn-danger" onclick="processApproval('${record.id}', 'ë°˜ë ¤')">
                                    âŒ ë°˜ë ¤ ì²˜ë¦¬
                                </button>
                                <button type="button" class="btn btn-danger" onclick="deleteRecord('${record.id}')">
                                    ğŸ—‘ï¸ ì´ìˆ˜ ì‚­ì œ
                                </button>
                            `}
                    </div>
                    </div>
                </div>
            `;
            
            console.log('Opening approval modal with action:', action);
            console.log('Modal content length:', modalContent.length);
            openModal(`${action === 'approve' ? 'ìŠ¹ì¸' : 'ë°˜ë ¤'} ì²˜ë¦¬`, modalContent);
        };

        // ìŠ¹ì¸/ë°˜ë ¤ ì²˜ë¦¬ í•¨ìˆ˜
        window.processApproval = (recordId, action) => {
            try {
            console.log('=== PROCESS APPROVAL DEBUG ===');
            console.log('processApproval called with recordId:', recordId, 'action:', action);
                console.log('recordId type:', typeof recordId);
                
                // ì¦‰ì‹œ ì•Œë¦¼ìœ¼ë¡œ í•¨ìˆ˜ í˜¸ì¶œ í™•ì¸
                alert('processApproval í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ID: ' + recordId + ', Action: ' + action);
                
                console.log('db.auditors:', db.auditors);
                
                // ëª¨ë“  ì‹¬ì‚¬ìì—ì„œ í•´ë‹¹ IDì˜ ê¸°ë¡ì„ ì§ì ‘ ì°¾ê¸°
                let foundRecord = null;
                let foundAuditor = null;
                
                for (const [auditorName, auditor] of Object.entries(db.auditors)) {
                    console.log('Checking auditor:', auditorName, 'has records:', !!auditor.records);
                        if (auditor.records) {
                        console.log('Records in', auditorName, ':', auditor.records.map(r => ({ id: r.id, approve: r.approve })));
                        const record = auditor.records.find(r => {
                            const match = String(r.id) === String(recordId);
                            console.log('Comparing:', r.id, 'with', recordId, 'match:', match);
                            return match;
                        });
                        
                        if (record) {
                            foundRecord = record;
                            foundAuditor = auditorName;
                            console.log('Found record in auditor:', auditorName, 'record:', record);
                                break;
                            }
                        }
                    }
                
                if (!foundRecord) {
                    console.error('Record not found in database');
                    console.log('Searched for recordId:', recordId);
                    console.log('Available records:', Object.values(db.auditors).flatMap(a => a.records?.map(r => r.id) || []));
                    alert('ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ID: ' + recordId);
                    return;
                }
                
                console.log('Processing approval for record:', foundRecord, 'in auditor:', foundAuditor);
                
                // ì°¾ì€ ê¸°ë¡ì„ ì§ì ‘ ìˆ˜ì •
                const oldApprove = foundRecord.approve;
                foundRecord.approve = action;
                console.log('Updated record approve status from', oldApprove, 'to:', action);
                
                // ë°ì´í„° ì €ì¥ ë° í™”ë©´ ê°±ì‹ 
                console.log('Saving data...');
                    saveData();
                console.log('Rendering all...');
                    renderAll();
                console.log('Closing modal...');
                    closeModal();
                console.log('Showing toast...');
                    showToast(`ì´ìˆ˜ ê¸°ë¡ì´ ${action} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    
                console.log('Approval process completed successfully');
                
            } catch (error) {
                console.error('Error in processApproval:', error);
                alert('ìŠ¹ì¸/ë°˜ë ¤ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        };


        // ì´ìˆ˜ ê¸°ë¡ ìˆ˜ì • í•¨ìˆ˜ (ìŠ¹ì¸ëŒ€ê¸° ìƒíƒœì—ì„œ ì‘ì„±ìê°€ ì‚¬ìš©)
        window.editRecord = (recordId) => {
            console.log('editRecord called with recordId:', recordId);
            
            // í˜„ì¬ í‘œì‹œëœ ê¸°ë¡ì—ì„œ ì°¾ê¸°
            const displayedRecord = currentDisplayedRecords.find(r => r.id === recordId);
            console.log('Found displayed record for edit:', displayedRecord);
            
            if (displayedRecord) {
                // êµìœ¡ê³¼ì • ì˜µì…˜ ìƒì„± (ì™¸ë¶€ êµìœ¡ê¸°ê´€ë§Œ)
                const courseOptions = db.courses
                    .filter(c => c.dataSource === 'EXTERNAL')
                    .map(c => `<option value="${c.id}" ${c.id === displayedRecord.courseId ? 'selected' : ''}>${c.name}</option>`)
                    .join('');
                
                const formHtml = `
                    <input type="hidden" id="modal-recordId" name="recordId" value="${displayedRecord.id}">
                    <div class="form-group">
                        <label for="modal-auditorName">ì‹¬ì‚¬ì</label>
                        <input type="text" id="modal-auditorName" name="auditorName" value="${displayedRecord.auditorName}" readonly style="background-color: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label for="modal-courseId">êµìœ¡ê³¼ì •</label>
                        <select id="modal-courseId" name="courseId" required>${courseOptions}</select>
                    </div>
                    <div class="form-group">
                        <label for="modal-date">ì´ìˆ˜ì¼ì</label>
                        <input type="date" id="modal-date" name="date" value="${displayedRecord.date}" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-file">ì¦ë¹™ìë£Œ</label>
                        <input type="file" id="modal-file" name="file">
                        ${displayedRecord.fileName ? `<p style="font-size: 12px; color: var(--muted); margin-top: 5px;">í˜„ì¬ íŒŒì¼: ${displayedRecord.fileName}</p>` : ''}
                    </div>
                    <div class="form-group">
                        <label for="modal-notes">ë¹„ê³ </label>
                        <textarea id="modal-notes" name="notes" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;" placeholder="êµìœ¡ ë‚´ìš© ìš”ì•½ì´ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”">${displayedRecord.notes || ''}</textarea>
                    </div>
                `;
                
                openModal('ì´ìˆ˜ ê¸°ë¡ ìˆ˜ì •', formHtml);
            } else {
                console.error('Could not find displayed record for edit');
                showToast('ìˆ˜ì •í•  ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        };

        // ì´ìˆ˜ ê¸°ë¡ ì‚­ì œ í•¨ìˆ˜
        window.deleteRecord = (recordId) => {
            console.log('deleteRecord called with recordId:', recordId);
            
            // í˜„ì¬ í‘œì‹œëœ ê¸°ë¡ì—ì„œ ì°¾ê¸° (ì›ë³¸ ID ì‚¬ìš©)
            const displayedRecord = currentDisplayedRecords.find(r => r.id === recordId);
            console.log('Found displayed record for deletion:', displayedRecord);
            
            if (displayedRecord) {
                const courseName = displayedRecord.courseName || 'ì•Œ ìˆ˜ ì—†ëŠ” êµìœ¡';
                const auditorName = displayedRecord.auditorName || 'ì•Œ ìˆ˜ ì—†ëŠ” ì‹¬ì‚¬ì';
                
                if (confirm(`'${courseName}' ì´ìˆ˜ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‹¬ì‚¬ì: ${auditorName}`)) {
                    // ì›ë³¸ ë°ì´í„°ì—ì„œ í•´ë‹¹ ê¸°ë¡ì„ ì°¾ì•„ì„œ ì‚­ì œ
                    let found = false;
                    
                    // displayedRecordì—ì„œ ì‹¤ì œ ì›ë³¸ ê¸°ë¡ì˜ ID ì°¾ê¸°
                    const actualRecordId = displayedRecord.id;
                    const actualAuditorName = displayedRecord.auditorName;
                    console.log('Looking for original record to delete with ID:', actualRecordId, 'in auditor:', actualAuditorName);
                    
                    // íŠ¹ì • ì‹¬ì‚¬ìì—ì„œ ë¨¼ì € ì°¾ê¸°
                    if (actualAuditorName && db.auditors[actualAuditorName] && db.auditors[actualAuditorName].records) {
                        const recordIndex = db.auditors[actualAuditorName].records.findIndex(r => r.id === actualRecordId);
                        if (recordIndex !== -1) {
                            db.auditors[actualAuditorName].records.splice(recordIndex, 1);
                            console.log('Deleted record from auditor:', actualAuditorName);
                            found = true;
                        }
                    }
                    
                    // íŠ¹ì • ì‹¬ì‚¬ìì—ì„œ ì°¾ì§€ ëª»í–ˆë‹¤ë©´ ëª¨ë“  ì‹¬ì‚¬ìì—ì„œ ì°¾ê¸°
                    if (!found) {
                        for (const [name, auditor] of Object.entries(db.auditors)) {
                            if (auditor.records) {
                                const recordIndex = auditor.records.findIndex(r => r.id === actualRecordId);
                                if (recordIndex !== -1) {
                                    auditor.records.splice(recordIndex, 1);
                                    console.log('Deleted record from auditor:', name);
                                    found = true;
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (found) {
                        saveData();
                        renderAll();
                        closeModal();
                        showToast('ì´ìˆ˜ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        console.error('Could not find original record to delete');
                        showToast('ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }
            } else {
                console.error('Could not find displayed record for deletion');
                showToast('ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        };

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (ì‹œë®¬ë ˆì´ì…˜)
        window.downloadFile = (fileName) => {
            showToast(`íŒŒì¼ ë‹¤ìš´ë¡œë“œ: ${fileName} (ì‹œë®¬ë ˆì´ì…˜)`);
        };

        // --- ëª¨ë‹¬ ê´€ë¦¬ ---
        const openModal = (title, content, data = null) => {
            console.log('openModal called with title:', title);
        const modal = document.getElementById('modal-popup');
        const modalTitle = document.getElementById('modal-title');
        const modalFooter = document.querySelector('.modal-footer');
        
            console.log('Modal element:', modal);
            console.log('Modal title element:', modalTitle);
        
            if (modalTitle) {
            modalTitle.textContent = title;
            }
            
            const modalBody = document.getElementById('modal-body-content');
            console.log('Modal body element:', modalBody);
            if (modalBody) {
                modalBody.innerHTML = content;
            }
            
            // ë°ì´í„° ì†ŒìŠ¤ê°€ APIì¸ ê²½ìš°, ìƒì„¸ ì •ë³´ ëª¨ë‹¬ì¸ ê²½ìš°, ë˜ëŠ” ìŠ¹ì¸/ë°˜ë ¤ ì²˜ë¦¬ ëª¨ë‹¬ì¸ ê²½ìš° ëª¨ë‹¬ í‘¸í„° ìˆ¨ê¸°ê¸°
            if ((data && data.dataSource === 'API' && title === 'ì´ìˆ˜ ê¸°ë¡ ìƒì„¸ ì •ë³´') || 
                title === 'ì´ìˆ˜ ê¸°ë¡ ìƒì„¸ ì •ë³´' || 
                title === 'êµìœ¡ê³¼ì • ìƒì„¸ë³´ê¸°' ||
                title === 'ìŠ¹ì¸ ì²˜ë¦¬' || 
                title === 'ë°˜ë ¤ ì²˜ë¦¬') {
                if (modalFooter) {
                    modalFooter.style.display = 'none';
                }
            } else {
                if (modalFooter) {
                    modalFooter.style.display = 'block';
                }
            }
            
            if (data) {
                Object.keys(data).forEach(key => {
                    const input = document.getElementById(`modal-${key}`);
                    if (input) input.value = data[key];
                });
            }
            
            if (modal) {
            modal.style.display = 'block';
                console.log('Modal displayed');
            } else {
                console.error('Modal element not found!');
            }
        };
        
        const closeModal = () => {
            const modal = document.getElementById('modal-popup');
            modal.style.display = 'none';
            document.getElementById('modal-form').reset();
        };
        
        // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
        document.querySelectorAll('.close-btn, .close-btn-bottom').forEach(btn => {
            btn.addEventListener('click', closeModal);
        });
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('modal-popup').addEventListener('click', (e) => {
            if (e.target.id === 'modal-popup') closeModal();
        });
        
        // ëª¨ë‹¬ í¼ ì œì¶œ ì´ë²¤íŠ¸
        document.getElementById('modal-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {};
            formData.forEach((value, key) => data[key] = value);
            
            // ëª¨ë‹¬ ì œëª©ì— ë”°ë¼ ë‹¤ë¥¸ ì €ì¥ ë¡œì§ ì‹¤í–‰
            const modalTitle = document.getElementById('modal-title').textContent;
            
            if (modalTitle === 'ì‹ ê·œ ì´ìˆ˜ ê¸°ë¡ ë“±ë¡' || modalTitle === 'ë‚´ ì´ìˆ˜ ê¸°ë¡ ë“±ë¡' || modalTitle === 'ì´ìˆ˜ ê¸°ë¡ ë“±ë¡ (ê´€ë¦¬ì)') {
                // ì„ íƒëœ êµìœ¡ê³¼ì •ì˜ ë°ì´í„° ì†ŒìŠ¤ í™•ì¸
                const selectedCourse = db.courses.find(c => c.id === parseInt(data.courseId));
                const isApiCourse = selectedCourse && selectedCourse.dataSource === 'API';
                
                // íŒŒì¼ëª… ì¶”ì¶œ
                const fileInput = document.getElementById('modal-file');
                const fileName = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0].name : null;
                
                // ì‹¬ì‚¬ì ì •ë³´ ì²˜ë¦¬ (ê´€ë¦¬ìì¸ ê²½ìš°)
                let auditorName = data.auditorName;
                let auditorDept = data.auditorDept;
                
                // ê´€ë¦¬ìê°€ ìƒˆë¡œìš´ ì‹¬ì‚¬ìë¥¼ ë“±ë¡í•˜ëŠ” ê²½ìš°
                if (modalTitle === 'ì´ìˆ˜ ê¸°ë¡ ë“±ë¡ (ê´€ë¦¬ì)') {
                    if (!auditorName || !auditorDept) {
                        showToast('ì‹¬ì‚¬ì ì´ë¦„ê³¼ ë¶€ì„œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    // ì‹¬ì‚¬ìê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒì„±
                    if (!db.auditors[auditorName]) {
                        db.auditors[auditorName] = {
                            info: {
                                name: auditorName,
                                dept: auditorDept,
                                rank: 'ì‹¬ì‚¬ì›' // ê¸°ë³¸ê°’
                            },
                            records: []
                        };
                        saveData();
                    }
                }
                
                // ìƒˆë¡œìš´ ì´ìˆ˜ ê¸°ë¡ ì €ì¥
                const newRecord = {
                    id: Date.now(), // ê³ ìœ  ID ìƒì„±
                    courseId: parseInt(data.courseId),
                    date: data.date,
                    approve: data.status || (isApiCourse ? 'ìŠ¹ì¸' : 'ìŠ¹ì¸ëŒ€ê¸°'), // í¼ì—ì„œ ì„ íƒí•œ ìƒíƒœ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
                    dataSource: isApiCourse ? 'API' : 'EXTERNAL',
                    registrant: auditorName,
                    auditorName: auditorName, // ì‹¬ì‚¬ì ì´ë¦„ ì¶”ê°€
                    notes: data.notes || '',
                    fileName: fileName
                };
                
                if (!db.auditors[auditorName]) {
                    showToast('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‹¬ì‚¬ìì…ë‹ˆë‹¤.');
                    return;
                }
                
                db.auditors[auditorName].records.push(newRecord);
                saveData();
                renderRecordTable();
                
                if (isApiCourse) {
                    showToast('ì´ìˆ˜ ê¸°ë¡ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. (í‰ê°€ì› êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ êµìœ¡ê³¼ì •ìœ¼ë¡œ ìë™ ìŠ¹ì¸ ì²˜ë¦¬ë¨)');
                } else {
                    showToast('ì´ìˆ˜ ê¸°ë¡ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. (ì™¸ë¶€ êµìœ¡ê¸°ê´€ êµìœ¡ê³¼ì •ìœ¼ë¡œ ìŠ¹ì¸ëŒ€ê¸° ìƒíƒœ)');
                }
                
                closeModal();
                
            } else if (modalTitle === 'ì‹ ê·œ êµìœ¡ê³¼ì • ë“±ë¡') {
                // ìƒˆë¡œìš´ êµìœ¡ê³¼ì • ì €ì¥ (ì™¸ë¶€ êµìœ¡ê¸°ê´€ ë“±ë¡)
                const newCourse = {
                    id: Math.max(...db.courses.map(c => c.id)) + 1,
                    name: data.name,
                    desc: data.desc,
                    startDate: data.startDate,
                    endDate: data.endDate,
                    type: data.type,
                    hours: parseInt(data.hours),
                    regDate: data.regDate,
                    dataSource: 'EXTERNAL',
                    orgName: data.orgName,
                    registrant: data.registrant
                };
                db.courses.push(newCourse);
                saveData();
                renderAll();
                showToast('êµìœ¡ê³¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeModal();
                
            } else if (modalTitle === 'êµìœ¡ê³¼ì • ìˆ˜ì •') {
                // êµìœ¡ê³¼ì • ìˆ˜ì •
                const editId = document.getElementById('modal-edit-id').value;
                const course = db.courses.find(c => c.id == editId);
                if (course) {
                    Object.assign(course, {
                        name: data.name,
                        desc: data.desc,
                        startDate: data.startDate,
                        endDate: data.endDate,
                        type: data.type,
                        hours: parseInt(data.hours),
                        registrant: data.registrant,
                        regDate: data.regDate
                    });
                    saveData();
                    renderAll();
                    showToast('êµìœ¡ê³¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeModal();
                }
            } else if (modalTitle === 'ì´ìˆ˜ ê¸°ë¡ ìˆ˜ì •') {
                // ì´ìˆ˜ ê¸°ë¡ ìˆ˜ì •
                const recordId = parseInt(data.recordId || data.id);
                console.log('=== ì´ìˆ˜ ê¸°ë¡ ìˆ˜ì • ë””ë²„ê·¸ ===');
                console.log('modalTitle:', modalTitle);
                console.log('data:', data);
                console.log('recordId:', recordId);
                
                // ëª¨ë“  ì‹¬ì‚¬ìì—ì„œ í•´ë‹¹ ê¸°ë¡ì„ ì°¾ì•„ì„œ ìˆ˜ì •
                let found = false;
                for (const [name, auditor] of Object.entries(db.auditors)) {
                    if (auditor.records) {
                        const record = auditor.records.find(r => r.id === recordId);
                        if (record) {
                            console.log('ì°¾ì€ ê¸°ë¡:', record);
                            console.log('ìˆ˜ì • ì „:', JSON.stringify(record));
                            
                            // íŒŒì¼ëª… ì¶”ì¶œ
                            const fileInput = document.getElementById('modal-file');
                            const fileName = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0].name : record.fileName;
                            
                            // ê¸°ë¡ ìˆ˜ì •
                            Object.assign(record, {
                                courseId: parseInt(data.courseId),
                                date: data.date,
                                notes: data.notes,
                                fileName: fileName
                            });
                            
                            console.log('ìˆ˜ì • í›„:', JSON.stringify(record));
                            found = true;
                            break;
                        }
                    }
                }
                
                if (found) {
                    console.log('ì´ìˆ˜ ê¸°ë¡ ìˆ˜ì • ì„±ê³µ');
                    saveData();
                    renderRecordTable();
                    showToast('ì´ìˆ˜ ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeModal();
                    
                    // ìŠ¹ì¸ëŒ€ê¸° ìƒíƒœì¸ ê²½ìš° ìƒì„¸ë³´ê¸°ë¥¼ ë‹¤ì‹œ ì—´ì–´ì„œ ìˆ˜ì •ëœ ë‚´ìš© í™•ì¸ ê°€ëŠ¥
                    setTimeout(() => {
                        const updatedRecord = currentDisplayedRecords.find(r => r.id === recordId);
                        if (updatedRecord && updatedRecord.approve === 'ìŠ¹ì¸ëŒ€ê¸°') {
                            showRecordDetailsModal(updatedRecord);
                        }
                    }, 100);
                    
                } else {
                    console.error('ìˆ˜ì •í•  ì´ìˆ˜ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ID:', recordId);
                    console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ê¸°ë¡ë“¤:', Object.values(db.auditors).flatMap(a => a.records?.map(r => ({id: r.id, courseId: r.courseId})) || []));
                    showToast('ìˆ˜ì •í•  ì´ìˆ˜ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            }
        });
        
        // ë„¤ë¹„ê²Œì´ì…˜ ì´ë²¤íŠ¸
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('nav-link')) {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('main > section').forEach(s => s.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById(e.target.dataset.target).classList.add('active');
            }
        });

        // EDU-003 ì´ë²¤íŠ¸
        document.getElementById('courseSearchForm').addEventListener('submit', e => {
            e.preventDefault();
            const nameFilter = document.getElementById('courseNameInput').value.toLowerCase();
            const descFilter = document.getElementById('courseDescInput').value.toLowerCase();
            const typeFilter = document.getElementById('courseTypeSelect').value;
            const dataSourceFilter = document.getElementById('dataSourceSelect').value;
            const startDateFilter = document.getElementById('startDateInput').value;
            const endDateFilter = document.getElementById('endDateInput').value;
            
            renderCourseTable(c => {
                // êµìœ¡ì‚¬ì—…ëª… í•„í„°
                const nameMatch = !nameFilter || c.name.toLowerCase().includes(nameFilter);
                
                // ì„¸ë¶€ê³¼ì •(í”„ë¡œê·¸ë¨)ëª… í•„í„°
                const descMatch = !descFilter || (c.desc && c.desc.toLowerCase().includes(descFilter));
                
                // í•„ìˆ˜ì—¬ë¶€ í•„í„°
                const typeMatch = typeFilter === 'ì „ì²´' || c.type === typeFilter;
                
                // ë°ì´í„° ì†ŒìŠ¤ í•„í„°
                const dataSourceMatch = dataSourceFilter === 'ì „ì²´' || c.dataSource === dataSourceFilter;
                
                // êµìœ¡ê¸°ê°„ í•„í„°
                let dateMatch = true;
                if (startDateFilter) {
                    dateMatch = dateMatch && c.startDate >= startDateFilter;
                }
                if (endDateFilter) {
                    dateMatch = dateMatch && c.endDate <= endDateFilter;
                }
                
                return nameMatch && descMatch && typeMatch && dataSourceMatch && dateMatch;
            });
        });
        document.getElementById('courseSearchForm').addEventListener('reset', () => setTimeout(renderCourseTable, 0));
        
        // êµìœ¡ê³¼ì • í…Œì´ë¸” í–‰ í´ë¦­ ì´ë²¤íŠ¸ - êµìœ¡ê³¼ì • ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ì—´ê¸°
        document.addEventListener('click', function(e) {
            const courseTable = document.getElementById('courseTable');
            if (courseTable && courseTable.contains(e.target)) {
                const row = e.target.closest('tr');
                if (row && row.dataset.id && !e.target.closest('.manage-buttons')) {
                    // í´ë¦­ëœ í–‰ì˜ êµìœ¡ê³¼ì • ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const courseId = row.dataset.id;
                    const course = db.courses.find(c => c.id == courseId);
                    
                    if (course) {
                        // êµìœ¡ê³¼ì • ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ì—´ê¸°
                        try {
                            const formHtml = `
                                <div class="form-group"><label for="modal-name">êµìœ¡ì‚¬ì—…ëª…</label><input type="text" id="modal-name" name="name" value="${course.name || ''}" readonly style="background-color: #f5f5f5;"></div>
                                <div class="form-group"><label for="modal-desc">ì„¸ë¶€ê³¼ì •(í”„ë¡œê·¸ë¨)ëª…</label><textarea id="modal-desc" name="desc" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;background-color: #f5f5f5;" readonly>${course.desc || ''}</textarea></div>
                                <div class="form-group"><label for="modal-startDate">ì‹œì‘ì¼</label><input type="date" id="modal-startDate" name="startDate" value="${course.startDate || ''}" readonly style="background-color: #f5f5f5;"></div>
                                <div class="form-group"><label for="modal-endDate">ì¢…ë£Œì¼</label><input type="date" id="modal-endDate" name="endDate" value="${course.endDate || ''}" readonly style="background-color: #f5f5f5;"></div>
                                <div class="form-group"><label for="modal-type">í•„ìˆ˜ì—¬ë¶€</label><select id="modal-type" name="type" disabled style="background-color: #f5f5f5;"><option value="í•„ìˆ˜" ${course.type === 'í•„ìˆ˜' ? 'selected' : ''}>í•„ìˆ˜</option><option value="ì„ íƒ" ${course.type === 'ì„ íƒ' ? 'selected' : ''}>ì„ íƒ</option></select></div>
                                <div class="form-group"><label for="modal-hours">ì¸ì •ì‹œê°„</label><input type="number" id="modal-hours" name="hours" value="${course.hours || ''}" readonly style="background-color: #f5f5f5;"></div>
                                <div class="form-group"><label for="modal-orgName">êµìœ¡ê¸°ê´€</label><input type="text" id="modal-orgName" name="orgName" value="${course.orgName || ''}" readonly style="background-color: #f5f5f5;"></div>
                                <div class="form-group"><label for="modal-registrant">ë“±ë¡ì</label><input type="text" id="modal-registrant" name="registrant" value="${course.registrant || ''}" readonly style="background-color: #f5f5f5;"></div>
                                <div class="form-group"><label for="modal-regDate">ë“±ë¡ì¼</label><input type="date" id="modal-regDate" name="regDate" value="${course.regDate || ''}" readonly style="background-color: #f5f5f5;"></div>
                                <div class="form-group"><label for="modal-dataSource">ë°ì´í„° ì†ŒìŠ¤</label><input type="text" id="modal-dataSource" name="dataSource" value="${course.dataSource === 'API' ? 'í‰ê°€ì› êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ' : 'ì™¸ë¶€ êµìœ¡ê¸°ê´€'}" readonly style="background-color: #f5f5f5;"></div>`;
                                
                            openModal('êµìœ¡ê³¼ì • ìƒì„¸ë³´ê¸°', formHtml);
                        } catch (error) {
                            console.error('êµìœ¡ê³¼ì • ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ì—´ê¸° ì˜¤ë¥˜:', error);
                            showToast('êµìœ¡ê³¼ì • ìƒì„¸ë³´ê¸° ëª¨ë‹¬ì„ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                        }
                    } else {
                        console.error('êµìœ¡ê³¼ì • ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ID:', courseId);
                        showToast('êµìœ¡ê³¼ì • ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }
            }
        });
        
        // API ë™ê¸°í™” ë²„íŠ¼
        document.getElementById('sync-api-btn').addEventListener('click', () => {
            syncWithAPI();
        });

        // ì´ìˆ˜ ê¸°ë¡ API ë™ê¸°í™” ë²„íŠ¼
        document.getElementById('sync-records-api-btn').addEventListener('click', () => {
            syncRecordsWithAPI();
        });

        
        // Bulk Insert ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('bulk-insert-btn').addEventListener('click', () => {
            showBulkInsertModal();
        });

        // ê¶Œí•œ ì „í™˜ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('switchUserBtn').addEventListener('click', () => {
            switchUserRole();
        });
        
        document.getElementById('add-course-btn').addEventListener('click', () => {
            try {
                // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const currentUser = getCurrentUser();
                
            const formHtml = `
                <div class="form-group"><label for="modal-name">êµìœ¡ì‚¬ì—…ëª…</label><input type="text" id="modal-name" name="name" required></div>
                <div class="form-group"><label for="modal-desc">ì„¸ë¶€ê³¼ì •(í”„ë¡œê·¸ë¨)ëª…</label><textarea id="modal-desc" name="desc" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;"></textarea></div>
                <div class="form-group"><label for="modal-startDate">ì‹œì‘ì¼</label><input type="date" id="modal-startDate" name="startDate" required></div>
                <div class="form-group"><label for="modal-endDate">ì¢…ë£Œì¼</label><input type="date" id="modal-endDate" name="endDate" required></div>
                <div class="form-group"><label for="modal-type">í•„ìˆ˜ì—¬ë¶€</label><select id="modal-type" name="type"><option>í•„ìˆ˜</option><option>ì„ íƒ</option></select></div>
                <div class="form-group"><label for="modal-hours">ì¸ì •ì‹œê°„</label><input type="number" id="modal-hours" name="hours" required></div>
                    <div class="form-group"><label for="modal-orgName">êµìœ¡ê¸°ê´€</label><input type="text" id="modal-orgName" name="orgName" value="${currentUser.orgName}" readonly style="background-color: #f5f5f5;"></div>
                    <div class="form-group"><label for="modal-registrant">ë“±ë¡ì</label><input type="text" id="modal-registrant" name="registrant" value="${currentUser.userName}" readonly style="background-color: #f5f5f5;"></div>
                <div class="form-group"><label for="modal-regDate">ë“±ë¡ì¼</label><input type="date" id="modal-regDate" name="regDate" value="${new Date().toISOString().slice(0,10)}" required></div>`;
                
            openModal('ì‹ ê·œ êµìœ¡ê³¼ì • ë“±ë¡', formHtml);
            } catch (error) {
                console.error('ì‹ ê·œ ë“±ë¡ ë²„íŠ¼ ì˜¤ë¥˜:', error);
                showToast('ì‹ ê·œ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });

        document.querySelector('#courseTable tbody').addEventListener('click', e => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const row = btn.closest('tr');
            const id = row.dataset.id;
            
            if (btn.classList.contains('btn-edit-course')) {
                const course = db.courses.find(c => c.id == id);
                const formHtml = `
                    <div class="form-group"><label for="modal-name">êµìœ¡ì‚¬ì—…ëª…</label><input type="text" id="modal-name" name="name" required></div>
                    <div class="form-group"><label for="modal-desc">ì„¸ë¶€ê³¼ì •(í”„ë¡œê·¸ë¨)ëª…</label><textarea id="modal-desc" name="desc" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;"></textarea></div>
                    <div class="form-group"><label for="modal-startDate">ì‹œì‘ì¼</label><input type="date" id="modal-startDate" name="startDate" required></div>
                    <div class="form-group"><label for="modal-endDate">ì¢…ë£Œì¼</label><input type="date" id="modal-endDate" name="endDate" required></div>
                    <div class="form-group"><label for="modal-type">í•„ìˆ˜ì—¬ë¶€</label><select id="modal-type" name="type"><option>í•„ìˆ˜</option><option>ì„ íƒ</option></select></div>
                    <div class="form-group"><label for="modal-hours">ì¸ì •ì‹œê°„</label><input type="number" id="modal-hours" name="hours" required></div>
                    <div class="form-group"><label for="modal-registrant">ë“±ë¡ì</label><input type="text" id="modal-registrant" name="registrant" placeholder="ë“±ë¡ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required></div>
                    <div class="form-group"><label for="modal-regDate">ë“±ë¡ì¼</label><input type="date" id="modal-regDate" name="regDate" required></div>`;
                openModal('êµìœ¡ê³¼ì • ìˆ˜ì •', formHtml, course);
            } else if (btn.classList.contains('btn-delete-course')) {
                if (confirm(`'${row.cells[1].textContent}' ê³¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    db.courses = db.courses.filter(c => c.id != id);
                    saveData();
                    renderAll();
                }
            }
        });

        // EDU-004 ì´ë²¤íŠ¸
        document.getElementById('auditorSearchForm').addEventListener('submit', e => {
            e.preventDefault();
            const dept = document.getElementById('deptSelect').value;
            const nameFilter = document.getElementById('auditorNameInput').value.toLowerCase();
            const courseNameFilter = document.getElementById('courseNameSearchInput').value.toLowerCase();
            const courseDescFilter = document.getElementById('courseDescSearchInput').value.toLowerCase();
            const coursePeriodStart = document.getElementById('coursePeriodStartInput').value;
            const coursePeriodEnd = document.getElementById('coursePeriodEndInput').value;
            const completionStart = document.getElementById('completionStartInput').value;
            const completionEnd = document.getElementById('completionEndInput').value;
            const courseTypeFilter = document.getElementById('courseTypeSearchSelect').value;
            const dataSourceFilter = document.getElementById('dataSourceSearchSelect').value;
            const statusFilter = document.getElementById('statusSelect').value;
            currentAuditor = nameFilter; // ì‹¬ì‚¬ì ì´ë¦„ìœ¼ë¡œ ì„¤ì •
            currentStatus = statusFilter; // ìƒíƒœ í•„í„° ì„¤ì •
            renderRecordTable();
        });

        // ë¶€ì„œ ì„ íƒ ë³€ê²½ ì‹œ ìë™ ì—…ë°ì´íŠ¸
        const deptSelectElement = document.getElementById('deptSelect');
        if (deptSelectElement) {
            deptSelectElement.addEventListener('change', (e) => {
                console.log('ë¶€ì„œ ì„ íƒ ë³€ê²½:', e.target.value);
                renderRecordTable();
            });
            console.log('ë¶€ì„œ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
        } else {
            console.error('deptSelect ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        // ìƒíƒœ ì„ íƒ ë³€ê²½ ì‹œ ìë™ ì—…ë°ì´íŠ¸
        const statusSelectElement = document.getElementById('statusSelect');
        if (statusSelectElement) {
            statusSelectElement.addEventListener('change', (e) => {
                console.log('ìƒíƒœ ì„ íƒ ë³€ê²½:', e.target.value);
                renderRecordTable();
            });
            console.log('ìƒíƒœ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
        } else {
            console.error('statusSelect ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        document.getElementById('add-record-btn').addEventListener('click', () => {
            try {
                // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const currentUser = getCurrentUser();
                const isEducationManager = currentUser && currentUser.role === 'EDUCATION_MANAGER';
                
                // í˜„ì¬ ì‚¬ìš©ìê°€ ì‹¬ì‚¬ì ëª©ë¡ì— ì—†ìœ¼ë©´ ì¶”ê°€
                if (!db.auditors[currentUser.userName]) {
                    db.auditors[currentUser.userName] = {
                        info: {
                            name: currentUser.userName,
                            dept: currentUser.orgName,
                            rank: 'ì‹¬ì‚¬ì›' // ê¸°ë³¸ê°’
                        },
                        records: []
                    };
                    saveData();
                }
                
            const courseOptions = db.courses
                .filter(c => c.dataSource === 'EXTERNAL')
                .map(c => `<option value="${c.id}">${c.name}</option>`)
                .join('');
                
                // ë¶€ì„œ ëª©ë¡ ìƒì„±
                const deptOptions = ['ì‹ ì•½ì‹¬ì‚¬ë¶€', 'í—ˆê°€ì´ê´„ë¶€', 'ìƒë¬¼ì˜ì•½í’ˆë¶€', 'í’ˆì§ˆì•ˆì „ë¶€', 'ì„ìƒì •ì±…ë¶€']
                    .map(dept => `<option value="${dept}">${dept}</option>`)
                    .join('');
                
                // ì‹¬ì‚¬ì ì„ íƒ ì˜µì…˜ ìƒì„± (ê´€ë¦¬ìì¸ ê²½ìš°)
                let auditorSelectHtml = '';
                if (isEducationManager) {
                    auditorSelectHtml = `
                        <div class="form-group">
                            <label for="modal-auditorDept">ë¶€ì„œ</label>
                            <select id="modal-auditorDept" name="auditorDept" required>
                                <option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                ${deptOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="modal-auditorName">ì‹¬ì‚¬ì ì´ë¦„</label>
                            <input type="text" id="modal-auditorName" name="auditorName" placeholder="ì‹¬ì‚¬ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                        </div>`;
                } else {
                    auditorSelectHtml = `
                        <div class="form-group">
                            <label for="modal-auditorName">ì‹¬ì‚¬ì</label>
                            <input type="text" id="modal-auditorName" name="auditorName" value="${currentUser.userName}" readonly style="background-color: #f5f5f5;">
                        </div>`;
                }
                
            const formHtml = `
                    ${auditorSelectHtml}
                <div class="form-group"><label for="modal-courseId">êµìœ¡ê³¼ì •</label><select id="modal-courseId" name="courseId" required>${courseOptions}</select></div>
                <div class="form-group"><label for="modal-date">ì´ìˆ˜ì¼ì</label><input type="date" id="modal-date" name="date" value="${new Date().toISOString().slice(0,10)}" required></div>
                <div class="form-group"><label for="modal-status">ìƒíƒœ</label><select id="modal-status" name="status" required><option value="ìŠ¹ì¸ëŒ€ê¸°">ìŠ¹ì¸ëŒ€ê¸°</option><option value="ìŠ¹ì¸">ìŠ¹ì¸</option><option value="ë°˜ë ¤">ë°˜ë ¤</option></select></div>
                    <div class="form-group"><label for="modal-file">ì¦ë¹™ìë£Œ</label><input type="file" id="modal-file" name="file"></div>
                    <div class="form-group"><label for="modal-notes">ë¹„ê³ </label><textarea id="modal-notes" name="notes" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;" placeholder="êµìœ¡ ë‚´ìš© ìš”ì•½ì´ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea></div>`;
                
                const modalTitle = isEducationManager ? 'ì´ìˆ˜ ê¸°ë¡ ë“±ë¡ (ê´€ë¦¬ì)' : 'ë‚´ ì´ìˆ˜ ê¸°ë¡ ë“±ë¡';
                openModal(modalTitle, formHtml);
                
                // ê´€ë¦¬ìì¸ ê²½ìš° ë¶€ì„œ ì„ íƒ ì‹œ í•´ë‹¹ ë¶€ì„œì˜ ì‹¬ì‚¬ì ëª©ë¡ í‘œì‹œ
                if (isEducationManager) {
                    const auditorDeptSelect = document.getElementById('modal-auditorDept');
                    const auditorNameInput = document.getElementById('modal-auditorName');
                    
                    // ë¶€ì„œë³„ ì‹¬ì‚¬ì ëª©ë¡ì„ í‘œì‹œí•  ì»¨í…Œì´ë„ˆ ì¶”ê°€
                    const auditorListContainer = document.createElement('div');
                    auditorListContainer.id = 'auditorListContainer';
                    auditorListContainer.style.marginTop = '8px';
                    auditorListContainer.style.display = 'none';
                    auditorDeptSelect.parentNode.appendChild(auditorListContainer);
                    
                    auditorDeptSelect.addEventListener('change', function() {
                        const selectedDept = this.value;
                        auditorNameInput.value = '';
                        auditorListContainer.innerHTML = '';
                        auditorListContainer.style.display = 'none';
                        
                        if (selectedDept) {
                            // í•´ë‹¹ ë¶€ì„œì˜ ì‹¬ì‚¬ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                            const deptAuditors = Object.keys(db.auditors).filter(name => 
                                db.auditors[name].info.dept === selectedDept
                            );
                            
                            if (deptAuditors.length > 0) {
                                auditorListContainer.innerHTML = `
                                    <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">
                                        ${selectedDept} ì†Œì† ì‹¬ì‚¬ì:
                                    </div>
                                    <div style="max-height: 100px; overflow-y: auto; border: 1px solid var(--line); border-radius: 4px; padding: 8px; background: #f9f9f9;">
                                        ${deptAuditors.map(name => 
                                            `<div style="padding: 2px 0; cursor: pointer; font-size: 12px;" onclick="document.getElementById('modal-auditorName').value='${name}'">${name}</div>`
                                        ).join('')}
                                    </div>
                                `;
                                auditorListContainer.style.display = 'block';
                            } else {
                                auditorListContainer.innerHTML = `
                                    <div style="font-size: 12px; color: var(--muted);">
                                        ${selectedDept}ì— ë“±ë¡ëœ ì‹¬ì‚¬ìê°€ ì—†ìŠµë‹ˆë‹¤.
                                    </div>
                                `;
                                auditorListContainer.style.display = 'block';
                            }
                        }
                    });
                }
                
            } catch (error) {
                console.error('ì´ìˆ˜ ê¸°ë¡ ë“±ë¡ ë²„íŠ¼ ì˜¤ë¥˜:', error);
                showToast('ì´ìˆ˜ ê¸°ë¡ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });

        // ì´ìˆ˜ ê¸°ë¡ ëŒ€ëŸ‰ ë“±ë¡ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('bulk-insert-records-btn').addEventListener('click', () => {
            showBulkInsertRecordsModal();
        });

        document.querySelector('#recordTable tbody').addEventListener('click', e => {
            console.log('Table clicked, target:', e.target);
            const btn = e.target.closest('button');
            const row = e.target.closest('tr');
            console.log('Button found:', btn);
            console.log('Row found:', row);
            if (!row) {
                console.log('No row found, returning');
                return;
            }
            const id = row.dataset.id;
            console.log('Row ID:', id);
            
            // ëª¨ë“  rowë¥¼ í´ë¦­í–ˆì„ ë•Œ (ë²„íŠ¼ì´ ì•„ë‹Œ ê²½ìš°)
            if (!btn) {
                console.log('Row clicked, ID:', id);
                console.log('Row dataset:', row.dataset);
                
                // í˜„ì¬ í‘œì‹œëœ ê¸°ë¡ì—ì„œ ì°¾ê¸° (ì›ë³¸ ID ì‚¬ìš©)
                const record = currentDisplayedRecords.find(r => r.id == id);
                console.log('Current displayed records:', currentDisplayedRecords.length);
                console.log('Looking for record with ID:', id);
                console.log('Found record:', record);
                
                if (record) {
                    console.log('Showing record details modal for record:', record);
                    showRecordDetailsModal(record);
                    return;
                } else {
                    console.log('Record not found in displayed records for ID:', id);
                    console.log('Available displayed record IDs:', currentDisplayedRecords.map(r => r.id));
                }
            }
            
            if (!btn) return;
            
            if (btn.classList.contains('btn-edit-record')) {
                console.log('=== ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ë””ë²„ê·¸ ===');
                console.log('í´ë¦­ëœ ë²„íŠ¼:', btn);
                console.log('ì°¾ê³  ìˆëŠ” ID:', id);
                
                // ëª¨ë“  ì‹¬ì‚¬ìì—ì„œ í•´ë‹¹ IDì˜ ê¸°ë¡ì„ ì°¾ê¸°
                let record = null;
                let auditorName = null;
                
                for (const [name, auditor] of Object.entries(db.auditors)) {
                    if (auditor.records) {
                        const foundRecord = auditor.records.find(r => r.id == id);
                        if (foundRecord) {
                            record = foundRecord;
                            auditorName = name;
                            console.log('ê¸°ë¡ ì°¾ìŒ:', foundRecord, 'ì‹¬ì‚¬ì:', name);
                            break;
                        }
                    }
                }
                
                if (record) {
                    console.log('ìˆ˜ì •í•  ê¸°ë¡:', record);
                    const options = db.courses
                        .filter(c => c.dataSource === 'EXTERNAL')
                        .map(c => `<option value="${c.id}" ${c.id === record.courseId ? 'selected' : ''}>${c.name}</option>`)
                        .join('');
                    const formHtml = `
                        <input type="hidden" id="modal-recordId" name="recordId" value="${record.id}">
                        <div class="form-group"><label for="modal-courseId">êµìœ¡ê³¼ì •</label><select id="modal-courseId" name="courseId" required>${options}</select></div>
                        <div class="form-group"><label for="modal-date">ì´ìˆ˜ì¼ì</label><input type="date" id="modal-date" name="date" value="${record.date || ''}" required></div>
                        <div class="form-group"><label for="modal-file">ì¦ë¹™ìë£Œ</label><input type="file" id="modal-file" name="file"></div>
                        <div class="form-group"><label for="modal-notes">ë¹„ê³ </label><textarea id="modal-notes" name="notes" rows="3" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;" placeholder="êµìœ¡ ë‚´ìš© ìš”ì•½ì´ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”">${record.notes || ''}</textarea></div>`;
                    console.log('ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°');
                    openModal('ì´ìˆ˜ ê¸°ë¡ ìˆ˜ì •', formHtml, record);
                } else {
                    console.error('ìˆ˜ì •í•  ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ID:', id);
                    showToast('ìˆ˜ì •í•  ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } else if (btn.classList.contains('btn-delete-record')) {
                const courseName = db.courses.find(c => c.id == btn.closest('tr').dataset.courseId).name;
                if (confirm(`'${courseName}' ì´ìˆ˜ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    // ëª¨ë“  ì‹¬ì‚¬ìì—ì„œ í•´ë‹¹ IDì˜ ê¸°ë¡ì„ ì°¾ì•„ì„œ ì‚­ì œ
                    for (const [name, auditor] of Object.entries(db.auditors)) {
                        if (auditor.records) {
                            const recordIndex = auditor.records.findIndex(r => r.id == id);
                            if (recordIndex !== -1) {
                                auditor.records.splice(recordIndex, 1);
                                break;
                            }
                        }
                    }
                    saveData();
                    renderAll();
                }
            } else if (btn.classList.contains('btn-approve-record')) {
                // í˜„ì¬ í‘œì‹œëœ ê¸°ë¡ì—ì„œ ì°¾ê¸° (ì›ë³¸ ID ì‚¬ìš©)
                const record = currentDisplayedRecords.find(r => r.id == id);
                console.log('Approve button clicked, found record:', record);
                
                if (record) {
                    showApprovalModal(record, 'approve');
                } else {
                    console.error('Record not found for approve button');
                    showToast('ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } else if (btn.classList.contains('btn-reject-record')) {
                // í˜„ì¬ í‘œì‹œëœ ê¸°ë¡ì—ì„œ ì°¾ê¸° (ì›ë³¸ ID ì‚¬ìš©)
                const record = currentDisplayedRecords.find(r => r.id == id);
                console.log('Reject button clicked, found record:', record);
                
                if (record) {
                    showApprovalModal(record, 'reject');
                } else {
                    console.error('Record not found for reject button');
                    showToast('ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            }
        });

        // EDU-005 ì´ë²¤íŠ¸ - ë³´ê³ ì„œ ìœ í˜• ì„ íƒ
        document.querySelectorAll('input[name="reportType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const personalReport = document.getElementById('personalReport');
                const departmentReport = document.getElementById('departmentReport');
                
                if (e.target.value === 'personal') {
                    personalReport.style.display = 'block';
                    departmentReport.style.display = 'none';
                } else {
                    personalReport.style.display = 'none';
                    departmentReport.style.display = 'block';
                }
            });
        });

        // ê°œì¸ë³„ ë³´ê³ ì„œ ì´ë²¤íŠ¸
        const personalReportForm = document.getElementById('personalReportForm');
        personalReportForm.addEventListener('submit', e => {
            e.preventDefault();
            const startDate = document.getElementById('personalStartDate').value;
            const endDate = document.getElementById('personalEndDate').value;
            const deptFilter = document.getElementById('personalDeptSelect').value;
            const auditorName = document.getElementById('personalAuditorInput').value.trim();
            renderPersonalReport(startDate, endDate, deptFilter, auditorName);
        });
        personalReportForm.addEventListener('reset', () => {
            document.getElementById('personalReportSummary').innerHTML = '';
            document.querySelector('#personalReportTable tbody').innerHTML = '';
        });

        // ë¶€ì„œë³„ ë³´ê³ ì„œ ì´ë²¤íŠ¸
        const departmentReportForm = document.getElementById('departmentReportForm');
        departmentReportForm.addEventListener('submit', e => {
            e.preventDefault();
            const startDate = document.getElementById('deptStartDate').value;
            const endDate = document.getElementById('deptEndDate').value;
            const deptFilter = document.getElementById('deptReportSelect').value;
            const auditorName = document.getElementById('deptAuditorInput').value.trim();
            renderDepartmentReport(startDate, endDate, deptFilter, auditorName);
        });
        departmentReportForm.addEventListener('reset', () => {
            document.getElementById('departmentReportSummary').innerHTML = '';
            document.querySelector('#reportTable tbody').innerHTML = '';
        });

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì´ë²¤íŠ¸
        document.getElementById('personalExcelBtn').addEventListener('click', () => {
            downloadPersonalReportExcel();
        });
        document.getElementById('departmentExcelBtn').addEventListener('click', () => {
            downloadDepartmentReportExcel();
        });

        // ì¸ì‡„ ì´ë²¤íŠ¸
        document.getElementById('personalPrintBtn').addEventListener('click', () => {
            printPersonalReport();
        });
        document.getElementById('departmentPrintBtn').addEventListener('click', () => {
            printDepartmentReport();
        });

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ë“¤
        const downloadPersonalReportExcel = () => {
            const table = document.getElementById('personalReportTable');
            const data = [];
            
            // í—¤ë” ì¶”ê°€
            const headers = ['ê³ ìœ ID', 'ë¶€ì„œ', 'ì„±ëª…', 'êµìœ¡ì‚¬ì—…ëª…', 'ì„¸ë¶€ê³¼ì •(í”„ë¡œê·¸ë¨)ëª…', 'êµìœ¡ê¸°ê°„', 'ì´ìˆ˜ì¼ì', 'ì¸ì •ì‹œê°„', 'ìƒíƒœ', 'ë°ì´í„°ì†ŒìŠ¤'];
            data.push(headers);
            
            // ë°ì´í„° ì¶”ê°€
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach(cell => {
                    rowData.push(cell.textContent.trim());
                });
                data.push(rowData);
            });
            
            // Excel íŒŒì¼ë¡œ ë³€í™˜
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ê°œì¸ë³„ êµìœ¡ì‹¤ì  ë³´ê³ ì„œ');
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(wb, `ê°œì¸ë³„_êµìœ¡ì‹¤ì ë³´ê³ ì„œ_${new Date().toISOString().slice(0,10)}.xlsx`);
            
            showToast('ê°œì¸ë³„ êµìœ¡ì‹¤ì  ë³´ê³ ì„œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        };

        const downloadDepartmentReportExcel = () => {
            const table = document.getElementById('reportTable');
            const data = [];
            
            // í—¤ë” ì¶”ê°€
            const headers = ['ë¶€ì„œ', 'ì„±ëª…', 'êµìœ¡ì‚¬ì—…ëª…', 'ì„¸ë¶€ê³¼ì •(í”„ë¡œê·¸ë¨)ëª…', 'êµìœ¡ê¸°ê°„', 'ì´ìˆ˜ì¼ì', 'í•„ìˆ˜ì—¬ë¶€', 'ì¸ì •ì‹œê°„', 'ìƒíƒœ', 'ë°ì´í„°ì†ŒìŠ¤'];
            data.push(headers);
            
            // ë°ì´í„° ì¶”ê°€
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach(cell => {
                    rowData.push(cell.textContent.trim());
                });
                data.push(rowData);
            });
            
            // Excel íŒŒì¼ë¡œ ë³€í™˜
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ë¶€ì„œë³„ êµìœ¡ì‹¤ì  ë³´ê³ ì„œ');
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(wb, `ë¶€ì„œë³„_êµìœ¡ì‹¤ì ë³´ê³ ì„œ_${new Date().toISOString().slice(0,10)}.xlsx`);
            
            showToast('ë¶€ì„œë³„ êµìœ¡ì‹¤ì  ë³´ê³ ì„œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        };

        // ì¸ì‡„ í•¨ìˆ˜ë“¤
        const printPersonalReport = () => {
            const printWindow = window.open('', '_blank');
            const table = document.getElementById('personalReportTable');
            const summary = document.getElementById('personalReportSummary').innerHTML;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>ê°œì¸ë³„ êµìœ¡ì‹¤ì  ë³´ê³ ì„œ</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #2c3e50; text-align: center; }
                        .summary { background: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 5px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
                        .status.ok { background: #d4edda; color: #155724; }
                        .status.wait { background: #fff3cd; color: #856404; }
                        .status.error { background: #f8d7da; color: #721c24; }
                    </style>
                </head>
                <body>
                    <h1>ê°œì¸ë³„ êµìœ¡ì‹¤ì  ë³´ê³ ì„œ</h1>
                    <div class="summary">${summary}</div>
                    ${table.outerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        };

        const printDepartmentReport = () => {
            const printWindow = window.open('', '_blank');
            const table = document.getElementById('reportTable');
            const summary = document.getElementById('departmentReportSummary').innerHTML;
            
            const htmlContent = '<html>' +
                '<head>' +
                    '<title>ë¶€ì„œë³„ êµìœ¡ì‹¤ì  ë³´ê³ ì„œ</title>' +
                    '<style>' +
                        'body { font-family: Arial, sans-serif; margin: 20px; }' +
                        'h1 { color: #2c3e50; text-align: center; }' +
                        '.summary { background: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 5px; }' +
                        'table { width: 100%; border-collapse: collapse; margin: 20px 0; }' +
                        'th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }' +
                        'th { background-color: #f2f2f2; font-weight: bold; }' +
                        '.status { padding: 4px 8px; border-radius: 4px; font-size: 12px; }' +
                        '.status.ok { background: #d4edda; color: #155724; }' +
                        '.status.wait { background: #fff3cd; color: #856404; }' +
                        '.status.error { background: #f8d7da; color: #721c24; }' +
                    '</style>' +
                '</head>' +
                '<body>' +
                    '<h1>ë¶€ì„œë³„ êµìœ¡ì‹¤ì  ë³´ê³ ì„œ</h1>' +
                    '<div class="summary">' + summary + '</div>' +
                    table.outerHTML +
                '</body>' +
                '</html>';
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.print();
        };

        // --- ì‚¬ìš©ì ì •ë³´ ê´€ë¦¬ ---
        const getCurrentUser = () => {
            // ì‹¤ì œë¡œëŠ” ì„¸ì…˜ ë˜ëŠ” í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
            // í˜„ì¬ëŠ” localStorageì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²ƒìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜
            const userInfo = localStorage.getItem('currentUser');
            if (userInfo) {
                return JSON.parse(userInfo);
            }
            // ê¸°ë³¸ê°’ ë°˜í™˜ (ê¸°ì¡´ ë°ì´í„°ì— ìˆëŠ” ì‹¬ì‚¬ìë¡œ ì„¤ì •)
            return {
                orgName: "ì‹ ì•½ì‹¬ì‚¬ë¶€",
                userName: "í™ê¸¸ë™",
                role: "EDUCATION_MANAGER", // êµìœ¡ ê´€ë¦¬ ê¶Œí•œ
                permissions: ["COURSE_MANAGE", "BULK_INSERT", "RECORD_MANAGE"]
            };
        };

        // ê¶Œí•œ ì²´í¬ í•¨ìˆ˜
        const hasPermission = (permission) => {
            const currentUser = getCurrentUser();
            return currentUser.permissions && currentUser.permissions.includes(permission);
        };

        // êµìœ¡ ê´€ë¦¬ ê¶Œí•œ ì²´í¬
        const isEducationManager = () => {
            const currentUser = getCurrentUser();
            return currentUser.role === "EDUCATION_MANAGER" || hasPermission("COURSE_MANAGE");
        };

        const updateUserInfo = () => {
            const currentUser = getCurrentUser();
            const userInfoElement = document.getElementById('currentUserInfo');
            if (userInfoElement) {
                userInfoElement.textContent = `${currentUser.orgName} - ${currentUser.userName}`;
            }
        };


        // --- API ë™ê¸°í™” ---
        const syncWithAPI = async () => {
            try {
                showToast('API ë™ê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...');
                
                // ì‹¤ì œ API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜
                // í‰ê°€ì› êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œì—ì„œ ë“±ë¡í•œ ì‹¤ì œ êµìœ¡ê³¼ì • ë°ì´í„°
                const mockApiData = [
                    {
                        id: 30,
                        name: "2025ë…„ ì‹ ê·œ ì˜ì•½í’ˆ ì‹¬ì‚¬ ê°€ì´ë“œë¼ì¸",
                        desc: "2025ë…„ë„ ì‹ ê·œ ì˜ì•½í’ˆ ì‹¬ì‚¬ ê¸°ì¤€ ë° ê°€ì´ë“œë¼ì¸",
                        startDate: "2025-04-01",
                        endDate: "2025-04-30",
                        type: "í•„ìˆ˜",
                        hours: 8,
                        regDate: new Date().toISOString().slice(0,10),
                        dataSource: "API",
                        orgName: "í‰ê°€ì› êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ",
                        registrant: "ì´í‰ê°€"
                    },
                    {
                        id: 31,
                        name: "ì˜ì•½í’ˆ ì„ìƒì‹œí—˜ ë°ì´í„° ë¶„ì„",
                        desc: "ì„ìƒì‹œí—˜ ë°ì´í„° ë¶„ì„ ë° í•´ì„ ë°©ë²•ë¡ ",
                        startDate: "2025-05-15",
                        endDate: "2025-05-25",
                        type: "ì„ íƒ",
                        hours: 12,
                        regDate: new Date().toISOString().slice(0,10),
                        dataSource: "API",
                        orgName: "í‰ê°€ì› êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ",
                        registrant: "ë°•ë°ì´í„°"
                    },
                    {
                        id: 32,
                        name: "ì˜ì•½í’ˆ ì•ˆì „ì„± ëª¨ë‹ˆí„°ë§ ì‹¤ë¬´",
                        desc: "ì˜ì•½í’ˆ ì•ˆì „ì„± ëª¨ë‹ˆí„°ë§ ë° ë¶€ì‘ìš© ê´€ë¦¬ ì‹¤ë¬´ êµìœ¡",
                        startDate: "2025-06-01",
                        endDate: "2025-06-15",
                        type: "í•„ìˆ˜",
                        hours: 10,
                        regDate: new Date().toISOString().slice(0,10),
                        dataSource: "API",
                        orgName: "í‰ê°€ì› êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ",
                        registrant: "ê¹€ì•ˆì „"
                    },
                    {
                        id: 33,
                        name: "ë°”ì´ì˜¤ì˜ì•½í’ˆ ì‹¬ì‚¬ ì‹¤ë¬´",
                        desc: "ë°”ì´ì˜¤ì˜ì•½í’ˆ ì‹¬ì‚¬ ê¸°ì¤€ ë° ì‹¤ë¬´ êµìœ¡",
                        startDate: "2025-07-01",
                        endDate: "2025-07-10",
                        type: "í•„ìˆ˜",
                        hours: 14,
                        regDate: new Date().toISOString().slice(0,10),
                        dataSource: "API",
                        orgName: "í‰ê°€ì› êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ",
                        registrant: "ìµœë°”ì´ì˜¤"
                    },
                    {
                        id: 34,
                        name: "ì˜ì•½í’ˆ í’ˆì§ˆê´€ë¦¬ ì‹¬í™”ê³¼ì •",
                        desc: "ì˜ì•½í’ˆ í’ˆì§ˆê´€ë¦¬ ê³ ê¸‰ ì‹¤ë¬´ ë° ê²€ì‚¬ ë°©ë²•ë¡ ",
                        startDate: "2025-08-01",
                        endDate: "2025-08-20",
                        type: "ì„ íƒ",
                        hours: 16,
                        regDate: new Date().toISOString().slice(0,10),
                        dataSource: "API",
                        orgName: "í‰ê°€ì› êµìœ¡ê´€ë¦¬ì‹œìŠ¤í…œ",
                        registrant: "ê°•í’ˆì§ˆ"
                    }
                ];
                
                // ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ìƒˆ ë°ì´í„°ë§Œ ì¶”ê°€
                const existingIds = new Set(db.courses.map(c => c.id));
                const newCourses = mockApiData.filter(course => !existingIds.has(course.id));
                
                if (newCourses.length > 0) {
                    db.courses.push(...newCourses);
                    saveData();
                    renderAll();
                    showToast(`API ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ${newCourses.length}ê°œì˜ ìƒˆë¡œìš´ êµìœ¡ê³¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } else {
                    showToast('API ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¶”ê°€í•  ìƒˆë¡œìš´ êµìœ¡ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                showToast('API ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error('API ë™ê¸°í™” ì˜¤ë¥˜:', error);
            }
        };

        // ì´ìˆ˜ ê¸°ë¡ API ë™ê¸°í™” í•¨ìˆ˜
        const syncRecordsWithAPI = async () => {
            try {
                showToast('ì´ìˆ˜ ê¸°ë¡ API ë™ê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...');
                
                // database.jsì—ì„œ API ë™ê¸°í™”ìš© ì´ìˆ˜ ê¸°ë¡ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const mockRecordsApiData = EducationDatabase.apiRecords;
                
                // ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ìƒˆ ì´ìˆ˜ ê¸°ë¡ë§Œ ì¶”ê°€
                let addedCount = 0;
                
                mockRecordsApiData.forEach(record => {
                    if (!db.auditors[record.auditorName]) {
                        db.auditors[record.auditorName] = {
                            info: {
                                name: record.auditorName,
                                dept: record.dept,
                                rank: record.rank
                            },
                            records: []
                        };
                    }
                    
                    if (!db.auditors[record.auditorName].records) {
                        db.auditors[record.auditorName].records = [];
                    }
                    
                    // ì¤‘ë³µ ì²´í¬: ê°™ì€ IDì˜ ê¸°ë¡ì´ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
                    const existingRecord = db.auditors[record.auditorName].records.find(r => r.id === record.id);
                    if (!existingRecord) {
                        db.auditors[record.auditorName].records.push({
                            id: record.id,
                            courseId: record.courseId,
                            date: record.completionDate,
                            status: record.status,
                            dataSource: record.dataSource,
                            registrant: record.registrant,
                            auditorName: record.auditorName, // ì‹¬ì‚¬ì ì´ë¦„ ì¶”ê°€
                            approve: 'ìŠ¹ì¸' // APIì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ëŠ” ì´ë¯¸ ìŠ¹ì¸ëœ ê²ƒë§Œ
                        });
                        addedCount++;
                    }
                });
                
                if (addedCount > 0) {
                    saveData();
                    renderAll();
                    showToast(`ì´ìˆ˜ ê¸°ë¡ API ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ${addedCount}ê°œì˜ ìƒˆë¡œìš´ ì´ìˆ˜ ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (ìë™ ìŠ¹ì¸ ì²˜ë¦¬ë¨)`);
                } else {
                    showToast('ì´ìˆ˜ ê¸°ë¡ API ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¶”ê°€í•  ìƒˆë¡œìš´ ì´ìˆ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('ì´ìˆ˜ ê¸°ë¡ API ë™ê¸°í™” ì˜¤ë¥˜:', error);
                showToast('ì´ìˆ˜ ê¸°ë¡ API ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        };

        // --- ê³µí†µ ìœ í‹¸ë¦¬í‹° ---
        const showToast = (message) => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '1'; }, 100);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => { container.removeChild(toast); }, 500);
            }, 3000);
        };
        
        // ì •ë ¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const table = header.closest('table');
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const sortBy = header.dataset.sort;
                const currentDir = header.dataset.dir || 'desc';
                const newDir = currentDir === 'asc' ? 'desc' : 'asc';
                
                // ëª¨ë“  í—¤ë”ì˜ ì •ë ¬ ë°©í–¥ ì´ˆê¸°í™”
                table.querySelectorAll('th').forEach(th => th.removeAttribute('data-dir'));
                header.dataset.dir = newDir; // í˜„ì¬ í´ë¦­ëœ í—¤ë”ì—ë§Œ ë°©í–¥ ì„¤ì •

                rows.sort((a, b) => {
                    // ì…€ ì¸ë±ìŠ¤ ì°¾ê¸°
                    const colIndex = Array.from(header.parentElement.children).indexOf(header);
                    let valA = a.cells[colIndex].textContent.trim();
                    let valB = b.cells[colIndex].textContent.trim();
                    
                    // ìˆ«ìë‚˜ ë‚ ì§œ ë¹„êµ
                    if (!isNaN(valA) && !isNaN(valB)) {
                        return (valA - valB) * (newDir === 'asc' ? 1 : -1);
                    }
                    if (valA.match(/^\d{4}-\d{2}-\d{2}$/) && valB.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        return (new Date(valA) - new Date(valB)) * (newDir === 'asc' ? 1 : -1);
                    }

                    // ë¬¸ìì—´ ë¹„êµ
                    return valA.localeCompare(valB) * (newDir === 'asc' ? 1 : -1);
                });
                
                tbody.innerHTML = '';
                rows.forEach(row => tbody.appendChild(row));
            });
        });


        // --- Bulk Insert ê¸°ëŠ¥ (ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬) ---
        const showBulkInsertModal = () => {
            if (!isEducationManager()) {
                alert('êµìœ¡ ê´€ë¦¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            // ë³„ë„ HTML íŒŒì¼ì„ íŒì—…ìœ¼ë¡œ ì—´ê¸°
            const popup = window.open('bulk-insert.html', 'bulkInsertPopup', 'width=900,height=700,scrollbars=yes,resizable=yes');
        };

        // --- ì´ìˆ˜ ê¸°ë¡ Bulk Insert ê¸°ëŠ¥ ---
        const showBulkInsertRecordsModal = () => {
            if (!isEducationManager()) {
                alert('êµìœ¡ ê´€ë¦¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            // ë³„ë„ HTML íŒŒì¼ì„ íŒì—…ìœ¼ë¡œ ì—´ê¸°
            const popup = window.open('bulk-insert-records.html', 'bulkInsertRecordsPopup', 'width=1000,height=800,scrollbars=yes,resizable=yes');
            
            // íŒì—…ì´ ë¡œë“œëœ í›„ êµìœ¡ê³¼ì • ë°ì´í„° ì „ì†¡
            popup.addEventListener('load', () => {
                popup.postMessage({
                    type: 'COURSE_DATABASE',
                    courses: db.courses
                }, '*');
            });
        };

        // íŒì—…ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„° ì²˜ë¦¬
        const handleBulkInsertData = (coursesData) => {
            if (!isEducationManager()) {
                alert('êµìœ¡ ê´€ë¦¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            if (coursesData.length === 0) {
                alert('ë“±ë¡í•  êµìœ¡ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // êµìœ¡ê³¼ì • ì¶”ê°€
            const newCourses = coursesData.map((course, index) => ({
                id: db.courses.length + index + 1,
                name: course.name,
                desc: course.desc,
                startDate: course.startDate,
                endDate: course.endDate,
                type: course.type,
                hours: course.hours,
                regDate: new Date().toISOString().slice(0, 10),
                dataSource: "EXTERNAL",
                orgName: course.orgName,
                registrant: course.registrant
            }));

            db.courses.push(...newCourses);
            localStorage.setItem('eduDb', JSON.stringify(db));
            
            alert(`${newCourses.length}ê°œì˜ êµìœ¡ê³¼ì •ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            renderAll();
        };

        // ì´ìˆ˜ ê¸°ë¡ ëŒ€ëŸ‰ ë“±ë¡ ë°ì´í„° ì²˜ë¦¬
        const handleBulkInsertRecordsData = (recordsData) => {
            if (!isEducationManager()) {
                alert('êµìœ¡ ê´€ë¦¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            if (recordsData.length === 0) {
                alert('ë“±ë¡í•  ì´ìˆ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            let successCount = 0;
            let errorCount = 0;

            recordsData.forEach(record => {
                try {
                    // ì‹¬ì‚¬ìê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒì„±
                    if (!db.auditors[record.auditorName]) {
                        db.auditors[record.auditorName] = {
                            info: {
                                name: record.auditorName,
                                dept: record.dept,
                                rank: 'ì‹¬ì‚¬ì›' // ê¸°ë³¸ê°’
                            },
                            records: []
                        };
                    }

                    // êµìœ¡ê³¼ì • ì •ë³´ í™•ì¸
                    const course = db.courses.find(c => c.id == record.courseId);
                    if (!course) {
                        console.error('êµìœ¡ê³¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', record.courseId);
                        errorCount++;
                        return;
                    }

                    // ìŠ¹ì¸ì—¬ë¶€ ë³€í™˜ ('ëŒ€ê¸°' -> 'ìŠ¹ì¸ëŒ€ê¸°')
                    let approveStatus = record.approval;
                    if (approveStatus === 'ëŒ€ê¸°') {
                        approveStatus = 'ìŠ¹ì¸ëŒ€ê¸°';
                    }
                    
                    // ì´ìˆ˜ ê¸°ë¡ ìƒì„±
                    const newRecord = {
                        id: Date.now() + Math.random(), // ê³ ìœ  ID ìƒì„±
                        courseId: parseInt(record.courseId),
                        date: record.completionDate,
                        status: 'completed',
                        dataSource: course.dataSource === 'API' ? 'API' : 'EXTERNAL',
                        registrant: record.auditorName,
                        auditorName: record.auditorName,
                        approve: approveStatus,
                        notes: '',
                        fileName: ''
                    };

                    // ì´ìˆ˜ ê¸°ë¡ ì¶”ê°€
                    db.auditors[record.auditorName].records.push(newRecord);
                    successCount++;

                } catch (error) {
                    console.error('ì´ìˆ˜ ê¸°ë¡ ë“±ë¡ ì˜¤ë¥˜:', error, record);
                    errorCount++;
                }
            });

            if (successCount > 0) {
                saveData();
                renderAll();
            }

            let message = `${successCount}ê°œì˜ ì´ìˆ˜ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            if (errorCount > 0) {
                message += `\n${errorCount}ê°œì˜ ê¸°ë¡ì€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`;
            }
            alert(message);
        };

        // ê¶Œí•œì— ë”°ë¥¸ UI ì—…ë°ì´íŠ¸
        const updateUIByPermission = () => {
            const bulkInsertBtn = document.getElementById('bulk-insert-btn');
            const bulkInsertRecordsBtn = document.getElementById('bulk-insert-records-btn');
            
            if (isEducationManager()) {
                if (bulkInsertBtn) {
                    bulkInsertBtn.style.display = 'inline-block';
                }
                if (bulkInsertRecordsBtn) {
                    bulkInsertRecordsBtn.style.display = 'inline-block';
                }
            } else {
                if (bulkInsertBtn) {
                    bulkInsertBtn.style.display = 'none';
                }
                if (bulkInsertRecordsBtn) {
                    bulkInsertRecordsBtn.style.display = 'none';
                }
            }
        };

        // ì‚¬ìš©ì ê¶Œí•œ ì „í™˜ ê¸°ëŠ¥
        const switchUserRole = () => {
            const currentUser = getCurrentUser();
            const isManager = isEducationManager();
            
            if (isManager) {
                // êµìœ¡ ê´€ë¦¬ìì—ì„œ ì¼ë°˜ ì‚¬ìš©ìë¡œ ì „í™˜
                const newUser = {
                    orgName: "ì‹ ì•½ì‹¬ì‚¬ë¶€",
                    userName: "ê¹€ì¼ë°˜",
                    role: "AUDITOR",
                    permissions: ["RECORD_MANAGE"]
                };
                localStorage.setItem('currentUser', JSON.stringify(newUser));
            } else {
                // ì¼ë°˜ ì‚¬ìš©ìì—ì„œ êµìœ¡ ê´€ë¦¬ìë¡œ ì „í™˜
                const newUser = {
                    orgName: "ì‹ ì•½ì‹¬ì‚¬ë¶€",
                    userName: "í™ê¸¸ë™",
                    role: "EDUCATION_MANAGER",
                    permissions: ["COURSE_MANAGE", "BULK_INSERT", "RECORD_MANAGE"]
                };
                localStorage.setItem('currentUser', JSON.stringify(newUser));
            }
            
            updateUserInfo();
            updateUIByPermission();
            renderAll(); // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
        };

        // íŒì—… ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ
        window.addEventListener('message', (event) => {
            if (event.data.type === 'bulkInsertCourses') {
                handleBulkInsertData(event.data.data);
            } else if (event.data.type === 'bulkInsertRecords') {
                handleBulkInsertRecordsData(event.data.data);
            } else if (event.data.type === 'REQUEST_COURSE_DATABASE') {
                // ì´ìˆ˜ ê¸°ë¡ ëŒ€ëŸ‰ ë“±ë¡ íŒì—…ì—ì„œ êµìœ¡ê³¼ì • ë°ì´í„° ìš”ì²­ ì‹œ ì‘ë‹µ
                event.source.postMessage({
                    type: 'COURSE_DATABASE',
                    courses: db.courses
                }, '*');
            }
        });

        // --- ì•± ì‹œì‘ ---
        initData();
        updateUserInfo();
        updateUIByPermission();
        
        // ì´ˆê¸° ê²€ìƒ‰ ê²°ê³¼ ê°œìˆ˜ í‘œì‹œ
        const searchResultInfo = document.getElementById('searchResultInfo');
        if (searchResultInfo) {
            searchResultInfo.textContent = `ê²€ìƒ‰ ê²°ê³¼: ${db.courses.length}ê±´`;
        }
    });
</script>
</body>
</html>