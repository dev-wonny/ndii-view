<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>유통 흐름 분석</title>
    <!-- Google Charts 라이브러리 로드 -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root {
            --bg-color: #f4f6f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-color: #e0e0e0;
            --primary-color: #3498db;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        body {
            font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        h1 {
            font-size: 24px;
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        /* --- 필터 영역 --- */
        .filter-section {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-group label {
            font-weight: bold;
            font-size: 14px;
        }
        .filter-group select, .filter-group input[type="date"] {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        /* --- 컨텐츠 영역 --- */
        .content-section {
            margin-top: 20px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .section-header h2 {
            font-size: 18px;
            margin: 0;
        }
        
        /* --- Sankey 차트 --- */
        #sankey-chart {
            width: 100%;
            height: 400px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #888;
        }

        /* --- 데이터 테이블 --- */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .data-table th {
            background-color: #f8f9fa;
        }
        .data-table td.number {
            text-align: right;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>유통 흐름 및 의존도 분석</h1>

        <!-- 필터 섹션 -->
        <div class="filter-section">
            <div class="filter-group">
                <label for="product-select">제품:</label>
                <select id="product-select">
                    <option value="vaccine_a">A백신</option>
                    <option value="fever_reducer_c">C해열제</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="start-date">기간:</label>
                <input type="date" id="start-date" value="2025-07-01">
                <span>~</span>
                <input type="date" id="end-date" value="2025-08-20">
            </div>
            <button id="search-btn" class="btn btn-primary">조회</button>
        </div>

        <!-- 컨텐츠 섹션 -->
        <div class="content-section">
            <div class="section-header">
                <h2>유통 흐름 시각화 (Sankey Diagram)</h2>
            </div>
            <div id="sankey-chart">조회 버튼을 눌러주세요.</div>
        </div>

        <div class="content-section">
            <div class="section-header">
                <h2>상세 유통 데이터</h2>
                <button id="download-btn" class="btn btn-secondary">엑셀 다운로드</button>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>출고 업체</th>
                        <th>입고 업체</th>
                        <th class="number">수량</th>
                        <th class="number">점유율</th>
                    </tr>
                </thead>
                <tbody id="distribution-table-body">
                    <!-- JavaScript로 내용이 채워집니다. -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Google Charts 로드
            google.charts.load('current', {'packages':['sankey']});

            // Mock 데이터 (실제로는 API 호출로 가져옴)
            const mockData = {
                "vaccine_a": {
                    nodes: ["A제약 (생산)", "가나다 유통", "라마바 상사", "서울 대형병원", "경기 약국체인", "기타 병원"],
                    links: [
                        { source: "A제약 (생산)", target: "라마바 상사", value: 60000 },
                        { source: "A제약 (생산)", target: "가나다 유통", value: 40000 },
                        { source: "라마바 상사", target: "경기 약국체인", value: 30000 },
                        { source: "라마바 상사", target: "기타 병원", value: 25000 },
                        { source: "가나다 유통", target: "서울 대형병원", value: 38000 }
                    ]
                },
                "fever_reducer_c": {
                    nodes: ["C제약 (생산)", "월드 제약", "튼튼 도매", "전국 약국", "온라인몰"],
                    links: [
                        { source: "C제약 (생산)", target: "월드 제약", value: 120000 },
                        { source: "C제약 (생산)", target: "튼튼 도매", value: 80000 },
                        { source: "월드 제약", target: "전국 약국", value: 90000 },
                        { source: "월드 제약", target: "온라인몰", value: 25000 },
                        { source: "튼튼 도매", target: "전국 약국", value: 70000 }
                    ]
                }
            };

            const searchBtn = document.getElementById('search-btn');
            const downloadBtn = document.getElementById('download-btn');
            const productSelect = document.getElementById('product-select');
            const tableBody = document.getElementById('distribution-table-body');
            const chartDiv = document.getElementById('sankey-chart');

            // Sankey 차트 그리는 함수
            function drawSankeyChart(data) {
                if (!data || data.links.length === 0) {
                    chartDiv.innerHTML = '표시할 데이터가 없습니다.';
                    return;
                }
                
                chartDiv.innerHTML = ''; // 이전 차트 지우기
                const chartData = new google.visualization.DataTable();
                chartData.addColumn('string', 'From');
                chartData.addColumn('string', 'To');
                chartData.addColumn('number', 'Weight');

                const rows = data.links.map(link => [link.source, link.target, link.value]);
                chartData.addRows(rows);

                const options = {
                    width: '100%',
                    height: 400,
                    sankey: {
                        node: {
                            label: { fontName: 'Malgun Gothic', fontSize: 14 }
                        },
                        link: {
                            colorMode: 'gradient',
                            colors: ['#a6cee3', '#b2df8a', '#fb9a99', '#fdbf6f']
                        }
                    }
                };

                const chart = new google.visualization.Sankey(chartDiv);
                chart.draw(chartData, options);
            }

            // 테이블 렌더링 함수
            function renderTable(data) {
                tableBody.innerHTML = '';
                if (!data || data.links.length === 0) {
                    const row = tableBody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 4;
                    cell.textContent = '데이터가 없습니다.';
                    cell.style.textAlign = 'center';
                    return;
                }

                const sourceTotals = {};
                data.links.forEach(link => {
                    sourceTotals[link.source] = (sourceTotals[link.source] || 0) + link.value;
                });

                data.links.forEach(link => {
                    const row = tableBody.insertRow();
                    const share = (link.value / sourceTotals[link.source] * 100).toFixed(1);
                    
                    row.innerHTML = `
                        <td>${link.source}</td>
                        <td>${link.target}</td>
                        <td class="number">${link.value.toLocaleString()}</td>
                        <td class="number">${share}%</td>
                    `;
                });
            }

            // 조회 버튼 이벤트 리스너
            searchBtn.addEventListener('click', () => {
                const selectedProductId = productSelect.value;
                const data = mockData[selectedProductId];
                
                google.charts.setOnLoadCallback(() => drawSankeyChart(data));
                renderTable(data);
            });

            // 엑셀 다운로드 이벤트 리스너
            downloadBtn.addEventListener('click', () => {
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // UTF-8 BOM 추가
                csvContent += "출고 업체,입고 업체,수량,점유율\n";

                const rows = tableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const cols = row.querySelectorAll('td');
                    const rowData = Array.from(cols).map(col => `"${col.innerText.replace(/"/g, '""')}"`);
                    csvContent += rowData.join(',') + '\n';
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "distribution_data.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
        });
    </script>
</body>
</html>
