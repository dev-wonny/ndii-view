<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¢…í•© ìƒí™©íŒ ëŒ€ì‹œë³´ë“œ (DASH-001)</title>
  <style>
    :root{
      --bg:#0a0f1e; --panel:#111a2e; --panel2:#0d1530; --border:#253153; --text:#e7eefc;
      --muted:#9fb0d6; --accent:#5b8cff; --ok:#2ad19b; --warn:#ffb020; --alert:#ff6b6b; --good:#3bc27a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    .wrap{max-width:1400px;margin:0 auto;padding:20px 16px 60px}

    h1{font-size:20px;margin:0 0 12px}
    .sub{color:var(--muted);font-size:13px}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.25)}
    .hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px dashed var(--border)}
    .hdr h2{font-size:16px;margin:0}
    .row{display:grid;gap:16px}
    .cols-2{grid-template-columns:1.2fr .9fr}
    .cols-2b{grid-template-columns:1fr 1fr}

    .filters{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .filters label{font-size:12px;color:var(--muted)}
    .filters input,.filters select{background:#0b1429;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .searchbox{display:flex;gap:8px;align-items:center}
    .searchbox input{min-width:280px}

    .btn{cursor:pointer;border:1px solid var(--border);background:#14213b;color:var(--text);padding:8px 12px;border-radius:10px}
    .btn:hover{background:#1b2a4b}
    .btn.primary{background:var(--accent);border-color:#3b6bff;color:#fff;font-weight:600}
    .btn.ghost{background:transparent}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;padding:12px 16px}
    .kpi{background:#0d1730;border:1px solid var(--border);border-radius:12px;padding:12px;min-height:84px}
    .kpi b{display:block;font-size:20px;margin-top:2px}

    /* Region Risk Map (pseudo) */
    #map{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:14px}
    .cell{border:1px solid var(--border);border-radius:12px;padding:14px;min-height:76px;display:flex;flex-direction:column;gap:6px}
    .badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);background:#0b152b;border-radius:999px;padding:2px 8px;color:#d9e5ff;font-size:12px}
    .sev-ok{background:rgba(58,194,122,.12);border-color:#2a7854;color:#9ee6c1}
    .sev-warn{background:rgba(255,176,32,.12);border-color:#8a6210;color:#ffd28c}
    .sev-alert{background:rgba(255,107,107,.12);border-color:#8f2c2c;color:#ffb3b3}

    /* Alerts */
    #alerts{padding:12px 16px;max-height:360px;overflow:auto}
    .alert{display:flex;gap:10px;align-items:flex-start;border-bottom:1px solid var(--border);padding:10px 0}
    .alert:last-child{border-bottom:0}
    .tag{font-size:12px}
    .time{color:var(--muted);font-size:12px}

    /* Tables */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{color:#b8c7e6;font-weight:600}
    tr:hover td{background:#0e1933}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#0c1630;border:1px solid var(--border);border-radius:999px;padding:3px 8px;color:#cfe2ff;font-size:12px}
    .bar{height:8px;background:#243f75;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:var(--good)}

    .tableWrap{padding:12px 16px;max-height:400px;overflow:auto}

    @media (max-width:1100px){
      .cols-2,.cols-2b{grid-template-columns:1fr}
      .kpis{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ìœ„ê¸°ëŒ€ì‘ ì˜ë£Œì œí’ˆ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ <span class="sub">ì¢…í•© ìƒí™©íŒ ëŒ€ì‹œë³´ë“œ</span></h1>

  <!-- Top bar -->
  <div class="panel">
    <div class="hdr">
      <div class="filters">
        <label>ì œí’ˆ</label>
        <select id="product"></select>
        <label>ê¸°ê°„</label>
        <input type="date" id="from"/>
        <span class="sub">~</span>
        <input type="date" id="to"/>
        <label>ì§€ì—­</label>
        <select id="region">
          <option value="">ì „êµ­</option>
        </select>
      </div>
      <div class="searchbox">
        <input id="q" placeholder="ğŸ” ì œí’ˆ/ì—…ì²´ ê²€ìƒ‰..." />
        <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
        <button class="btn primary" id="btnSearch">ì¡°íšŒ</button>
      </div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 16px">
      <div class="sub">ìµœê·¼ ê°±ì‹ : <span id="lastUpdated">-</span></div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" id="btnExportProducts">ì£¼ìš” ê´€ë¦¬ í’ˆëª© CSV</button>
        <button class="btn ghost" id="btnExportOver">ê³¼ë‹¤ ì¬ê³  TOP5 CSV</button>
      </div>
    </div>
    <div class="kpis" id="kpis">
      <div class="kpi"><span class="sub">ëª¨ë‹ˆí„°ë§ í’ˆëª©</span><b id="kpiItems">-</b></div>
      <div class="kpi"><span class="sub">ê´€ë ¨ ì—…ì²´ ìˆ˜</span><b id="kpiCompanies">-</b></div>
      <div class="kpi"><span class="sub">ğŸš¨ ì¤‘ìš” ê²½ê³ </span><b id="kpiCritical">-</b></div>
      <div class="kpi"><span class="sub">ì „êµ­ í‰ê·  ì¬ê³ ì¼ìˆ˜</span><b id="kpiAvgDsi">-</b></div>
    </div>
  </div>

  <div class="row cols-2" style="margin-top:16px">
    <div class="panel">
      <div class="hdr">
        <h2>ì „êµ­ ì¬ê³  ìœ„í—˜ë„ í˜„í™©</h2>
        <div class="sub">ìƒ‰ìƒ: ì–‘í˜¸/ì£¼ì˜/ìœ„í—˜</div>
      </div>
      <div id="map"></div>
    </div>

    <div class="panel">
      <div class="hdr">
        <h2>ğŸš¨ ìµœì‹  ê²½ê³  ì•Œë¦¼</h2>
        <div class="sub">OPEN ìƒíƒœ ìµœì‹ ìˆœ</div>
      </div>
      <div id="alerts"></div>
    </div>
  </div>

  <div class="row cols-2b" style="margin-top:16px">
    <div class="panel">
      <div class="hdr">
        <h2>ì£¼ìš” ê´€ë¦¬ í’ˆëª© í˜„í™©</h2>
        <div class="sub">ê³µê¸‰ëŸ‰(ì£¼), ì¬ê³ ì¼ìˆ˜, ìƒíƒœ</div>
      </div>
      <div class="tableWrap">
        <table id="tblProducts">
          <thead>
          <tr>
            <th>ì œí’ˆëª…</th>
            <th class="mono">ê³µê¸‰ëŸ‰(ì£¼)</th>
            <th>ì¬ê³  ìˆ˜ì¤€</th>
            <th>ìƒíƒœ</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="panel">
      <div class="hdr">
        <h2>ì¬ê³  ê³¼ë‹¤ ì˜ì‹¬ ì—…ì²´ TOP 5</h2>
        <div class="sub">High DSI & ëŒ€ëŸ‰ ì¬ê³ </div>
      </div>
      <div class="tableWrap">
        <table id="tblOver">
          <thead>
          <tr>
            <th>ì—…ì²´ëª…</th>
            <th>í’ˆëª©ëª…</th>
            <th class="mono">ì¬ê³ ëŸ‰</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="sub" style="margin-top:12px">â€» ë³¸ í™”ë©´ì€ ë°ëª¨ ëª©ì—…ì…ë‹ˆë‹¤. ì‹¤ì œ ì—°ë™ ì‹œ API ì‘ë‹µ í˜•ì‹ì— ë§ì¶° ë§¤í•‘í•˜ì„¸ìš”.</div>
</div>

<script>
const USE_MOCK = true; // ì‹¤ì œ API ì—°ë™ ì‹œ falseë¡œ ì „í™˜
const API = '/api/v1';
const $ = (s,el=document)=>el.querySelector(s);
const $$ = (s,el=document)=>[...el.querySelectorAll(s)];
const fmt = n => n==null?'-':Number(n).toLocaleString('ko-KR');
const nowKR = ()=> new Intl.DateTimeFormat('ko-KR',{dateStyle:'medium', timeStyle:'short'}).format(new Date());
function csvEscape(v){ if(v==null) return ''; const s=String(v); return (/,|"|\n/.test(s))? '"'+s.replace(/"/g,'""')+'"': s; }

// ===== MOCK DATA =====
const MOCK = {
  products:[
    {productId:'P001', productName:'Aë°±ì‹ '},
    {productId:'P002', productName:'Bí•´ì—´ì œ 500mg'},
    {productId:'P003', productName:'Cì£¼ì‚¬ì œ'}
  ],
  regions:['ì„œìš¸','ê²½ê¸°','ì¸ì²œ','ê°•ì›','ì¶©ë¶','ì¶©ë‚¨','ëŒ€ì „','ì„¸ì¢…','ì „ë¶','ì „ë‚¨','ê´‘ì£¼','ê²½ë¶','ê²½ë‚¨','ëŒ€êµ¬','ìš¸ì‚°','ë¶€ì‚°','ì œì£¼'],
  summary:{ items:1234, companies:567, critical:8, avgDsi:45.6 },
  risk:[
    {region:'ì„œìš¸', level:'warn', dsi:28.5},
    {region:'ê²½ê¸°', level:'warn', dsi:26.2},
    {region:'ì¸ì²œ', level:'ok', dsi:18.3},
    {region:'ê°•ì›', level:'ok', dsi:15.2},
    {region:'ì¶©ë¶', level:'alert', dsi:52.1},
    {region:'ì¶©ë‚¨', level:'ok', dsi:20.4},
    {region:'ëŒ€ì „', level:'warn', dsi:29.9},
    {region:'ì„¸ì¢…', level:'ok', dsi:21.2},
    {region:'ì „ë¶', level:'ok', dsi:23.1},
    {region:'ì „ë‚¨', level:'ok', dsi:22.0},
    {region:'ê´‘ì£¼', level:'ok', dsi:19.8},
    {region:'ê²½ë¶', level:'warn', dsi:31.5},
    {region:'ê²½ë‚¨', level:'ok', dsi:24.4},
    {region:'ëŒ€êµ¬', level:'ok', dsi:22.7},
    {region:'ìš¸ì‚°', level:'ok', dsi:21.7},
    {region:'ë¶€ì‚°', level:'ok', dsi:19.9},
    {region:'ì œì£¼', level:'ok', dsi:17.5}
  ],
  alerts:[
    {sev:'ALERT', title:'Aë°±ì‹ , ì„œìš¸ ì§€ì—­ ì¬ê³  ê¸‰ê°', at:'2025-08-21T13:50:00+09:00'},
    {sev:'WARN', title:'Bì œì•½, ì¬ê³  ë¹„ì •ìƒì  ì¦ê°€ ì˜ì‹¬', at:'2025-08-21T12:30:00+09:00'},
    {sev:'WARN', title:'Cí•´ì—´ì œ, ë„ë§¤ìƒ ì¬ê³  ì†Œì§„ ì„ë°•', at:'2025-08-21T11:00:00+09:00'}
  ],
  prodRows:[
    {name:'Aë°±ì‹ ', weekly:100000, stockDays:20, status:'down'},
    {name:'Bí•´ì—´ì œ 500mg', weekly:50000, stockDays:15, status:'down'},
    {name:'Cì£¼ì‚¬ì œ', weekly:80000, stockDays:60, status:'up'}
  ],
  over:[
    {company:'ê°€ë‚˜ë‹¤ ìœ í†µ', product:'Aë°±ì‹ ', qty:50000},
    {company:'ë¼ë§ˆë°” ìƒì‚¬', product:'Dì£¼ì‚¬ì œ', qty:25000},
    {company:'ì„œìš¸ë©”ë””', product:'Bí•´ì—´ì œ 500mg', qty:22000},
    {company:'í•œë¹›ì˜ë£Œ', product:'Cì£¼ì‚¬ì œ', qty:18000},
    {company:'ë°±ë‘ìƒì‚¬', product:'Eì˜ì•½í’ˆ', qty:15000}
  ]
};

async function fetchJSON(url){
  const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();
}

// API shims
async function getProducts(){ if(USE_MOCK) return MOCK.products; const j=await fetchJSON(`${API}/meta/products`); return j.items||[]; }
async function getSummary(params){ if(USE_MOCK) return MOCK.summary; const q=new URLSearchParams(params).toString(); return fetchJSON(`${API}/dashboard/summary?${q}`); }
async function getRegionRisk(params){ if(USE_MOCK) return MOCK.risk; const q=new URLSearchParams(params).toString(); return fetchJSON(`${API}/inventory/region-risk?${q}`); }
async function getAlerts(params){ if(USE_MOCK) return MOCK.alerts; const q=new URLSearchParams(params).toString(); const j=await fetchJSON(`${API}/events?status=OPEN&${q}`); return (j.items||[]).map(x=>({sev:x.severityAfter,title:x.title,at:x.detectedAt})); }
async function getProductRows(params){ if(USE_MOCK) return MOCK.prodRows; /* êµ¬í˜„ë¶€: ì„œë²„ metrics ì¡°í•© */ return []; }
async function getOverstockTop(params){ if(USE_MOCK) return MOCK.over; const q=new URLSearchParams(params).toString(); const j=await fetchJSON(`${API}/analysis/suspected-hoarding?${q}`); return (j.items||[]).map(x=>({company:x.companyName, product:x.productName, qty:x.stockQuantity})); }

// INIT
init();
async function init(){
  // ë‚ ì§œ ê¸°ë³¸ê°’: ìµœê·¼ 30ì¼
  const to = new Date(); const from = new Date(); from.setDate(to.getDate()-30);
  $('#from').value = toISODate(from); $('#to').value = toISODate(to);

  // ì œí’ˆ, ì§€ì—­ ì±„ìš°ê¸°
  const [products] = await Promise.all([getProducts()]);
  const selP = $('#product'); selP.innerHTML='';
  products.forEach(p=>{ const o=document.createElement('option'); o.value=p.productId; o.textContent=p.productName; selP.appendChild(o); });

  const selR = $('#region'); selR.innerHTML='<option value="">ì „êµ­</option>';
  MOCK.regions.forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; selR.appendChild(o); });

  $('#btnSearch').addEventListener('click', load);
  $('#btnReset').addEventListener('click', ()=>{ $('#q').value=''; selR.value=''; if(selP.options.length) selP.selectedIndex=0; init(); });
  $('#btnExportProducts').addEventListener('click', ()=> exportTableCSV('#tblProducts','main_products'));
  $('#btnExportOver').addEventListener('click', ()=> exportTableCSV('#tblOver','overstock_top5'));

  await load();
}

async function load(){
  const params = {
    from: $('#from').value,
    to: $('#to').value,
    productId: $('#product').value,
    region: $('#region').value,
    q: $('#q').value
  };

  const [summary, risk, alerts, prodRows, over] = await Promise.all([
    getSummary(params), getRegionRisk(params), getAlerts(params), getProductRows(params), getOverstockTop(params)
  ]);

  // KPI
  $('#kpiItems').textContent = fmt(summary.items);
  $('#kpiCompanies').textContent = fmt(summary.companies);
  $('#kpiCritical').textContent = fmt(summary.critical);
  $('#kpiAvgDsi').textContent = (summary.avgDsi!=null? Number(summary.avgDsi).toFixed(1)+' ì¼' : '-');
  $('#lastUpdated').textContent = nowKR();

  // Map
  renderMap('#map', risk);

  // Alerts
  renderAlerts('#alerts', alerts);

  // Tables
  renderProducts('#tblProducts tbody', prodRows);
  renderOver('#tblOver tbody', over);
}

// RENDERERS
function renderMap(sel, rows){
  const el=$(sel); el.innerHTML='';
  rows.forEach(r=>{
    const cell=document.createElement('div'); cell.className='cell';
    const badge=document.createElement('span'); badge.className='badge '+sevCls(r.level); badge.textContent=sevLabel(r.level);
    cell.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;gap:6px">
        <b>${r.region}</b> <span class="chip">DSI ${Number(r.dsi).toFixed(1)}ì¼</span>
      </div>`;
    cell.prepend(badge);
    el.appendChild(cell);
  });
}
function sevCls(level){ return level==='alert'?'sev-alert': level==='warn'?'sev-warn':'sev-ok'; }
function sevLabel(level){ return level==='alert'?'ìœ„í—˜': level==='warn'?'ì£¼ì˜':'ì–‘í˜¸'; }

function renderAlerts(sel, items){
  const el=$(sel); el.innerHTML='';
  items.forEach(a=>{
    const div=document.createElement('div'); div.className='alert';
    const tag=document.createElement('span'); tag.className='badge '+(a.sev==='ALERT'?'sev-alert':'sev-warn'); tag.textContent=a.sev;
    div.appendChild(tag);
    const box=document.createElement('div');
    const t=document.createElement('div'); t.textContent=a.title;
    const time=document.createElement('div'); time.className='time'; time.textContent=new Date(a.at).toLocaleString('ko-KR');
    box.appendChild(t); box.appendChild(time); div.appendChild(box);
    el.appendChild(div);
  });
}

function renderProducts(sel, rows){
  const tb=$(sel); tb.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    const arrow = r.status==='up'?'ğŸ”¼':'ğŸ”»';
    tr.innerHTML = `
      <td>${r.name}</td>
      <td class="mono">${fmt(r.weekly)}</td>
      <td>${r.stockDays}ì¼</td>
      <td>${arrow}</td>`;
    tb.appendChild(tr);
  });
}

function renderOver(sel, rows){
  const tb=$(sel); tb.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${r.company}</td>
      <td>${r.product}</td>
      <td class="mono">${fmt(r.qty)}</td>`;
    tb.appendChild(tr);
  });
}

// UTIL
function exportTableCSV(sel, name){
  const rows=[[...$(`${sel} thead tr`).children].map(th=>th.innerText.trim())];
  $$("tbody tr", $(sel)).forEach(tr=>{
    rows.push([...tr.children].map(td=>csvEscape(td.innerText.trim())));
  });
  const csv=rows.map(r=>r.join(',')).join('\n');
  const blob=new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${name}_${toISODate(new Date())}.csv`; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
function toISODate(d){ return (d instanceof Date? d : new Date(d)).toISOString().slice(0,10); }
</script>
</body>
</html>
